#nullable enable // autogenerated

using System.Collections.Generic;
using MVZ2.GameContent.Buffs;
using MVZ2.GameContent.Buffs.Level;
using MVZ2.Vanilla.Entities;
using MVZ2.Vanilla.Properties;
using MVZ2Logic.Level;
using PVZEngine;
using PVZEngine.Auras;
using PVZEngine.Buffs;
using PVZEngine.Entities;
using PVZEngine.Level;
using PVZEngine.Modifiers;
using UnityEngine;

namespace MVZ2.GameContent.Effects
{
    [EntityBehaviourDefinition(VanillaEffectNames.spiritUniverse)]
    public class SpiritUniverse : EffectBehaviour
    {
        #region 公有方法
        public SpiritUniverse(string nsp, string name) : base(nsp, name)
        {
            AddModifier(ColorModifier.Multiply(EngineEntityProps.TINT, PROP_TINT_MULTIPLIER));
            AddAura(new NightAura());
        }
        #endregion

        public override void Update(Entity entity)
        {
            base.Update(entity);
            var tint = entity.GetProperty<Color>(PROP_TINT_MULTIPLIER);
            var speed = 1 / 90f;
            if ((entity.Timeout > 0 && entity.Timeout <= 30) || (entity.Level.IsGameOver() || !entity.Level.IsGameStarted()))
            {
                speed = -1 / 30f;
            }
            tint.a = Mathf.Clamp01(tint.a + speed);
            entity.SetProperty(PROP_TINT_MULTIPLIER, tint);
        }
        public static readonly PropertyMeta<Color> PROP_TINT_MULTIPLIER = new VanillaEntityPropertyMeta<Color>("tint_multiplier", new Color(1, 1, 1, 0));
        public class NightAura : AuraEffectDefinition
        {
            public NightAura() : base(VanillaBuffID.Level.spiritUniverseNight)
            {
            }

            public override void GetAuraTargets(AuraEffect auraEffect, List<IBuffTarget> results)
            {
                results.Add(auraEffect.Level);
            }

            public override void UpdateTargetBuff(AuraEffect effect, IBuffTarget target, Buff buff)
            {
                base.UpdateTargetBuff(effect, target, buff);
                var entity = effect?.Source?.GetEntity();
                if (!entity.ExistsAndAlive())
                    return;
                var alpha = entity.GetTint().a;
                var color = Color.Lerp(Color.white, Color.black, alpha);
                SpiritUniverseNightBuff.SetBackgroundLightMultiplier(buff, color);
            }
        }
    }
}