#nullable enable // autogenerated

using System.Collections.Generic;
using MVZ2.GameContent.Buffs;
using MVZ2.GameContent.Buffs.Level;
using MVZ2.Vanilla.Entities;
using MVZ2.Vanilla.Properties;
using MVZ2Logic.Level;
using PVZEngine;
using PVZEngine.Auras;
using PVZEngine.Buffs;
using PVZEngine.Entities;
using PVZEngine.Level;
using PVZEngine.Modifiers;
using UnityEngine;

namespace MVZ2.GameContent.Effects
{
    [EntityBehaviourDefinition(VanillaEntityBehaviourNames.skyBackground)]
    public class SkyBackground : EntityBehaviourDefinition
    {
        #region 公有方法
        public SkyBackground(string nsp, string name) : base(nsp, name)
        {
            AddModifier(ColorModifier.Multiply(EngineEntityProps.TINT, PROP_TINT_MULTIPLIER));
            AddAura(new NightAura());
        }
        #endregion

        public override void Update(Entity entity)
        {
            base.Update(entity);
            bool disappearing = (entity.Timeout >= 0 && entity.Timeout < 30) || entity.Level.IsGameOver() || !entity.Level.IsGameStarted();
            var propertyKey = disappearing ? PROP_FADE_OUT_SPEED : PROP_FADE_IN_SPEED;
            var speedPerSecond = entity.GetProperty<float>(propertyKey);
            var speed = Ticks.FromPerSecond(speedPerSecond);

            var tintMulti = GetTintMultiplier(entity);
            tintMulti.a = Mathf.Clamp01(tintMulti.a + speed);
            SetTintMultiplier(entity, tintMulti);
        }
        public static Color GetTintMultiplier(Entity entity) => entity.GetProperty<Color>(PROP_TINT_MULTIPLIER);
        public static void SetTintMultiplier(Entity entity, Color color) => entity.SetProperty(PROP_TINT_MULTIPLIER, color);

        public static readonly PropertyMeta<Color> PROP_TINT_MULTIPLIER = new VanillaEntityPropertyMeta<Color>("tint_multiplier", new Color(1, 1, 1, 0));
        public static readonly PropertyMeta<float> PROP_FADE_IN_SPEED = new VanillaEntityPropertyMeta<float>("fade_in_speed", 1f);
        public static readonly PropertyMeta<float> PROP_FADE_OUT_SPEED = new VanillaEntityPropertyMeta<float>("fade_out_speed", -1f);
        public class NightAura : AuraEffectDefinition
        {
            public NightAura() : base(VanillaBuffID.Level.spiritUniverseNight)
            {
            }

            public override void GetAuraTargets(AuraEffect auraEffect, List<IBuffTarget> results)
            {
                results.Add(auraEffect.Level);
            }

            public override void UpdateTargetBuff(AuraEffect effect, IBuffTarget target, Buff buff)
            {
                base.UpdateTargetBuff(effect, target, buff);
                var entity = effect?.Source?.GetEntity();
                if (!entity.ExistsAndAlive())
                    return;
                var alpha = entity.GetTint().a;
                var color = Color.Lerp(Color.white, Color.black, alpha);
                SpiritUniverseNightBuff.SetBackgroundLightMultiplier(buff, color);
            }
        }
    }
}