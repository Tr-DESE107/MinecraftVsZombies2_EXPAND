#nullable enable // autogenerated

using MVZ2.GameContent.Contraptions;
using MVZ2.Vanilla.Entities;
using MVZ2.Vanilla.Grids;
using MVZ2.Vanilla.Modifiers;
using MVZ2.Vanilla.Properties;
using PVZEngine.Entities;
using PVZEngine.Level;
using PVZEngine.Modifiers;
using UnityEngine;

namespace MVZ2.GameContent.Effects
{
    [EntityBehaviourDefinition(VanillaEffectNames.dragonFireBreath)]
    public class DragonFireBreath : EntityBehaviourDefinition, IBeBlownBehaviour
    {
        public DragonFireBreath(string nsp, string name) : base(nsp, name)
        {
            AddModifier(ColorModifier.Override(VanillaEntityProps.LIGHT_COLOR, PROP_LIGHT_COLOR, VanillaModifierPriorities.EARLY));
        }
        public override void Init(Entity entity)
        {
            base.Init(entity);
            UpdateVariant(entity);
        }
        public override void Update(Entity entity)
        {
            base.Update(entity);
            UpdateVariant(entity);
            UpdateGridFire(entity);
        }
        public static Color GetLightColorByVariant(int variant)
        {
            switch (variant)
            {
                case VARIANT_RED:
                    return Color.red;
                case VARIANT_CYAN:
                    return Color.cyan;
            }
            return defaultLightColor;
        }
        public static void UpdateVariant(Entity entity)
        {
            var variant = entity.GetVariant();
            var lightColor = GetLightColorByVariant(variant);
            entity.SetProperty(PROP_LIGHT_COLOR, lightColor);
            entity.SetModelProperty("Variant", variant);
        }
        private void UpdateGridFire(Entity entity)
        {
            if (entity.GetRelativeY() > 20) // 距离地面过高
                return;
            var grid = entity.GetGrid();
            if (grid == null)
                return;
            var param = entity.GetSpawnParams();
            param.SetProperty(VanillaEntityProps.DAMAGE, entity.GetDamage());
            GridFire.Spawn(grid, entity, param);
        }
        public void BeBlown(Entity entity, Entity source)
        {
            var newVelocity = source.IsFacingLeft() ? Vector3.left : Vector3.right;
            newVelocity *= entity.Velocity.magnitude;
            entity.Velocity = newVelocity;
        }
        private static readonly VanillaEntityPropertyMeta<Color> PROP_LIGHT_COLOR = new VanillaEntityPropertyMeta<Color>("light_color", defaultLightColor);
        public const int VARIANT_ORANGE = 0;
        public const int VARIANT_RED = 1;
        public const int VARIANT_CYAN = 2;
        public static readonly Color defaultLightColor = new Color(1, 0.5f, 0);
    }
}