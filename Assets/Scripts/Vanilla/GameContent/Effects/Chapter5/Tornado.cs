#nullable enable // autogenerated

using MVZ2.GameContent.Buffs.Contraptions;
using MVZ2.GameContent.Contraptions;
using MVZ2.Vanilla.Audios;
using MVZ2.Vanilla.Entities;
using MVZ2.Vanilla.Properties;
using MVZ2Logic.Level;
using PVZEngine.Buffs;
using PVZEngine.Entities;
using PVZEngine.Level;
using PVZEngine.Modifiers;
using UnityEngine;

namespace MVZ2.GameContent.Effects
{
    [EntityBehaviourDefinition(VanillaEffectNames.tornado)]
    public class Tornado : EntityBehaviourDefinition, IBeBlownBehaviour
    {
        public Tornado(string nsp, string name) : base(nsp, name)
        {
            AddModifier(new BooleanModifier(VanillaEntityProps.IS_LIGHT_SOURCE, PROP_IS_LIGHT_SOURCE));
        }
        public override void Init(Entity entity)
        {
            base.Init(entity);
            entity.Level.AddLoopSoundEntity(VanillaSoundID.tornado, entity.ID);
            var mask = EntityCollisionHelper.MASK_PLANT | EntityCollisionHelper.MASK_ENEMY | EntityCollisionHelper.MASK_EFFECT;
            entity.CollisionMaskHostile |= mask;
            entity.CollisionMaskFriendly |= mask;
            UpdateVariant(entity);
        }
        public override void Update(Entity entity)
        {
            base.Update(entity);
            UpdateVariant(entity);
            if (entity.GetVariant() == VARIANT_FIRE)
            {
                var grid = entity.GetGrid();
                if (grid != null)
                {
                    var param = entity.GetSpawnParams();
                    GridFire.Spawn(grid, entity, param);
                }
            }
        }

        private void UpdateVariant(Entity entity)
        {
            var variant = entity.GetVariant();
            entity.SetProperty(PROP_IS_LIGHT_SOURCE, variant == VARIANT_FIRE);
            entity.SetModelProperty("Variant", variant);
        }
        public override void PostCollision(EntityCollision collision, int state)
        {
            base.PostCollision(collision, state);
            if (state == EntityCollisionHelper.STATE_EXIT)
                return;
            var other = collision.Other;
            var self = collision.Entity;
            if (other.IsVulnerableEntity())
            {
                other.Velocity += Vector3.up * 1.5f;
                if (!other.HasBuff<ClearGridOnLandBuff>())
                {
                    other.AddBuff<ClearGridOnLandBuff>();
                }
            }
            else if (self.GetVariant() == VARIANT_NORMAL && other.IsEntityOf(VanillaEffectID.dragonFireBreath))
            {
                self.SetVariant(VARIANT_FIRE);
            }
        }
        public void BeBlown(Entity entity, Entity source)
        {
            var newVelocity = source.IsFacingLeft() ? Vector3.left : Vector3.right;
            newVelocity *= entity.Velocity.magnitude;
            entity.Velocity = newVelocity;
        }
        public const int VARIANT_NORMAL = 0;
        public const int VARIANT_FIRE = 1;
        public static readonly VanillaEntityPropertyMeta<bool> PROP_IS_LIGHT_SOURCE = new VanillaEntityPropertyMeta<bool>("is_light_source");
    }
}