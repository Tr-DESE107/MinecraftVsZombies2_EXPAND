#nullable enable // autogenerated

using System.Collections.Generic;
using MVZ2.GameContent.Damages;
using MVZ2.GameContent.Detections;
using MVZ2.GameContent.Effects;
using MVZ2.Vanilla.Audios;
using MVZ2.Vanilla.Bosses;
using MVZ2.Vanilla.Entities;
using MVZ2.Vanilla.Properties;
using MVZ2Logic.Level;
using PVZEngine;
using PVZEngine.Callbacks;
using PVZEngine.Damages;
using PVZEngine.Entities;
using PVZEngine.Level;
using PVZEngine.Modifiers;
using UnityEngine;

namespace MVZ2.GameContent.Bosses
{
    [EntityBehaviourDefinition(VanillaBossNames.redDragon)]
    public partial class RedDragon : BossBehaviour
    {
        public RedDragon(string nsp, string name) : base(nsp, name)
        {
            AddModifier(ColorModifier.Multiply(EngineEntityProps.TINT, PROP_TINT_MULTIPLIER));
            AddModifier(new FloatModifier(EngineEntityProps.GRAVITY, NumberOperator.Multiply, PROP_GRAVITY_MULTIPLIER));
        }

        #region 回调
        public override void Init(Entity boss)
        {
            base.Init(boss);
            stateMachine.Init(boss);
            stateMachine.StartState(boss, STATE_IDLE);
        }
        protected override void UpdateAI(Entity entity)
        {
            base.UpdateAI(entity);
            stateMachine.UpdateAI(entity);
        }
        protected override void UpdateLogic(Entity entity)
        {
            base.UpdateLogic(entity);
            stateMachine.UpdateLogic(entity);

            entity.SetAnimationFloat("HeadRotation", GetHeadRotation(entity));
            entity.SetAnimationFloat("Rotation", GetRotation(entity));
            entity.SetModelProperty("FireInMouth", GetFireInMouth(entity));
            entity.SetModelProperty("FireVariant", GetFireVariant(entity));
        }
        #endregion 事件

        public static Vector3 GetNeckDirection(Entity entity)
        {
            var headRotation = GetHeadRotation(entity);
            var neckDirection = Quaternion.Euler(0, headRotation, 0) * Vector3.right;
            neckDirection.x *= entity.GetFacingX();
            return neckDirection;
        }
        public static Vector3 GetSpitSourcePosition(Entity entity)
        {
            var neckDirection = GetNeckDirection(entity);
            return GetNeckRootPosition(entity) + neckDirection * NECK_LENGTH;
        }
        public static Vector3 GetNeckRootPosition(Entity entity)
        {
            return entity.Position + entity.GetFacingDirection() * 140 + Vector3.up * 40;
        }
        public static Vector3 GetTornadoSourcePosition(Entity entity)
        {
            return entity.Position + entity.GetFacingDirection() * 240;
        }
        public static int GetFireVariant(Entity entity)
        {
            var eatenFlags = GetEatenFlags(entity);
            if ((eatenFlags & EATEN_FLAG_CORPSE) != 0)
                return DragonFireBreath.VARIANT_CYAN;
            if ((eatenFlags & EATEN_FLAG_CHARCOAL) != 0)
                return DragonFireBreath.VARIANT_RED;
            return DragonFireBreath.VARIANT_ORANGE;
        }
        private static void LandCrush(Entity entity)
        {
            var level = entity.Level;
            landBuffer.Clear();
            landDetector.DetectMultiple(entity, landBuffer);
            foreach (IEntityCollider collider in landBuffer)
            {
                var ent = collider.Entity;
                var damageOutput = collider.TakeDamage(ent.GetTakenCrushDamage(), new DamageEffectList(VanillaDamageEffects.IMPACT, VanillaDamageEffects.IGNORE_ARMOR), entity);
                if (ent.Type == EntityTypes.PLANT)
                {
                    if (damageOutput?.BodyResult?.Fatal ?? false)
                    {
                        entity.PlaySound(VanillaSoundID.smash);
                    }
                }
            }
        }

        #region 字段
        public static bool GetFireInMouth(Entity entity) => entity.GetBehaviourField<bool>(PROP_FIRE_IN_MOUTH);
        public static void SetFireInMouth(Entity entity, bool value) => entity.SetBehaviourField(PROP_FIRE_IN_MOUTH, value);
        public static float GetHeadRotation(Entity entity) => entity.GetBehaviourField<float>(PROP_HEAD_ROTATION);
        public static void SetHeadRotation(Entity entity, float value) => entity.SetBehaviourField(PROP_HEAD_ROTATION, value);
        public static float GetRotation(Entity entity) => entity.GetBehaviourField<float>(PROP_ROTATION);
        public static void SetRotation(Entity entity, float value) => entity.SetBehaviourField(PROP_ROTATION, value);
        public static float GetGravityMultiplier(Entity entity) => entity.GetBehaviourField<float>(PROP_GRAVITY_MULTIPLIER);
        public static void SetGravityMultiplier(Entity entity, float value) => entity.SetBehaviourField(PROP_GRAVITY_MULTIPLIER, value);
        public static int GetPhase(Entity entity) => entity.GetBehaviourField<int>(PROP_PHASE);
        public static void SetPhase(Entity entity, int value) => entity.SetBehaviourField(PROP_PHASE, value);
        public static int GetEatenFlags(Entity entity) => entity.GetBehaviourField<int>(PROP_EATEN_FLAGS);
        public static void SetEatenFlags(Entity entity, int value) => entity.SetBehaviourField(PROP_EATEN_FLAGS, value);
        public static Vector3 GetJumpTarget(Entity entity) => entity.GetBehaviourField<Vector3>(PROP_JUMP_TARGET);
        public static void SetJumpTarget(Entity entity, Vector3 value) => entity.SetBehaviourField(PROP_JUMP_TARGET, value);
        public static Color GetTintMultiplier(Entity entity) => entity.GetBehaviourField<Color>(PROP_TINT_MULTIPLIER);
        public static void SetTintMultiplier(Entity entity, Color value) => entity.SetBehaviourField(PROP_TINT_MULTIPLIER, value);
        public static int GetJumpFinishState(Entity entity) => entity.GetBehaviourField<int>(PROP_JUMP_FINISH_STATE);
        public static void SetJumpFinishState(Entity entity, int value) => entity.SetBehaviourField(PROP_JUMP_FINISH_STATE, value);
        public static List<NamespaceID>? GetEatenEntities(Entity entity) => entity.GetBehaviourField<List<NamespaceID>>(PROP_EATEN_ENTITIES);
        public static void SetEatenEntities(Entity entity, List<NamespaceID>? value) => entity.SetBehaviourField(PROP_EATEN_ENTITIES, value);
        #endregion

        #region 常量
        private static readonly VanillaEntityPropertyMeta<bool> PROP_FIRE_IN_MOUTH = new VanillaEntityPropertyMeta<bool>("fire_in_mouth");
        private static readonly VanillaEntityPropertyMeta<int> PROP_PHASE = new VanillaEntityPropertyMeta<int>("phase");
        private static readonly VanillaEntityPropertyMeta<int> PROP_EATEN_FLAGS = new VanillaEntityPropertyMeta<int>("eaten_flags");
        private static readonly VanillaEntityPropertyMeta<int> PROP_JUMP_FINISH_STATE = new VanillaEntityPropertyMeta<int>("jump_finish_state", -1);
        private static readonly VanillaEntityPropertyMeta<float> PROP_HEAD_ROTATION = new VanillaEntityPropertyMeta<float>("head_rotation");
        private static readonly VanillaEntityPropertyMeta<float> PROP_ROTATION = new VanillaEntityPropertyMeta<float>("rotation");
        private static readonly VanillaEntityPropertyMeta<float> PROP_GRAVITY_MULTIPLIER = new VanillaEntityPropertyMeta<float>("gravity_multiplier");
        private static readonly VanillaEntityPropertyMeta<Vector3> PROP_JUMP_TARGET = new VanillaEntityPropertyMeta<Vector3>("jump_target");
        private static readonly VanillaEntityPropertyMeta<Color> PROP_TINT_MULTIPLIER = new VanillaEntityPropertyMeta<Color>("tint_multiplier", Color.white);
        private static readonly VanillaEntityPropertyMeta<List<NamespaceID>> PROP_EATEN_ENTITIES = new VanillaEntityPropertyMeta<List<NamespaceID>>("eaten_entities");

        private static CollisionDetector landDetector = new CollisionDetector();
        private static List<IEntityCollider> landBuffer = new List<IEntityCollider>();

        public const int STATE_IDLE = VanillaBossStates.IDLE;
        public const int STATE_APPEAR = VanillaBossStates.APPEAR;
        public const int STATE_STUNNED = VanillaBossStates.STUNNED;
        public const int STATE_DEATH = VanillaBossStates.DEATH;
        public const int STATE_SPIT = VanillaBossStates.RED_DRAGON_SPIT;
        public const int STATE_JUMP = VanillaBossStates.RED_DRAGON_JUMP;
        public const int STATE_FLAP_WINGS = VanillaBossStates.RED_DRAGON_FLAP_WINGS;
        public const int STATE_EAT = VanillaBossStates.RED_DRAGON_EAT;
        public const int STATE_FIRE_BREATH = VanillaBossStates.RED_DRAGON_FIRE_BREATH;
        public const int STATE_ROAR = VanillaBossStates.RED_DRAGON_ROAR;
        public const int STATE_LARGE_FIREBALL = VanillaBossStates.RED_DRAGON_LARGE_FIREBALL;
        public const int STATE_SPIT_UP = VanillaBossStates.RED_DRAGON_SPIT_UP;
        public const int STATE_FLY = VanillaBossStates.RED_DRAGON_FLY;
        public const int STATE_TAIL_SWIPE = VanillaBossStates.RED_DRAGON_TAIL_SWIPE;

        public const int ANIMATION_STATE_IDLE = 0;
        public const int ANIMATION_STATE_APPEAR = 1;
        public const int ANIMATION_STATE_STUNNED = 2;
        public const int ANIMATION_STATE_DEATH = 3;
        public const int ANIMATION_STATE_SPIT = 10000;
        public const int ANIMATION_STATE_JUMP = 10001;
        public const int ANIMATION_STATE_FLAP_WINGS = 10002;
        public const int ANIMATION_STATE_EAT = 10003;
        public const int ANIMATION_STATE_SPIT_UP = 10004;
        public const int ANIMATION_STATE_FLY = 10005;
        public const int ANIMATION_STATE_TAIL_SWIPE = 10006;

        public const int PHASE_1 = 0;
        public const int PHASE_2 = 1;

        public const float NECK_LENGTH = 260;

        public const float APPEAR_START_X = -1000;
        public const float APPEAR_START_Y = 160;

        public const float EAT_HEAL_PER_ENTITY = 100;
        public const float EAT_HITBOX_WIDTH = 64;
        public const float EAT_HITBOX_HEIGHT = 64;
        public const float EAT_HITBOX_Z_LENGTH = 64;
        public const float EAT_HITBOX_RANGE = 200;
        public const float EAT_HITBOX_DISTANCE_X = 320;
        public const float BITE_DAMAGE_MULTIPLIER = 3;

        public const float ROAR_SECONDS = 2f;

        public const float SELF_EXPLODE_STUN_SECONDS = 2f;

        public const float FIRE_BREATH_DAMAGE_MULTIPLIER = 0.01f;
        public const float FIRE_BREATH_SPEED = 20f;

        public const float METEOR_DAMAGE_MULTIPLIER = 3f;
        public const int METEOR_COUNT = 3;
        public static readonly Vector3 METEOR_HSV_OFFSET = new Vector3(-30f, 0, 0);

        public const float FIRE_EXPLOSION_DAMAGE_MULTIPLIER = 3;

        public const int TAIL_SWIPE_COLUMN_RANGE = 6;
        public const int TAIL_SWIPE_LANE_RANGE_START = -2;
        public const int TAIL_SWIPE_LANE_RANGE_END = 2;

        public const int EATEN_FLAG_CORPSE = 1;
        public const int EATEN_FLAG_CHARCOAL = 1 << 1;
        public const int EATEN_FLAG_DYNAMITE = 1 << 2;

        #endregion 常量
    }
}
