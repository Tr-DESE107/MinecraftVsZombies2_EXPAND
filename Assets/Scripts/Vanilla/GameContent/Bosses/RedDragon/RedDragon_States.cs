#nullable enable // autogenerated

using System.Collections.Generic;
using System.Linq;
using MVZ2.GameContent.Areas;
using MVZ2.GameContent.Buffs;
using MVZ2.GameContent.Buffs.Level;
using MVZ2.GameContent.Damages;
using MVZ2.GameContent.Detections;
using MVZ2.GameContent.Difficulties;
using MVZ2.GameContent.Effects;
using MVZ2.GameContent.Projectiles;
using MVZ2.GameContent.Shells;
using MVZ2.Vanilla.Audios;
using MVZ2.Vanilla.Bosses;
using MVZ2.Vanilla.Entities;
using MVZ2.Vanilla.Level;
using MVZ2Logic.Level;
using PVZEngine;
using PVZEngine.Buffs;
using PVZEngine.Damages;
using PVZEngine.Entities;
using PVZEngine.Level;
using Tools;
using UnityEngine;

namespace MVZ2.GameContent.Bosses
{
    public partial class RedDragon
    {
        #region 状态机
        private class RedDragonStateMachine : EntityStateMachine
        {
            public RedDragonStateMachine()
            {
                AddState(new IdleState());
                AddState(new AppearState());
                AddState(new StunnedState());
                AddState(new DeathState());
                AddState(new DeathRoarState());
                AddState(new DeathFlyState());
                AddState(new JumpState());
                AddState(new SpitState());
                AddState(new FlapWingsState());
                AddState(new EatState());
                AddState(new FireBreathState());
                AddState(new RoarState());
                AddState(new LargeFireballState());
                AddState(new SpitUpState());
                AddState(new FlyState());
                AddState(new TailSwipeState());
            }
        }
        #endregion

        private static void CheckDeath(Entity entity)
        {
            if (!entity.IsDead)
                return;
            stateMachine.StartState(entity, STATE_DEATH);
        }
        private static bool HasEnemiesInTheLane(Entity entity)
        {
            var lane = entity.GetLane();
            return entity.Level.EntityExists(e => e.GetLane() == lane && entity.IsHostile(e) && e.IsVulnerableEntity());
        }
        private static void Roar(Entity entity)
        {
            var param = entity.GetSpawnParams();
            var position = GetSpitSourcePosition(entity);
            entity.Spawn(VanillaEffectID.amplifiedRoar, position, param);
            var time = Ticks.FromSeconds(ROAR_SECONDS);
            entity.Level.ShakeScreen(15, 0, time);
            entity.BossRoar(time);
            entity.PlaySound(VanillaSoundID.dragonGrowl);
        }

        #region 飞行
        private class AppearState : EntityStateMachineState
        {
            public AppearState() : base(STATE_APPEAR, ANIMATION_STATE_FLY) { }
            public override int GetAnimationSubstate(int substate)
            {
                switch (substate)
                {
                    case SUBSTATE_FLY:
                        return ANIMATION_SUBSTATE_FLY;
                    case SUBSTATE_GLIDE:
                        return ANIMATION_SUBSTATE_GLIDE;
                    case SUBSTATE_LAND:
                        return ANIMATION_SUBSTATE_LAND;
                }
                return base.GetAnimationSubstate(substate);
            }
            public override void OnEnter(EntityStateMachine stateMachine, Entity entity)
            {
                base.OnEnter(stateMachine, entity);
                var substateTimer = stateMachine.GetSubStateTimer(entity);
                substateTimer.ResetSeconds(2f);

                SetRotation(entity, 180);
                var targetLane = entity.Level.GetMaxLaneCount() / 2;
                var position = entity.Position;
                position.x = APPEAR_START_X;
                position.y = APPEAR_START_Y;
                position.z = entity.Level.GetEntityLaneZ(targetLane);
                entity.Position = position;
                SetGravityMultiplier(entity, 0);

                SetInvincible(entity, true);
            }
            public override void OnExit(EntityStateMachine machine, Entity entity)
            {
                base.OnExit(machine, entity);
                SetRotation(entity, 0);
                SetGravityMultiplier(entity, 1);
            }
            public override void OnUpdateAI(EntityStateMachine stateMachine, Entity entity)
            {
                base.OnUpdateAI(stateMachine, entity);
                var substate = stateMachine.GetSubState(entity);
                var timer = stateMachine.GetSubStateTimer(entity);
                timer.Run(stateMachine.GetSpeed(entity));
                switch (substate)
                {
                    case SUBSTATE_FLY:
                        {
                            entity.Velocity = entity.GetFacingDirection() * -FLY_SPEED; // 向右飞，但是仍面朝左侧，只是模型旋转了180度。
                            if (timer.PassedIntervalSeconds(0.5f))
                            {
                                entity.PlaySound(VanillaSoundID.dragonWings);
                            }
                            if (timer.Expired)
                            {
                                stateMachine.StartSubState(entity, SUBSTATE_GLIDE);
                                timer.ResetSeconds(1f);
                                entity.PlaySound(VanillaSoundID.dragonGrowl);
                                SetRotation(entity, 0);
                            }
                        }
                        break;
                    case SUBSTATE_GLIDE:
                        var middleLane = entity.Level.GetMaxLaneCount() / 2;
                        var targetPosition = GetJumpBorderPositionByLane(entity, middleLane);
                        entity.Velocity = (targetPosition - entity.Position).normalized * FLY_SPEED;
                        if (entity.IsOnGround)
                        {
                            entity.Level.ShakeScreen(20, 0, 30);
                            entity.PlaySound(VanillaSoundID.thump);
                            stateMachine.StartSubState(entity, SUBSTATE_LAND);
                            timer.ResetSeconds(1f);
                        }
                        break;
                    case SUBSTATE_LAND:
                        {
                            var position = entity.Position;
                            position.x = Ticks.SmoothDamp(position.x, GetJumpBorderX(entity), 0.2f);
                            entity.Position = position;
                            entity.Velocity = Ticks.SmoothDamp(entity.Velocity, Vector3.zero, 0.2f);

                            LandCrush(entity);

                            if (timer.Expired)
                            {
                                stateMachine.StartState(entity, STATE_ROAR);
                                stateMachine.StartSubState(entity, RoarState.ANIMATION_SUBSTATE_APPEAR_START);
                            }
                        }
                        break;
                }
            }
            public override void OnUpdateLogic(EntityStateMachine machine, Entity entity)
            {
                base.OnUpdateLogic(machine, entity);
                CheckDeath(entity);
            }
            public const int SUBSTATE_FLY = 0;
            public const int SUBSTATE_GLIDE = 1;
            public const int SUBSTATE_LAND = 2;
            public const int ANIMATION_SUBSTATE_FLY = 1;
            public const int ANIMATION_SUBSTATE_GLIDE = 2;
            public const int ANIMATION_SUBSTATE_LAND = 3;
        }
        #endregion

        #region 待命
        private static bool CanSwitchStatePhase1(Entity entity, int state)
        {
            switch (state)
            {
                case STATE_SPIT:
                case STATE_FLAP_WINGS:
                    if (!entity.Level.EntityExists(e => entity.IsHostile(e) && e.IsVulnerableEntity()))
                        return false;
                    break;
            }
            return true;
        }
        private static bool CanSwitchStatePhase2(Entity entity, int state)
        {
            switch (state)
            {
                case STATE_LARGE_FIREBALL:
                case STATE_FLAP_WINGS:
                case STATE_FLY:
                    if (!entity.Level.EntityExists(e => entity.IsHostile(e) && e.IsVulnerableEntity()))
                        return false;
                    break;
            }
            return true;
        }
        private static void SwitchState(Entity entity, int state)
        {
            switch (state)
            {
                case STATE_SPIT:
                case STATE_FLAP_WINGS:
                case STATE_LARGE_FIREBALL:
                    if (HasEnemiesInTheLane(entity))
                    {
                        stateMachine.StartState(entity, state);
                    }
                    else
                    {
                        var jumpTarget = FindEnemyJumpTargetPosition(entity);
                        JumpTo(entity, jumpTarget, state);
                    }
                    break;
                case STATE_EAT:
                    {
                        var middleLane = entity.Level.GetMaxLaneCount() / 2;
                        // 没有可吃的目标，直接喷火。
                        if (!HasEatableTargets(entity))
                        {
                            state = STATE_FIRE_BREATH;
                        }
                        if (entity.GetLane() == middleLane)
                        {
                            stateMachine.StartState(entity, state);
                        }
                        else
                        {
                            var jumpTarget = GetJumpBorderPositionByLane(entity, middleLane);
                            JumpTo(entity, jumpTarget, state);
                        }
                    }
                    break;
                case STATE_JUMP:
                    {
                        var jumpTarget = FindRandomJumpTargetPosition(entity);
                        JumpTo(entity, jumpTarget, STATE_IDLE);
                    }
                    break;
                case STATE_SPIT_UP:
                    {
                        var middleLane = entity.Level.GetMaxLaneCount() / 2;
                        if (entity.GetLane() == middleLane)
                        {
                            stateMachine.StartState(entity, state);
                        }
                        else
                        {
                            var jumpTarget = GetJumpBorderPositionByLane(entity, middleLane);
                            JumpTo(entity, jumpTarget, state);
                        }
                    }
                    break;
                case STATE_FLY:
                    {
                        stateMachine.StartState(entity, state);
                    }
                    break;
            }
        }
        private class IdleState : EntityStateMachineState
        {
            public IdleState() : base(STATE_IDLE, ANIMATION_STATE_IDLE) { }
            public override void OnEnter(EntityStateMachine stateMachine, Entity entity)
            {
                base.OnEnter(stateMachine, entity);
                var stateTimer = stateMachine.GetStateTimer(entity);
                stateTimer.ResetSeconds(2f);
                SetInvincible(entity, false);
            }
            public override void OnUpdateAI(EntityStateMachine stateMachine, Entity entity)
            {
                base.OnUpdateAI(stateMachine, entity);
                UpdateStateSwitch(stateMachine, entity);
            }
            public override void OnUpdateLogic(EntityStateMachine machine, Entity entity)
            {
                base.OnUpdateLogic(machine, entity);
                CheckDeath(entity);
            }
            private void UpdateStateSwitch(EntityStateMachine stateMachine, Entity entity)
            {
                // 转阶段
                if (entity.Health <= entity.GetMaxHealth() * 0.5f && GetPhase(entity) == PHASE_1)
                {
                    SetPhase(entity, PHASE_2);
                    SetEatenFlags(entity, 0);
                    stateMachine.StartState(entity, STATE_ROAR);
                    return;
                }

                var stateTimer = stateMachine.GetStateTimer(entity);
                stateTimer.Run(stateMachine.GetSpeed(entity));
                if (stateTimer.Expired)
                {
                    var nextIndex = stateMachine.GetNextStateIndex(entity);
                    int[] pool;
                    if (GetPhase(entity) == PHASE_1)
                    {
                        pool = statePoolPhase1;
                        nextIndex = pool.FindNextStateIndex(nextIndex, state => CanSwitchStatePhase1(entity, state));
                    }
                    else
                    {
                        pool = statePoolPhase2;
                        nextIndex = pool.FindNextStateIndex(nextIndex, state => CanSwitchStatePhase2(entity, state));
                    }
                    if (nextIndex >= 0)
                    {
                        var state = pool[nextIndex];
                        stateMachine.SetNextStateIndex(entity, nextIndex + 1);
                        SwitchState(entity, state);
                    }
                    else
                    {
                        stateTimer.Reset();
                    }
                }
            }
        }
        #endregion

        #region 眩晕
        public static void Stun(Entity dragon, float seconds)
        {
            stateMachine.StartState(dragon, STATE_STUNNED);
            var timer = stateMachine.GetSubStateTimer(dragon);
            timer.ResetSeconds(seconds);
            Explosion.Spawn(dragon, dragon.GetCenter(), 200f);
            dragon.PlaySound(VanillaSoundID.explosion);
            dragon.PlaySound(VanillaSoundID.meteorLand);
            dragon.Level.ShakeScreen(20, 0, 30);
        }
        private class StunnedState : EntityStateMachineState
        {
            public StunnedState() : base(STATE_STUNNED, ANIMATION_STATE_STUNNED) { }
            public override int GetAnimationSubstate(int substate)
            {
                return substate;
            }
            public override void OnEnter(EntityStateMachine stateMachine, Entity entity)
            {
                base.OnEnter(stateMachine, entity);
                var substateTimer = stateMachine.GetSubStateTimer(entity);
                substateTimer.ResetSeconds(2f);
            }
            public override void OnUpdateAI(EntityStateMachine stateMachine, Entity entity)
            {
                base.OnUpdateAI(stateMachine, entity);
                var substate = stateMachine.GetSubState(entity);
                var timer = stateMachine.GetSubStateTimer(entity);
                timer.Run(stateMachine.GetSpeed(entity));
                switch (substate)
                {
                    case SUBSTATE_START:
                        // 倒地
                        if (timer.PassedSecondsFromMax(5 / 6f))
                        {
                            entity.PlaySound(VanillaSoundID.thump);
                            entity.Level.ShakeScreen(10, 0, 15);
                        }
                        if (timer.Expired)
                        {
                            stateMachine.StartSubState(entity, SUBSTATE_END);
                            timer.ResetSeconds(2f);
                        }
                        break;
                    case SUBSTATE_END:
                        if (timer.Expired)
                        {
                            stateMachine.StartState(entity, STATE_IDLE);
                        }
                        break;
                }
            }
            public override void OnUpdateLogic(EntityStateMachine machine, Entity entity)
            {
                base.OnUpdateLogic(machine, entity);
                CheckDeath(entity);
            }
            public const int SUBSTATE_START = 0;
            public const int SUBSTATE_END = 1;
        }
        #endregion

        #region 死亡
        private class DeathState : EntityStateMachineState
        {
            public DeathState() : base(STATE_DEATH, ANIMATION_STATE_DEATH) { }
            public override int GetAnimationSubstate(int substate)
            {
                switch (substate)
                {
                    case SUBSTATE_SPECIAL:
                        return ANIMATION_SUBSTATE_END;
                }
                return ANIMATION_SUBSTATE_START;
            }
            public override void OnEnter(EntityStateMachine stateMachine, Entity entity)
            {
                base.OnEnter(stateMachine, entity);
                var substateTimer = stateMachine.GetSubStateTimer(entity);
                substateTimer.ResetSeconds(2f);

                entity.PlaySound(VanillaSoundID.dragonHit);
            }
            public override void OnExit(EntityStateMachine machine, Entity entity)
            {
                base.OnExit(machine, entity);
                SetTintMultiplier(entity, Color.white);
            }
            public override void OnUpdateLogic(EntityStateMachine stateMachine, Entity entity)
            {
                base.OnUpdateLogic(stateMachine, entity);
                var substate = stateMachine.GetSubState(entity);
                var timer = stateMachine.GetSubStateTimer(entity);
                timer.Run(stateMachine.GetSpeed(entity));
                switch (substate)
                {
                    case SUBSTATE_START:
                        // 倒地
                        if (timer.PassedSecondsFromMax(5 / 6f))
                        {
                            entity.PlaySound(VanillaSoundID.thump);
                            entity.Level.ShakeScreen(10, 0, 15);
                        }
                        if (timer.Expired)
                        {
                            if (entity.Level.AreaID == VanillaAreaID.ship && !entity.Level.IsRerun && entity.Level.IsAdventure())
                            {
                                stateMachine.StartSubState(entity, SUBSTATE_SPECIAL);
                                timer.ResetSeconds(2f);
                            }
                            else
                            {
                                stateMachine.StartSubState(entity, SUBSTATE_FADE);
                                timer.ResetSeconds(2f);
                            }
                        }
                        break;
                    case SUBSTATE_FADE:
                        {
                            SetTintMultiplier(entity, Color.Lerp(Color.white, Color.black, timer.GetPassedPercentage() * 2));
                            if (timer.Expired)
                            {
                                stateMachine.StartSubState(entity, SUBSTATE_DISAPPEAR);
                                timer.ResetSeconds(1f);
                            }
                        }
                        break;
                    case SUBSTATE_DISAPPEAR:
                        {
                            SetTintMultiplier(entity, Color.Lerp(Color.black, Color.clear, timer.GetPassedPercentage()));
                            if (timer.Expired)
                            {
                                entity.Remove();
                            }
                        }
                        break;
                    case SUBSTATE_SPECIAL:
                        {
                            if (timer.Expired)
                            {
                                stateMachine.StartState(entity, STATE_DEATH_ROAR);
                            }
                        }
                        break;
                }
            }
            public const int SUBSTATE_START = 0;
            public const int SUBSTATE_FADE = 1;
            public const int SUBSTATE_DISAPPEAR = 2;
            public const int SUBSTATE_SPECIAL = 3;
            public const int ANIMATION_SUBSTATE_START = 0;
            public const int ANIMATION_SUBSTATE_END = 1;
        }
        #endregion

        #region 死亡吼叫
        private class DeathRoarState : EntityStateMachineState
        {
            public DeathRoarState() : base(STATE_DEATH_ROAR, ANIMATION_STATE_SPIT) { }
            public override int GetAnimationSubstate(int substate)
            {
                switch (substate)
                {
                    case SUBSTATE_START:
                        return ANIMATION_SUBSTATE_START;
                    case SUBSTATE_ROAR:
                        return ANIMATION_SUBSTATE_ROAR;
                    case SUBSTATE_END:
                        return ANIMATION_SUBSTATE_END;
                }
                return base.GetAnimationSubstate(substate);
            }
            public override void OnEnter(EntityStateMachine stateMachine, Entity entity)
            {
                base.OnEnter(stateMachine, entity);
                var substateTimer = stateMachine.GetSubStateTimer(entity);
                substateTimer.ResetSeconds(1f);
            }
            public override void OnUpdateLogic(EntityStateMachine machine, Entity entity)
            {
                base.OnUpdateLogic(machine, entity);
                var substate = stateMachine.GetSubState(entity);
                var timer = stateMachine.GetSubStateTimer(entity);
                timer.Run(stateMachine.GetSpeed(entity));
                switch (substate)
                {
                    case SUBSTATE_START:
                        if (timer.Expired)
                        {
                            Roar(entity);
                            stateMachine.StartSubState(entity, SUBSTATE_ROAR);
                            timer.ResetSeconds(ROAR_SECONDS);
                        }
                        break;
                    case SUBSTATE_ROAR:
                        if (timer.Expired)
                        {
                            stateMachine.StartSubState(entity, SUBSTATE_END);
                            timer.ResetSeconds(0.5f);
                        }
                        break;
                    case SUBSTATE_END:
                        if (timer.Expired)
                        {
                            stateMachine.StartState(entity, STATE_DEATH_FLY);
                        }
                        break;
                }
            }

            public const int SUBSTATE_START = 0;
            public const int SUBSTATE_ROAR = 1;
            public const int SUBSTATE_END = 2;
            public const int ANIMATION_SUBSTATE_START = 0;
            public const int ANIMATION_SUBSTATE_ROAR = 1;
            public const int ANIMATION_SUBSTATE_END = 2;

        }
        #endregion

        #region 死亡飞行
        private class DeathFlyState : EntityStateMachineState
        {
            public DeathFlyState() : base(STATE_DEATH_FLY, ANIMATION_STATE_DEATH_FLY) { }
            public override int GetAnimationSubstate(int substate)
            {
                switch (substate)
                {
                    case SUBSTATE_START:
                        return ANIMATION_SUBSTATE_START;
                    case SUBSTATE_FLY:
                    case SUBSTATE_DAMAGED:
                        return ANIMATION_SUBSTATE_FLY;
                    case SUBSTATE_FALL:
                    case SUBSTATE_SMASHED:
                        return ANIMATION_SUBSTATE_FALL;
                }
                return base.GetAnimationSubstate(substate);
            }
            public override void OnEnter(EntityStateMachine stateMachine, Entity entity)
            {
                base.OnEnter(stateMachine, entity);
                var substateTimer = stateMachine.GetSubStateTimer(entity);
                substateTimer.ResetSeconds(4 / 3f);
                SetGravityMultiplier(entity, 0);
                SetGroundLimitOffset(entity, -2000);
            }
            public override void OnExit(EntityStateMachine machine, Entity entity)
            {
                base.OnExit(machine, entity);
                SetGravityMultiplier(entity, 1);
                SetGroundLimitOffset(entity, 0);
            }
            public override void OnUpdateLogic(EntityStateMachine machine, Entity entity)
            {
                base.OnUpdateLogic(machine, entity);
                var substate = stateMachine.GetSubState(entity);
                var timer = stateMachine.GetSubStateTimer(entity);
                timer.Run(stateMachine.GetSpeed(entity));
                switch (substate)
                {
                    case SUBSTATE_START:
                        {
                            if (timer.PassedIntervalSeconds(0.5f))
                            {
                                entity.PlaySound(VanillaSoundID.dragonWings);
                            }
                            entity.Velocity = Vector3.up * 10;
                            if (timer.Expired)
                            {
                                stateMachine.StartSubState(entity, SUBSTATE_FLY);
                                timer.ResetSeconds(5f);
                                entity.PlaySound(VanillaSoundID.dragonGrowl);
                            }
                        }
                        break;
                    case SUBSTATE_FLY:
                        {
                            if (timer.PassedIntervalSeconds(0.5f))
                            {
                                entity.PlaySound(VanillaSoundID.dragonWings);
                            }
                            entity.Velocity = Vector3.up * 5;
                            if (timer.PassedIntervalSeconds(2f))
                            {
                                entity.PlaySound(VanillaSoundID.dragonGrowl);
                            }
                            if (timer.Expired)
                            {
                                stateMachine.StartSubState(entity, SUBSTATE_DAMAGED);
                                timer.ResetSeconds(1f);

                                entity.Level.ShakeScreen(10, 0, 15);
                                entity.PlaySound(VanillaSoundID.dragonHit);
                                SetGravityMultiplier(entity, 1);
                            }
                        }
                        break;
                    case SUBSTATE_DAMAGED:
                        if (timer.Expired)
                        {
                            stateMachine.StartSubState(entity, SUBSTATE_FALL);
                            entity.PlaySound(VanillaSoundID.dragonEnd);
                        }
                        break;
                    case SUBSTATE_FALL:
                        if (entity.IsOnGround)
                        {
                            SmashShip(entity);

                            stateMachine.StartSubState(entity, SUBSTATE_SMASHED);
                            timer.ResetSeconds(5f);
                        }
                        break;
                    case SUBSTATE_SMASHED:
                        if (timer.Expired)
                        {
                            entity.Remove();
                        }
                        break;
                }
            }

            private void SmashShip(Entity entity)
            {
                entity.Level.ShakeScreen(30, 0, 60);
                Explosion.Spawn(entity, entity.Position, 1000);
                entity.PlaySound(VanillaSoundID.explosion);
                entity.PlaySound(VanillaSoundID.meteorLand);
                if (entity.Level.AreaID == VanillaAreaID.ship)
                {
                    var areaModel = entity.Level.GetAreaModelInterface();
                    areaModel?.SetModelProperty("Broken", true);
                    DestroyShipEntities(entity);
                    DestroyShipGrids(entity);
                    entity.Spawn(VanillaEffectID.fallenEndShip, new Vector3(VanillaLevelExt.LEVEL_WIDTH, 0, 0))?.Let(e =>
                    {
                        var velocity = e.Velocity;
                        velocity.y = entity.Velocity.y;
                        e.Velocity = velocity;
                    });
                }
            }
            private void DestroyShipEntities(Entity dragon)
            {
                foreach (var entity in dragon.Level.FindEntities(e => e.GetColumn() > 1 && e.ExistsAndAlive()))
                {
                    if (entity.IsVulnerableEntity())
                    {
                        entity.Die(new DamageEffectList(VanillaDamageEffects.SELF_DAMAGE), dragon);
                    }
                    else if (entity.IsEntityOf(VanillaEffectID.gridFire))
                    {
                        entity.Remove();
                    }
                }
            }
            private void DestroyShipGrids(Entity dragon)
            {
                var level = dragon.Level;
                for (int x = 2; x < level.GetMaxColumnCount(); x++)
                {
                    for (int z = 0; z < level.GetMaxLaneCount(); z++)
                    {
                        var grid = level.GetGrid(x, z);
                        if (grid == null)
                            continue;
                        grid.RemoveBuffs(VanillaBuffID.Grid.goldenGrid);
                        grid.AddBuff(VanillaBuffID.Grid.shipBrokenGrid);
                    }
                }
            }

            public const int SUBSTATE_START = 0;
            public const int SUBSTATE_FLY = 1;
            public const int SUBSTATE_DAMAGED = 2;
            public const int SUBSTATE_FALL = 3;
            public const int SUBSTATE_SMASHED = 4;
            public const int ANIMATION_SUBSTATE_START = 0;
            public const int ANIMATION_SUBSTATE_FLY = 1;
            public const int ANIMATION_SUBSTATE_FALL = 2;

        }
        #endregion

        #region 跳跃
        private static void JumpTo(Entity entity, Vector3 jumpTarget, int state)
        {
            SetJumpFinishState(entity, state);
            SetJumpTarget(entity, jumpTarget);
            stateMachine.StartState(entity, STATE_JUMP);
        }
        private static float GetJumpBorderX(Entity boss)
        {
            if (boss.IsFacingLeft())
            {
                return VanillaLevelExt.RIGHT_BORDER + 80;
            }
            else
            {
                return VanillaLevelExt.LEFT_BORDER - 80;
            }
        }
        private static Vector3 GetJumpBorderPositionByLane(Entity boss, int lane)
        {
            float x = GetJumpBorderX(boss);
            var z = boss.Level.GetEntityLaneZ(lane);
            var y = boss.Level.GetGroundY(x, z);
            return new Vector3(x, y, z);
        }
        private static int[] FindLanesWithEnemies(Entity boss)
        {
            var entities = boss.Level.FindEntities(e => e.IsVulnerableEntity() && boss.IsHostile(e));
            return entities.Select(e => e.GetLane()).Distinct().ToArray();
        }
        private static int FindRandomLaneWithEnemy(Entity boss)
        {
            var lanes = FindLanesWithEnemies(boss);
            if (lanes.Length <= 0)
            {
                return boss.GetLane();
            }
            else
            {
                var rng = boss.RNG;
                return lanes.Random(rng);
            }
        }
        private static Vector3 FindEnemyJumpTargetPosition(Entity boss)
        {
            int lane = FindRandomLaneWithEnemy(boss);
            return GetJumpBorderPositionByLane(boss, lane);
        }
        private static Vector3 FindRandomJumpTargetPosition(Entity boss)
        {
            var currentLane = boss.GetLane();
            var lane = boss.RNG.Next(boss.Level.GetMaxLaneCount() - 1); // 自己的一行不算
            if (lane >= currentLane)
            {
                // 如果获取到的行数大于或等于该实体目前的行数，则目标行数+1。
                lane++;
            }
            return GetJumpBorderPositionByLane(boss, lane);
        }

        private class JumpState : EntityStateMachineState
        {
            public JumpState() : base(STATE_JUMP, ANIMATION_STATE_JUMP) { }
            public override int GetAnimationSubstate(int substate)
            {
                switch (substate)
                {
                    case SUBSTATE_START:
                        return ANIMATION_SUBSTATE_START;
                    case SUBSTATE_FALL:
                        return ANIMATION_SUBSTATE_FALL;
                    case SUBSTATE_END:
                        return ANIMATION_SUBSTATE_END;
                }
                return base.GetAnimationSubstate(substate);
            }
            public override void OnEnter(EntityStateMachine stateMachine, Entity entity)
            {
                base.OnEnter(stateMachine, entity);
                var substateTimer = stateMachine.GetSubStateTimer(entity);
                substateTimer.ResetSeconds(1 / 6f);
            }
            public override void OnUpdateAI(EntityStateMachine stateMachine, Entity entity)
            {
                base.OnUpdateAI(stateMachine, entity);
                var substate = stateMachine.GetSubState(entity);
                var timer = stateMachine.GetSubStateTimer(entity);
                timer.Run(stateMachine.GetSpeed(entity));
                switch (substate)
                {
                    case SUBSTATE_START:
                        if (timer.Expired)
                        {
                            StartJump(entity);
                            stateMachine.StartSubState(entity, SUBSTATE_FALL);
                        }
                        break;
                    case SUBSTATE_FALL:
                        {
                            Vector3 target = GetJumpTarget(entity);
                            var pos = entity.Position;
                            pos.x = Ticks.SmoothDamp(pos.x, target.x, 0.2f);
                            pos.z = Ticks.SmoothDamp(pos.z, target.z, 0.2f);
                            entity.Position = pos;
                            if (entity.IsOnGround)
                            {
                                Land(entity);
                                stateMachine.StartSubState(entity, SUBSTATE_END);
                                timer.ResetSeconds(0.5f);
                            }
                        }
                        break;
                    case SUBSTATE_END:
                        if (timer.Expired)
                        {
                            var finishState = GetJumpFinishState(entity);
                            SetJumpFinishState(entity, -1);
                            if (finishState < 0)
                            {
                                finishState = STATE_IDLE;
                            }
                            stateMachine.StartState(entity, finishState);
                        }
                        break;
                }
            }
            public override void OnUpdateLogic(EntityStateMachine machine, Entity entity)
            {
                base.OnUpdateLogic(machine, entity);
                CheckDeath(entity);
            }
            private void StartJump(Entity boss)
            {
                Vector3 velocity = boss.Velocity;
                velocity.y = boss.GetGravity() * Ticks.FromSeconds(jumpFlyingSeconds) / 2f;
                boss.Velocity = velocity;
            }
            private void Land(Entity entity)
            {
                LandCrush(entity);
                entity.Level.ShakeScreen(5, 0, 15);
                entity.PlaySound(VanillaSoundID.thump);
            }
            public const int SUBSTATE_START = 0;
            public const int SUBSTATE_FALL = 1;
            public const int SUBSTATE_END = 2;
            public const int ANIMATION_SUBSTATE_START = 0;
            public const int ANIMATION_SUBSTATE_FALL = 1;
            public const int ANIMATION_SUBSTATE_END = 2;

            private const float jumpFlyingSeconds = 0.5f;
        }
        #endregion

        #region 喷吐火球
        private class SpitState : EntityStateMachineState
        {
            public SpitState() : base(STATE_SPIT, ANIMATION_STATE_SPIT) { }
            public override int GetAnimationSubstate(int substate)
            {
                switch (substate)
                {
                    case SUBSTATE_START:
                        return ANIMATION_SUBSTATE_START;
                    case SUBSTATE_SPIT_1:
                    case SUBSTATE_SPIT_2:
                    case SUBSTATE_SPIT_3:
                        return ANIMATION_SUBSTATE_SPIT;
                    case SUBSTATE_END:
                        return ANIMATION_SUBSTATE_END;
                }
                return base.GetAnimationSubstate(substate);
            }
            public override void OnEnter(EntityStateMachine stateMachine, Entity entity)
            {
                base.OnEnter(stateMachine, entity);
                var substateTimer = stateMachine.GetSubStateTimer(entity);
                substateTimer.ResetSeconds(1f);
            }
            public override void OnUpdateAI(EntityStateMachine stateMachine, Entity entity)
            {
                base.OnUpdateAI(stateMachine, entity);
                var substate = stateMachine.GetSubState(entity);
                var timer = stateMachine.GetSubStateTimer(entity);
                timer.Run(stateMachine.GetSpeed(entity));
                switch (substate)
                {
                    case SUBSTATE_START:
                        if (timer.Expired)
                        {
                            ShootFireball(entity);
                            stateMachine.StartSubState(entity, SUBSTATE_SPIT_1);
                            timer.ResetSeconds(0.2f);
                        }
                        break;
                    case SUBSTATE_SPIT_1:
                        if (timer.Expired)
                        {
                            ShootFireball(entity);
                            stateMachine.StartSubState(entity, SUBSTATE_SPIT_2);
                            timer.ResetSeconds(0.2f);
                        }
                        break;
                    case SUBSTATE_SPIT_2:
                        if (timer.Expired)
                        {
                            ShootFireball(entity);
                            stateMachine.StartSubState(entity, SUBSTATE_SPIT_3);
                            timer.ResetSeconds(0.2f);
                        }
                        break;
                    case SUBSTATE_SPIT_3:
                        if (timer.Expired)
                        {
                            stateMachine.StartSubState(entity, SUBSTATE_END);
                            timer.ResetSeconds(0.5f);
                        }
                        break;
                    case SUBSTATE_END:
                        if (timer.Expired)
                        {
                            stateMachine.StartState(entity, STATE_IDLE);
                        }
                        break;
                }
            }
            public override void OnUpdateLogic(EntityStateMachine machine, Entity entity)
            {
                base.OnUpdateLogic(machine, entity);
                CheckDeath(entity);
            }

            private void ShootFireball(Entity entity)
            {
                var param = entity.GetShootParams();
                param.projectileID = VanillaProjectileID.fireCharge;
                param.velocity = GetNeckDirection(entity) * 20;
                param.position = GetSpitSourcePosition(entity) + Vector3.down * 12; // 火焰弹高度的一半
                param.soundID = VanillaSoundID.fireCharge;
                param.damage = entity.GetDamage() * 1;
                entity.ShootProjectile(param);
            }
            public const int SUBSTATE_START = 0;
            public const int SUBSTATE_SPIT_1 = 1;
            public const int SUBSTATE_SPIT_2 = 2;
            public const int SUBSTATE_SPIT_3 = 3;
            public const int SUBSTATE_END = 4;
            public const int ANIMATION_SUBSTATE_START = 0;
            public const int ANIMATION_SUBSTATE_SPIT = 1;
            public const int ANIMATION_SUBSTATE_END = 2;

        }
        #endregion

        #region 扇风
        private class FlapWingsState : EntityStateMachineState
        {
            public FlapWingsState() : base(STATE_FLAP_WINGS, ANIMATION_STATE_FLAP_WINGS) { }
            public override void OnEnter(EntityStateMachine stateMachine, Entity entity)
            {
                base.OnEnter(stateMachine, entity);
                var substateTimer = stateMachine.GetSubStateTimer(entity);
                substateTimer.ResetSeconds(2 / 3f);
                if (GetPhase(entity) == PHASE_2)
                {
                    SetFireInMouth(entity, true);
                }
            }
            public override void OnExit(EntityStateMachine machine, Entity entity)
            {
                base.OnExit(machine, entity);
                SetFireInMouth(entity, false);
            }
            public override void OnUpdateAI(EntityStateMachine stateMachine, Entity entity)
            {
                base.OnUpdateAI(stateMachine, entity);
                var substate = stateMachine.GetSubState(entity);
                var timer = stateMachine.GetSubStateTimer(entity);
                timer.Run(stateMachine.GetSpeed(entity));
                switch (substate)
                {
                    case SUBSTATE_START:
                        if (timer.Expired)
                        {
                            entity.PlaySound(VanillaSoundID.dragonWings);
                            stateMachine.StartSubState(entity, SUBSTATE_FLAP_1);
                            timer.ResetSeconds(1f);
                        }
                        break;
                    case SUBSTATE_FLAP_1:
                        if (timer.Expired)
                        {
                            entity.PlaySound(VanillaSoundID.dragonWings);
                            stateMachine.StartSubState(entity, SUBSTATE_FLAP_2);
                            timer.ResetSeconds(1f);
                        }
                        break;
                    case SUBSTATE_FLAP_2:
                        if (timer.Expired)
                        {
                            entity.PlaySound(VanillaSoundID.dragonGrowl);
                            entity.PlaySound(VanillaSoundID.dragonWings);
                            entity.Level.ShakeScreen(10, 0, 15);
                            ShootTornado(entity);
                            SetFireInMouth(entity, false);
                            stateMachine.StartSubState(entity, SUBSTATE_END);
                            timer.ResetSeconds(7 / 12f);
                        }
                        break;
                    case SUBSTATE_END:
                        if (timer.Expired)
                        {
                            stateMachine.StartState(entity, STATE_IDLE);
                        }
                        break;
                }
            }
            public override void OnUpdateLogic(EntityStateMachine machine, Entity entity)
            {
                base.OnUpdateLogic(machine, entity);
                CheckDeath(entity);
            }

            private void ShootTornado(Entity entity)
            {
                var level = entity.Level;
                var variant = Tornado.VARIANT_NORMAL;
                var speed = 2;
                int count = 1;
                bool phase2 = GetPhase(entity) == PHASE_2;
                if (phase2)
                {
                    variant = Tornado.VARIANT_FIRE;
                    speed = 4;
                }
                else
                {
                    count = level.GetRedDragonTornadoCount();
                }

                var param = entity.GetSpawnParams();
                param.SetProperty(VanillaEntityProps.VARIANT, variant);

                var lane = entity.GetLane();
                for (int i = 0; i < count; i++)
                {
                    var laneOffsetLength = (i + 1) / 2;
                    var laneOffsetDirection = (i % 2) * 2 - 1;
                    var laneOffset = laneOffsetDirection * laneOffsetLength;
                    var targetLane = lane + laneOffset;
                    if (targetLane < 0 || targetLane >= level.GetMaxLaneCount())
                        continue;
                    var position = GetTornadoSourcePosition(entity);
                    position.z = level.GetEntityLaneZ(targetLane);
                    entity.Spawn(VanillaEffectID.tornado, position, param)?.Let(e =>
                    {
                        e.Velocity = entity.GetFacingDirection() * speed;
                        if (phase2)
                        {
                            e.PlaySound(VanillaSoundID.refuel);
                        }
                    });
                }
            }
            public const int SUBSTATE_START = 0;
            public const int SUBSTATE_FLAP_1 = 1;
            public const int SUBSTATE_FLAP_2 = 2;
            public const int SUBSTATE_END = 3;

        }
        #endregion

        #region 吞食
        public static Bounds GetEatDetectionHitbox(Entity entity)
        {
            var size = new Vector3(EAT_HITBOX_WIDTH, EAT_HITBOX_HEIGHT, EAT_HITBOX_Z_LENGTH + EAT_HITBOX_RANGE * 2);
            var position = entity.Position + entity.GetFacingDirection() * EAT_HITBOX_DISTANCE_X;
            position.y += size.y * 0.5f;
            return new Bounds(position, size);
        }
        public static Bounds GetEatHitbox(Entity entity, float time)
        {
            var size = new Vector3(EAT_HITBOX_WIDTH, EAT_HITBOX_HEIGHT, EAT_HITBOX_Z_LENGTH);
            var position = entity.Position + entity.GetFacingDirection() * EAT_HITBOX_DISTANCE_X;
            position.y += size.y * 0.5f;
            position.z += EAT_HITBOX_RANGE * (1 - 2 * time);
            return new Bounds(position, size);
        }
        private static bool HasEatableTargets(Entity boss)
        {
            return eatDetector.DetectEntityCount(boss) > 0;
        }
        private class EatState : EntityStateMachineState
        {
            public EatState() : base(STATE_EAT, ANIMATION_STATE_EAT) { }
            public override int GetAnimationSubstate(int substate)
            {
                switch (substate)
                {
                    case SUBSTATE_SWALLOW:
                    case SUBSTATE_SWALLOW_END:
                        return ANIMATION_SUBSTATE_SWALLOW;
                }
                return substate;
            }
            public override void OnEnter(EntityStateMachine stateMachine, Entity entity)
            {
                base.OnEnter(stateMachine, entity);
                var substateTimer = stateMachine.GetSubStateTimer(entity);
                substateTimer.ResetSeconds(2 / 3f);
                SetEatenEntities(entity, null);
            }
            public override void OnUpdateAI(EntityStateMachine stateMachine, Entity entity)
            {
                base.OnUpdateAI(stateMachine, entity);
                var substate = stateMachine.GetSubState(entity);
                var timer = stateMachine.GetSubStateTimer(entity);
                timer.Run(stateMachine.GetSpeed(entity));
                switch (substate)
                {
                    case SUBSTATE_START:
                        if (timer.Expired)
                        {
                            entity.PlaySound(VanillaSoundID.fling);
                            entity.PlaySound(VanillaSoundID.bigChomp, 0.5f);
                            stateMachine.StartSubState(entity, SUBSTATE_EAT);
                            timer.ResetSeconds(0.25f);
                        }
                        break;
                    case SUBSTATE_EAT:
                        Eat(entity, timer.GetPassedPercentage());
                        if (timer.Expired)
                        {
                            var entities = GetEatenEntities(entity);
                            if (entities != null && entities.Count > 0)
                            {
                                stateMachine.StartSubState(entity, SUBSTATE_SWALLOW);
                                timer.ResetSeconds(1f);
                            }
                            else
                            {
                                stateMachine.StartSubState(entity, SUBSTATE_END);
                                timer.ResetSeconds(0.5f);
                            }
                        }
                        break;
                    case SUBSTATE_SWALLOW:
                        if (timer.Expired)
                        {
                            Swallow(entity);
                            SetEatenEntities(entity, null);
                            stateMachine.StartSubState(entity, SUBSTATE_SWALLOW_END);
                            timer.ResetSeconds(2 / 3f);
                        }
                        break;
                    case SUBSTATE_SWALLOW_END:
                        if (timer.Expired)
                        {
                            stateMachine.StartState(entity, STATE_FIRE_BREATH);
                        }
                        break;
                    case SUBSTATE_END:
                        if (timer.Expired)
                        {
                            stateMachine.StartState(entity, STATE_FIRE_BREATH);
                        }
                        break;
                }
            }
            public override void OnUpdateLogic(EntityStateMachine machine, Entity entity)
            {
                base.OnUpdateLogic(machine, entity);
                CheckDeath(entity);
            }

            private void Eat(Entity entity, float time)
            {
                var hitbox = GetEatHitbox(entity, time);
                var mask = EntityCollisionHelper.MASK_VULNERABLE;
                var targets = entity.Level.OverlapBox(hitbox.center, hitbox.size, entity.GetFaction(), mask, mask);
                foreach (var collider in targets)
                {
                    var target = collider.Entity;
                    if (!target.ExistsAndAlive())
                        return;
                    if (collider.IsForMain() && target.Type != EntityTypes.BOSS)
                    {
                        if (target.Type != EntityTypes.PLANT)
                        {
                            target.PlayDeathSound();
                        }
                        target.Die(new DamageEffectList(VanillaDamageEffects.REMOVE_ON_DEATH, VanillaDamageEffects.NO_DEATH_TRIGGER), entity);
                        EatEntity(entity, target);
                    }
                    else
                    {
                        collider.TakeDamage(entity.GetDamage() * BITE_DAMAGE_MULTIPLIER, new DamageEffectList(), entity);
                    }
                }
            }
            private void EatEntity(Entity entity, Entity target)
            {
                var entities = GetEatenEntities(entity);
                if (entities == null)
                {
                    entities = new List<NamespaceID>();
                    SetEatenEntities(entity, entities);
                }
                entities.Add(target.GetDefinitionID());
            }
            private void Swallow(Entity entity)
            {
                var entities = GetEatenEntities(entity);
                if (entities == null)
                    return;
                var eatenFlags = GetEatenFlags(entity);
                foreach (var entityID in entities)
                {
                    if (!NamespaceID.IsValid(entityID))
                        continue;
                    var entityDef = entity.Level.Content.GetEntityDefinition(entityID);
                    if (entityDef == null)
                        continue;
                    if (entityDef.GetShellID() == VanillaShellID.flesh && entityDef.IsUndead())
                    {
                        eatenFlags |= EATEN_FLAG_CORPSE;
                    }
                    if (entityDef.GetShellID() == VanillaShellID.wood)
                    {
                        eatenFlags |= EATEN_FLAG_CHARCOAL;
                    }
                    if (entityDef.IsDynamite())
                    {
                        eatenFlags |= EATEN_FLAG_DYNAMITE;
                    }
                }
                SetEatenFlags(entity, eatenFlags);
                entity.HealEffects(entities.Count * EAT_HEAL_PER_ENTITY, entity);
                entity.PlaySound(VanillaSoundID.gulp, 0.5f);
            }
            public const int SUBSTATE_START = 0;
            public const int SUBSTATE_EAT = 1;
            public const int SUBSTATE_END = 2;
            public const int SUBSTATE_SWALLOW = 3;
            public const int SUBSTATE_SWALLOW_END = 4;
            public const int ANIMATION_SUBSTATE_SWALLOW = 3;

        }
        #endregion

        #region 火焰吐息
        private static bool ShouldExplodeOnBreath(Entity entity)
        {
            var eatenFlags = GetEatenFlags(entity);
            if ((eatenFlags & EATEN_FLAG_CORPSE) != 0 && (eatenFlags & EATEN_FLAG_CHARCOAL) != 0)
                return true;
            if ((eatenFlags & EATEN_FLAG_DYNAMITE) != 0)
                return true;
            return false;
        }
        private static void SelfExplode(Entity entity)
        {
            SetEatenFlags(entity, 0);
            Stun(entity, SELF_EXPLODE_STUN_SECONDS);
            entity.PlaySound(VanillaSoundID.dragonHit);
            float damage;
            if (entity.Level.IsBossRevenge())
            {
                damage = 1800;
            }
            else
            {
                damage = entity.GetMaxHealth() * 0.5f;
            }
            var damageEffects = new DamageEffectList(VanillaDamageEffects.BYPASS_BOSS_ARMOR, VanillaDamageEffects.IGNORE_ARMOR, VanillaDamageEffects.SELF_DAMAGE, VanillaDamageEffects.EXPLOSION);
            entity.TakeDamage(damage, damageEffects, entity);
        }
        private class FireBreathState : EntityStateMachineState
        {
            public FireBreathState() : base(STATE_FIRE_BREATH, ANIMATION_STATE_SPIT) { }
            public override int GetAnimationSubstate(int substate)
            {
                switch (substate)
                {
                    case SUBSTATE_START:
                        return ANIMATION_SUBSTATE_START;
                    case SUBSTATE_LOOP:
                        return ANIMATION_SUBSTATE_SPIT;
                    case SUBSTATE_END:
                        return ANIMATION_SUBSTATE_END;
                }
                return base.GetAnimationSubstate(substate);
            }
            public override void OnEnter(EntityStateMachine stateMachine, Entity entity)
            {
                base.OnEnter(stateMachine, entity);
                var substateTimer = stateMachine.GetSubStateTimer(entity);
                substateTimer.ResetSeconds(1f);
                SetFireInMouth(entity, true);
            }
            public override void OnExit(EntityStateMachine machine, Entity entity)
            {
                base.OnExit(machine, entity);
                SetHeadRotation(entity, 0);
                SetFireInMouth(entity, false);
            }
            public override void OnUpdateAI(EntityStateMachine stateMachine, Entity entity)
            {
                base.OnUpdateAI(stateMachine, entity);
                var substate = stateMachine.GetSubState(entity);
                var timer = stateMachine.GetSubStateTimer(entity);
                timer.Run(stateMachine.GetSpeed(entity));
                switch (substate)
                {
                    case SUBSTATE_START:
                        {
                            var headRotation = GetHeadRotation(entity);
                            headRotation = Ticks.SmoothDamp(headRotation, FIRE_BREATH_ANGLE_START, 0.2f);
                            SetHeadRotation(entity, headRotation);
                            if (timer.Expired)
                            {
                                entity.PlaySound(VanillaSoundID.dragonGrowl);
                                if (ShouldExplodeOnBreath(entity))
                                {
                                    SelfExplode(entity);
                                }
                                else
                                {
                                    stateMachine.StartSubState(entity, SUBSTATE_LOOP);
                                    timer.ResetSeconds(1.5f);
                                }
                            }
                        }
                        break;
                    case SUBSTATE_LOOP:
                        {
                            SetHeadRotation(entity, Mathf.Lerp(FIRE_BREATH_ANGLE_START, FIRE_BREATH_ANGLE_END, timer.GetPassedPercentage()));

                            if (timer.PassedIntervalSeconds(0.2f))
                            {
                                ShootFireBreath(entity);
                            }
                            if (timer.Expired)
                            {
                                stateMachine.StartSubState(entity, SUBSTATE_END);
                                timer.ResetSeconds(0.5f);
                                SetFireInMouth(entity, false);
                            }
                        }
                        break;
                    case SUBSTATE_END:
                        {
                            var headRotation = GetHeadRotation(entity);
                            headRotation = Ticks.SmoothDamp(headRotation, 0, 0.2f);
                            if (timer.Expired)
                            {
                                stateMachine.StartState(entity, STATE_IDLE);
                                headRotation = 0;
                            }
                            SetHeadRotation(entity, headRotation);
                        }
                        break;
                }
            }
            public override void OnUpdateLogic(EntityStateMachine machine, Entity entity)
            {
                base.OnUpdateLogic(machine, entity);
                CheckDeath(entity);
            }

            private void ShootFireBreath(Entity entity)
            {
                var fireVariant = GetFireVariant(entity);
                var param = entity.GetSpawnParams();
                param.SetProperty(VanillaEntityProps.DAMAGE, entity.GetDamage() * FIRE_BREATH_DAMAGE_MULTIPLIER);
                param.SetProperty(VanillaEntityProps.VARIANT, fireVariant);
                var position = GetSpitSourcePosition(entity) + Vector3.down * 48; // 龙息高度的一半
                entity.Spawn(VanillaEffectID.dragonFireBreath, position, param)?.Let(e =>
                {
                    e.Velocity = GetNeckDirection(entity) * FIRE_BREATH_SPEED;
                });
            }
            public const int SUBSTATE_START = 0;
            public const int SUBSTATE_LOOP = 1;
            public const int SUBSTATE_END = 2;
            public const int ANIMATION_SUBSTATE_START = 0;
            public const int ANIMATION_SUBSTATE_SPIT = 1;
            public const int ANIMATION_SUBSTATE_END = 2;

        }
        #endregion

        #region 吼叫
        private class RoarState : EntityStateMachineState
        {
            public RoarState() : base(STATE_ROAR, ANIMATION_STATE_SPIT) { }
            public override int GetAnimationSubstate(int substate)
            {
                switch (substate)
                {
                    case SUBSTATE_START:
                        return ANIMATION_SUBSTATE_START;
                    case SUBSTATE_ROAR:
                        return ANIMATION_SUBSTATE_ROAR;
                    case SUBSTATE_END:
                        return ANIMATION_SUBSTATE_END;
                    case SUBSTATE_APPEAR_START:
                        return ANIMATION_SUBSTATE_APPEAR_START;
                }
                return base.GetAnimationSubstate(substate);
            }
            public override void OnEnter(EntityStateMachine stateMachine, Entity entity)
            {
                base.OnEnter(stateMachine, entity);
                var substateTimer = stateMachine.GetSubStateTimer(entity);
                substateTimer.ResetSeconds(1f);
            }
            public override void OnUpdateAI(EntityStateMachine stateMachine, Entity entity)
            {
                base.OnUpdateAI(stateMachine, entity);
                var substate = stateMachine.GetSubState(entity);
                var timer = stateMachine.GetSubStateTimer(entity);
                timer.Run(stateMachine.GetSpeed(entity));
                switch (substate)
                {
                    case SUBSTATE_START:
                    case SUBSTATE_APPEAR_START:
                        if (timer.Expired)
                        {
                            Roar(entity);
                            stateMachine.StartSubState(entity, SUBSTATE_ROAR);
                            timer.ResetSeconds(ROAR_SECONDS);
                        }
                        break;
                    case SUBSTATE_ROAR:
                        if (timer.Expired)
                        {
                            stateMachine.StartSubState(entity, SUBSTATE_END);
                            timer.ResetSeconds(0.5f);
                        }
                        break;
                    case SUBSTATE_END:
                        if (timer.Expired)
                        {
                            stateMachine.StartState(entity, STATE_IDLE);
                        }
                        break;
                }
            }
            public override void OnUpdateLogic(EntityStateMachine machine, Entity entity)
            {
                base.OnUpdateLogic(machine, entity);
                CheckDeath(entity);
            }

            public const int SUBSTATE_START = 0;
            public const int SUBSTATE_ROAR = 1;
            public const int SUBSTATE_END = 2;
            public const int SUBSTATE_APPEAR_START = 3;
            public const int ANIMATION_SUBSTATE_START = 0;
            public const int ANIMATION_SUBSTATE_ROAR = 1;
            public const int ANIMATION_SUBSTATE_END = 2;
            public const int ANIMATION_SUBSTATE_APPEAR_START = 3;

        }
        #endregion

        #region 爆炸火球
        private class LargeFireballState : EntityStateMachineState
        {
            public LargeFireballState() : base(STATE_LARGE_FIREBALL, ANIMATION_STATE_SPIT) { }
            public override int GetAnimationSubstate(int substate)
            {
                switch (substate)
                {
                    case SUBSTATE_START:
                        return ANIMATION_SUBSTATE_START;
                    case SUBSTATE_CREATE:
                        return ANIMATION_SUBSTATE_CREATE;
                    case SUBSTATE_END:
                        return ANIMATION_SUBSTATE_END;
                }
                return base.GetAnimationSubstate(substate);
            }
            public override void OnEnter(EntityStateMachine stateMachine, Entity entity)
            {
                base.OnEnter(stateMachine, entity);
                var substateTimer = stateMachine.GetSubStateTimer(entity);
                substateTimer.ResetSeconds(1f);

                SetFireInMouth(entity, true);
            }
            public override void OnExit(EntityStateMachine machine, Entity entity)
            {
                base.OnExit(machine, entity);
                SetFireInMouth(entity, false);
            }
            public override void OnUpdateAI(EntityStateMachine stateMachine, Entity entity)
            {
                base.OnUpdateAI(stateMachine, entity);
                var substate = stateMachine.GetSubState(entity);
                var timer = stateMachine.GetSubStateTimer(entity);
                timer.Run(stateMachine.GetSpeed(entity));
                switch (substate)
                {
                    case SUBSTATE_START:
                        if (timer.Expired)
                        {
                            CreateLargeFireball(entity);
                            entity.PlaySound(VanillaSoundID.dragonGrowl);
                            stateMachine.StartSubState(entity, SUBSTATE_CREATE);
                            timer.ResetSeconds(2f);
                        }
                        break;
                    case SUBSTATE_CREATE:
                        if (timer.Expired)
                        {
                            SetFireInMouth(entity, false);
                            stateMachine.StartSubState(entity, SUBSTATE_END);
                            timer.ResetSeconds(0.5f);
                        }
                        break;
                    case SUBSTATE_END:
                        if (timer.Expired)
                        {
                            stateMachine.StartState(entity, STATE_IDLE);
                        }
                        break;
                }
            }
            public override void OnUpdateLogic(EntityStateMachine machine, Entity entity)
            {
                base.OnUpdateLogic(machine, entity);
                CheckDeath(entity);
            }

            private void CreateLargeFireball(Entity entity)
            {
                var level = entity.Level;
                var speed = level.GetRedDragonGiantFireballSpeed();

                var param = entity.GetShootParams();
                param.projectileID = VanillaProjectileID.explosiveLargeFireball;
                param.velocity = GetNeckDirection(entity) * speed;
                param.position = GetSpitSourcePosition(entity) + Vector3.down * 20; // 离地有一定距离
                param.soundID = VanillaSoundID.dragonBreath;
                param.damage = entity.GetDamage() * 18;
                entity.ShootProjectile(param)?.Let(p =>
                {
                    var triggerTime = ExplosiveLargeFireball.TRIGGER_SECONDS / speed;
                    ExplosiveLargeFireball.SetTriggerTime(p, triggerTime);
                });
                entity.PlaySound(VanillaSoundID.refuel);
            }
            public const int SUBSTATE_START = 0;
            public const int SUBSTATE_CREATE = 1;
            public const int SUBSTATE_END = 2;
            public const int ANIMATION_SUBSTATE_START = 0;
            public const int ANIMATION_SUBSTATE_CREATE = 1;
            public const int ANIMATION_SUBSTATE_END = 2;

        }
        #endregion

        #region 向天喷射
        private class SpitUpState : EntityStateMachineState
        {
            public SpitUpState() : base(STATE_SPIT_UP, ANIMATION_STATE_SPIT_UP) { }
            public override int GetAnimationSubstate(int substate)
            {
                switch (substate)
                {
                    case SUBSTATE_START:
                        return ANIMATION_SUBSTATE_START;
                    case SUBSTATE_SPIT:
                        return ANIMATION_SUBSTATE_SPIT;
                    case SUBSTATE_END:
                        return ANIMATION_SUBSTATE_END;
                }
                return base.GetAnimationSubstate(substate);
            }
            public override void OnEnter(EntityStateMachine stateMachine, Entity entity)
            {
                base.OnEnter(stateMachine, entity);
                var substateTimer = stateMachine.GetSubStateTimer(entity);
                substateTimer.ResetSeconds(1f);

                SetFireInMouth(entity, true);
            }
            public override void OnExit(EntityStateMachine machine, Entity entity)
            {
                base.OnExit(machine, entity);
                SetFireInMouth(entity, false);
            }
            public override void OnUpdateAI(EntityStateMachine stateMachine, Entity entity)
            {
                base.OnUpdateAI(stateMachine, entity);
                var substate = stateMachine.GetSubState(entity);
                var timer = stateMachine.GetSubStateTimer(entity);
                timer.Run(stateMachine.GetSpeed(entity));
                switch (substate)
                {
                    case SUBSTATE_START:
                        if (timer.Expired)
                        {
                            entity.PlaySound(VanillaSoundID.dragonGrowl);
                            stateMachine.StartSubState(entity, SUBSTATE_SPIT);
                            timer.ResetSeconds(2f);


                            var buff = entity.Level.NewBuff<BeaconMeteorBuff>();
                            BeaconMeteorBuff.SetFaction(buff, entity.GetFaction());
                            BeaconMeteorBuff.SetDamage(buff, entity.GetDamage() * METEOR_DAMAGE_MULTIPLIER);
                            BeaconMeteorBuff.SetCount(buff, METEOR_COUNT);
                            BeaconMeteorBuff.SetHSVOffset(buff, METEOR_HSV_OFFSET);
                            BeaconMeteorBuff.SetRNG(buff, new RandomGenerator(entity.RNG.Next()));
                            entity.Level.AddBuff(buff);

                        }
                        break;
                    case SUBSTATE_SPIT:
                        if (timer.PassedIntervalSeconds(0.2f))
                        {
                            ShootBreath(entity);
                        }
                        if (timer.Expired)
                        {
                            SetFireInMouth(entity, false);
                            stateMachine.StartSubState(entity, SUBSTATE_END);
                            timer.ResetSeconds(0.5f);
                        }
                        break;
                    case SUBSTATE_END:
                        if (timer.Expired)
                        {
                            stateMachine.StartState(entity, STATE_IDLE);
                        }
                        break;
                }
            }
            public override void OnUpdateLogic(EntityStateMachine machine, Entity entity)
            {
                base.OnUpdateLogic(machine, entity);
                CheckDeath(entity);
            }

            private void ShootBreath(Entity entity)
            {
                var fireVariant = GetFireVariant(entity);
                var param = entity.GetSpawnParams();
                param.SetProperty(VanillaEntityProps.DAMAGE, entity.GetDamage() * FIRE_BREATH_DAMAGE_MULTIPLIER);
                param.SetProperty(VanillaEntityProps.VARIANT, fireVariant);
                param.SetProperty(VanillaEntityProps.MAX_TIMEOUT, 30);
                var source = GetNeckRootPosition(entity);
                var direction = new Vector3(entity.GetFacingX() * 0.3f, 1).normalized;
                var position = source + direction * NECK_LENGTH;
                entity.Spawn(VanillaEffectID.dragonFireBreath, position, param)?.Let(e =>
                {
                    e.Velocity = direction * FIRE_BREATH_SPEED;
                });
            }
            public const int SUBSTATE_START = 0;
            public const int SUBSTATE_SPIT = 1;
            public const int SUBSTATE_END = 2;
            public const int ANIMATION_SUBSTATE_START = 0;
            public const int ANIMATION_SUBSTATE_SPIT = 1;
            public const int ANIMATION_SUBSTATE_END = 2;

        }
        #endregion

        #region 飞行
        private class FlyState : EntityStateMachineState
        {
            public FlyState() : base(STATE_FLY, ANIMATION_STATE_FLY) { }
            public override int GetAnimationSubstate(int substate)
            {
                switch (substate)
                {
                    case SUBSTATE_START:
                        return ANIMATION_SUBSTATE_START;
                    case SUBSTATE_FLY:
                        return ANIMATION_SUBSTATE_FLY;
                    case SUBSTATE_GLIDE:
                    case SUBSTATE_GLIDE_BACK:
                        return ANIMATION_SUBSTATE_GLIDE;
                    case SUBSTATE_LAND:
                        return ANIMATION_SUBSTATE_LAND;
                }
                return base.GetAnimationSubstate(substate);
            }
            public override void OnEnter(EntityStateMachine stateMachine, Entity entity)
            {
                base.OnEnter(stateMachine, entity);
                var substateTimer = stateMachine.GetSubStateTimer(entity);
                substateTimer.ResetSeconds(4 / 3f);
                SetGravityMultiplier(entity, 0);
            }
            public override void OnExit(EntityStateMachine machine, Entity entity)
            {
                base.OnExit(machine, entity);
                SetFireInMouth(entity, false);
                SetRotation(entity, 0);
                SetGravityMultiplier(entity, 1);
            }
            public override void OnUpdateAI(EntityStateMachine stateMachine, Entity entity)
            {
                base.OnUpdateAI(stateMachine, entity);
                var substate = stateMachine.GetSubState(entity);
                var timer = stateMachine.GetSubStateTimer(entity);
                timer.Run(stateMachine.GetSpeed(entity));
                switch (substate)
                {
                    case SUBSTATE_START:
                        if (timer.PassedIntervalSeconds(0.5f))
                        {
                            entity.PlaySound(VanillaSoundID.dragonWings);
                        }
                        entity.Velocity = entity.GetFacingDirection() * -10 + Vector3.up * 5;
                        if (timer.Expired)
                        {
                            stateMachine.StartSubState(entity, SUBSTATE_FLY);
                            timer.ResetSeconds(1f);
                            entity.Level.ShakeScreen(10, 0, 15);
                            entity.PlaySound(VanillaSoundID.dragonGrowl);
                        }
                        break;
                    case SUBSTATE_FLY:
                        {
                            entity.Velocity = Ticks.SmoothDamp(entity.Velocity, Vector3.zero, 0.2f);
                            if (timer.PassedIntervalSeconds(0.5f))
                            {
                                entity.PlaySound(VanillaSoundID.dragonWings);
                            }
                            if (timer.Expired)
                            {
                                stateMachine.StartSubState(entity, SUBSTATE_GLIDE);
                                timer.ResetSeconds(1.5f); // 这个时间会影响灭火的反应时间，算上飞走和飞回的时间，算是两倍

                                var targetLane = FindRandomLaneWithEnemy(entity);
                                var position = entity.Position;
                                position.z = entity.Level.GetEntityLaneZ(targetLane);
                                entity.Position = position;

                                entity.PlaySound(VanillaSoundID.fireBreathBig);
                                entity.PlaySound(VanillaSoundID.dragonGrowl);
                            }
                        }
                        break;
                    case SUBSTATE_GLIDE:
                        ShootBreath(entity);
                        entity.Level.ShakeScreen(10, 0, 2);
                        entity.Velocity = entity.GetFacingDirection() * FLY_SPEED;
                        if (timer.Expired)
                        {
                            SetRotation(entity, 180);
                            stateMachine.StartSubState(entity, SUBSTATE_GLIDE_BACK);
                        }
                        break;
                    case SUBSTATE_GLIDE_BACK:
                        var middleLane = entity.Level.GetMaxLaneCount() / 2;
                        var targetPosition = GetJumpBorderPositionByLane(entity, middleLane);
                        entity.Velocity = (targetPosition - entity.Position).normalized * FLY_SPEED;
                        if (entity.IsOnGround)
                        {
                            entity.Level.ShakeScreen(20, 0, 30);
                            entity.PlaySound(VanillaSoundID.meteorLand);
                            stateMachine.StartSubState(entity, SUBSTATE_LAND);
                            timer.ResetSeconds(1f);

                            DetonateFireGrids(entity);
                        }
                        break;
                    case SUBSTATE_LAND:
                        {
                            var position = entity.Position;
                            position.x = Ticks.SmoothDamp(position.x, GetJumpBorderX(entity), 0.2f);
                            entity.Position = position;
                            entity.Velocity = Ticks.SmoothDamp(entity.Velocity, Vector3.zero, 0.2f);

                            LandCrush(entity);

                            if (timer.Expired)
                            {
                                stateMachine.StartState(entity, STATE_TAIL_SWIPE);
                                var swipeSubstate = TailSwipeState.GetRandomReadySubstate(entity.RNG);
                                stateMachine.StartSubState(entity, swipeSubstate);
                                SetRotation(entity, 180);
                            }
                        }
                        break;
                }
            }
            private void ShootBreath(Entity entity)
            {
                var fireVariant = GetFireVariant(entity);
                var param = entity.GetSpawnParams();
                param.SetProperty(VanillaEntityProps.DAMAGE, entity.GetDamage() * FIRE_BREATH_DAMAGE_MULTIPLIER);
                param.SetProperty(VanillaEntityProps.VARIANT, fireVariant);
                param.SetProperty(VanillaEntityProps.MAX_TIMEOUT, 30);
                var source = GetNeckRootPosition(entity);
                var direction = new Vector3(entity.GetFacingX() * 0.3f, -1).normalized;
                var position = source + entity.GetFacingDirection() * NECK_LENGTH;
                entity.Spawn(VanillaEffectID.dragonFireBreath, position, param)?.Let(e =>
                {
                    e.Velocity = direction * FIRE_BREATH_SPEED * 5;
                });
            }
            private void DetonateFireGrids(Entity entity)
            {
                var level = entity.Level;
                float radius = level.GetRedDragonFireExplosionRadius();
                foreach (var fire in level.FindEntities(e => e.IsEntityOf(VanillaEffectID.gridFire) && entity.IsFriendly(entity)))
                {
                    var center = fire.GetCenter();
                    var damage = entity.GetDamage() * FIRE_EXPLOSION_DAMAGE_MULTIPLIER;
                    var damageEffects = new DamageEffectList(VanillaDamageEffects.EXPLOSION, VanillaDamageEffects.FIRE);
                    fire.Explode(center, radius, entity.GetFaction(), damage, damageEffects);
                    Explosion.Spawn(fire, center, radius)?.Let(e =>
                    {
                        e.SetTint(Color.red);
                    });
                    entity.PlaySound(VanillaSoundID.explosion);
                    entity.PlaySound(VanillaSoundID.impact);
                }
            }
            public const int SUBSTATE_START = 0;
            public const int SUBSTATE_FLY = 1;
            public const int SUBSTATE_GLIDE = 2;
            public const int SUBSTATE_GLIDE_BACK = 3;
            public const int SUBSTATE_LAND = 4;
            public const int ANIMATION_SUBSTATE_START = 0;
            public const int ANIMATION_SUBSTATE_FLY = 1;
            public const int ANIMATION_SUBSTATE_GLIDE = 2;
            public const int ANIMATION_SUBSTATE_LAND = 3;
        }
        #endregion

        #region 扫尾
        private class TailSwipeState : EntityStateMachineState
        {
            public TailSwipeState() : base(STATE_TAIL_SWIPE, ANIMATION_STATE_TAIL_SWIPE) { }
            public override int GetAnimationSubstate(int substate)
            {
                switch (substate)
                {
                    case SUBSTATE_CLOCKWISE_READY:
                        return ANIMATION_SUBSTATE_CLOCKWISE_READY;
                    case SUBSTATE_COUNTERCLOCKWISE_READY:
                        return ANIMATION_SUBSTATE_COUNTERCLOCKWISE_READY;
                    case SUBSTATE_CLOCKWISE:
                        return ANIMATION_SUBSTATE_CLOCKWISE;
                    case SUBSTATE_COUNTERCLOCKWISE:
                        return ANIMATION_SUBSTATE_COUNTERCLOCKWISE;
                }
                return base.GetAnimationSubstate(substate);
            }
            public override void OnEnter(EntityStateMachine stateMachine, Entity entity)
            {
                base.OnEnter(stateMachine, entity);
                var substateTimer = stateMachine.GetSubStateTimer(entity);
                substateTimer.ResetSeconds(2 / 3f);
            }
            public override void OnExit(EntityStateMachine machine, Entity entity)
            {
                base.OnExit(machine, entity);
                SetRotation(entity, (GetRotation(entity) + 180) % 360);
            }
            public override void OnUpdateAI(EntityStateMachine stateMachine, Entity entity)
            {
                base.OnUpdateAI(stateMachine, entity);
                var substate = stateMachine.GetSubState(entity);
                var timer = stateMachine.GetSubStateTimer(entity);
                timer.Run(stateMachine.GetSpeed(entity));
                switch (substate)
                {
                    case SUBSTATE_CLOCKWISE_READY:
                        if (timer.Expired)
                        {
                            stateMachine.StartSubState(entity, SUBSTATE_CLOCKWISE);
                            timer.ResetSeconds(1f);

                            entity.PlaySound(VanillaSoundID.fling);
                        }
                        break;
                    case SUBSTATE_COUNTERCLOCKWISE_READY:
                        if (timer.Expired)
                        {
                            stateMachine.StartSubState(entity, SUBSTATE_COUNTERCLOCKWISE);
                            timer.ResetSeconds(1f);

                            entity.PlaySound(VanillaSoundID.fling);
                        }
                        break;
                    case SUBSTATE_CLOCKWISE:
                        if (timer.PassedSecondsFromMax(0.1f))
                        {
                            Swipe(entity, -1);
                        }
                        if (timer.Expired)
                        {
                            stateMachine.StartState(entity, STATE_IDLE);
                        }
                        break;
                    case SUBSTATE_COUNTERCLOCKWISE:
                        if (timer.PassedSecondsFromMax(0.1f))
                        {
                            Swipe(entity, 1);
                        }
                        if (timer.Expired)
                        {
                            stateMachine.StartState(entity, STATE_IDLE);
                        }
                        break;
                }
            }
            public override void OnUpdateLogic(EntityStateMachine machine, Entity entity)
            {
                base.OnUpdateLogic(machine, entity);
                CheckDeath(entity);
            }
            private void Swipe(Entity entity, int laneDirection)
            {
                var level = entity.Level;
                var column = entity.GetColumn();
                var lane = entity.GetLane();
                var columnDirection = entity.IsFacingLeft() ? -1 : 1;
                var column2 = column + columnDirection * TAIL_SWIPE_COLUMN_RANGE;
                var minColumn = Mathf.Min(column, column2);
                var maxColumn = Mathf.Max(column, column2);
                for (int x = minColumn; x < maxColumn; x++)
                {
                    for (int z = lane + TAIL_SWIPE_LANE_RANGE_START; z <= lane + TAIL_SWIPE_LANE_RANGE_END; z++)
                    {
                        var grid = level.GetGrid(x, z);
                        if (grid == null)
                            continue;
                        foreach (var gridEntity in grid.GetEntities())
                        {
                            if (gridEntity.Type != EntityTypes.PLANT || !entity.IsHostile(gridEntity))
                                continue;
                            var targetLane = z + laneDirection;
                            var targetGrid = level.GetGrid(x, targetLane);
                            if (targetGrid == null)
                            {
                                gridEntity.Die(new DamageEffectList(VanillaDamageEffects.OUT_OF_BOUND), entity);
                            }
                            else
                            {
                                gridEntity.StartChangingGrid(x, targetLane);
                            }
                            gridEntity.PlaySound(VanillaSoundID.punch, 0.75f);
                        }
                    }
                }
            }
            public static int GetRandomReadySubstate(RandomGenerator rng)
            {
                return rng.Next(2) == 1 ? SUBSTATE_COUNTERCLOCKWISE_READY : SUBSTATE_CLOCKWISE_READY;
            }
            public const int SUBSTATE_CLOCKWISE_READY = 0;
            public const int SUBSTATE_COUNTERCLOCKWISE_READY = 1;
            public const int SUBSTATE_CLOCKWISE = 2;
            public const int SUBSTATE_COUNTERCLOCKWISE = 3;
            public const int ANIMATION_SUBSTATE_CLOCKWISE_READY = 0;
            public const int ANIMATION_SUBSTATE_COUNTERCLOCKWISE_READY = 1;
            public const int ANIMATION_SUBSTATE_CLOCKWISE = 2;
            public const int ANIMATION_SUBSTATE_COUNTERCLOCKWISE = 3;
        }
        #endregion

        public const float FIRE_BREATH_ANGLE_START = -30;
        public const float FIRE_BREATH_ANGLE_END = 30;
        private static RedDragonStateMachine stateMachine = new RedDragonStateMachine();
        private static RedDragonEatDetector eatDetector = new RedDragonEatDetector();
        private static int[] statePoolPhase1 = new int[]
        {
            STATE_SPIT,
            STATE_FLAP_WINGS,
            STATE_EAT,
            STATE_JUMP
        };
        private static int[] statePoolPhase2 = new int[]
        {
            STATE_LARGE_FIREBALL,
            STATE_FLAP_WINGS,
            STATE_SPIT_UP,
            STATE_FLY,
            STATE_JUMP
        };
    }
}