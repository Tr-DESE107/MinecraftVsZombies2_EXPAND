#nullable enable // autogenerated

using MVZ2.GameContent.Projectiles;
using MVZ2.Vanilla.Audios;
using MVZ2.Vanilla.Entities;
using PVZEngine;
using PVZEngine.Entities;
using UnityEngine;

namespace MVZ2.GameContent.Bosses
{
    public partial class RedDragon
    {
        #region 状态机
        private class RedDragonStateMachine : EntityStateMachine
        {
            public RedDragonStateMachine()
            {
                AddState(new IdleState());
                AddState(new SpitState());
            }
        }
        #endregion

        #region 状态池
        private class RedDragonStatePoolPhase1 : StateMachineStatePool
        {
            protected override int[] GetStates()
            {
                return states;
            }
            protected override bool CanStartState(Entity entity, int state)
            {
                return base.CanStartState(entity, state);
            }
            private static int[] states = new int[]
            {
                STATE_SPIT
            };
        }
        #endregion

        private static void CheckDeath(Entity entity)
        {
            if (!entity.IsDead)
                return;
            stateMachine.StartState(entity, STATE_DEATH);
        }

        #region 状态
        private class IdleState : EntityStateMachineState
        {
            public IdleState() : base(STATE_IDLE, ANIMATION_STATE_IDLE) { }
            public override void OnEnter(EntityStateMachine stateMachine, Entity entity)
            {
                base.OnEnter(stateMachine, entity);
                var stateTimer = stateMachine.GetStateTimer(entity);
                stateTimer.ResetSeconds(2f);
            }
            public override void OnUpdateAI(EntityStateMachine stateMachine, Entity entity)
            {
                base.OnUpdateAI(stateMachine, entity);
                UpdateStateSwitch(stateMachine, entity);
            }
            public override void OnUpdateLogic(EntityStateMachine machine, Entity entity)
            {
                base.OnUpdateLogic(machine, entity);
                CheckDeath(entity);
            }
            private void UpdateStateSwitch(EntityStateMachine stateMachine, Entity entity)
            {
                var stateTimer = stateMachine.GetStateTimer(entity);
                stateTimer.Run(stateMachine.GetSpeed(entity));
                if (stateTimer.Expired)
                {
                    StateMachineStatePool pool = GetPhase(entity) == PHASE_2 ? statePoolPhase2 : statePoolPhase1;
                    var index = stateMachine.GetPreviousState(entity);
                    index = pool.NextIndex(entity, index);
                    if (index >= 0)
                    {
                        stateMachine.SetPreviousState(entity, index);

                        var state = pool.GetState(index);
                        stateMachine.StartState(entity, state);
                    }
                    else
                    {
                        stateTimer.Reset();
                    }
                }
            }
        }
        private class SpitState : EntityStateMachineState
        {
            public SpitState() : base(STATE_SPIT, ANIMATION_STATE_SPIT) { }
            public override int GetAnimationSubstate(int substate)
            {
                switch (substate)
                {
                    case SUBSTATE_START:
                        return ANIMATION_SUBSTATE_START;
                    case SUBSTATE_SPIT_1:
                    case SUBSTATE_SPIT_2:
                    case SUBSTATE_SPIT_3:
                        return ANIMATION_SUBSTATE_SPIT;
                    case SUBSTATE_END:
                        return ANIMATION_SUBSTATE_END;
                }
                return base.GetAnimationSubstate(substate);
            }
            public override void OnEnter(EntityStateMachine stateMachine, Entity entity)
            {
                base.OnEnter(stateMachine, entity);
                var substateTimer = stateMachine.GetSubStateTimer(entity);
                substateTimer.ResetSeconds(1f);
            }
            public override void OnUpdateAI(EntityStateMachine stateMachine, Entity entity)
            {
                base.OnUpdateAI(stateMachine, entity);
                var substate = stateMachine.GetSubState(entity);
                var timer = stateMachine.GetSubStateTimer(entity);
                timer.Run(stateMachine.GetSpeed(entity));
                switch (substate)
                {
                    case SUBSTATE_START:
                        if (timer.Expired)
                        {
                            ShootFireball(entity);
                            stateMachine.StartSubState(entity, SUBSTATE_SPIT_1);
                            timer.ResetSeconds(0.2f);
                        }
                        break;
                    case SUBSTATE_SPIT_1:
                        if (timer.Expired)
                        {
                            ShootFireball(entity);
                            stateMachine.StartSubState(entity, SUBSTATE_SPIT_2);
                            timer.ResetSeconds(0.2f);
                        }
                        break;
                    case SUBSTATE_SPIT_2:
                        if (timer.Expired)
                        {
                            ShootFireball(entity);
                            stateMachine.StartSubState(entity, SUBSTATE_SPIT_3);
                            timer.ResetSeconds(0.2f);
                        }
                        break;
                    case SUBSTATE_SPIT_3:
                        if (timer.Expired)
                        {
                            stateMachine.StartSubState(entity, SUBSTATE_END);
                            timer.ResetSeconds(0.5f);
                        }
                        break;
                    case SUBSTATE_END:
                        if (timer.Expired)
                        {
                            stateMachine.StartState(entity, STATE_IDLE);
                        }
                        break;
                }
            }
            public override void OnUpdateLogic(EntityStateMachine machine, Entity entity)
            {
                base.OnUpdateLogic(machine, entity);
                CheckDeath(entity);
            }

            private void ShootFireball(Entity entity)
            {
                var param = entity.GetShootParams();
                param.projectileID = VanillaProjectileID.fireCharge;
                param.velocity = entity.GetFacingDirection() * 20;
                param.position = entity.Position + entity.GetFacingDirection() * 400 + Vector3.up * 40;
                param.soundID = VanillaSoundID.fireCharge;
                param.damage = entity.GetDamage() * 1;
                entity.ShootProjectile(param);
            }
            public const int SUBSTATE_START = 0;
            public const int SUBSTATE_SPIT_1 = 1;
            public const int SUBSTATE_SPIT_2 = 2;
            public const int SUBSTATE_SPIT_3 = 3;
            public const int SUBSTATE_END = 4;
            public const int ANIMATION_SUBSTATE_START = 0;
            public const int ANIMATION_SUBSTATE_SPIT = 1;
            public const int ANIMATION_SUBSTATE_END = 2;

        }
        #endregion


        private static RedDragonStateMachine stateMachine = new RedDragonStateMachine();
        private static RedDragonStatePoolPhase1 statePoolPhase1 = new RedDragonStatePoolPhase1();
        private static RedDragonStatePoolPhase1 statePoolPhase2 = new RedDragonStatePoolPhase1();
    }

    public abstract class StateMachineStatePool
    {
        public StateMachineStatePool()
        {
        }

        public int NextIndex(Entity entity, int currentIndex)
        {
            var states = GetStates();
            var length = states.Length;
            if (length <= 0)
                return -1;
            if (currentIndex < 0)
            {
                currentIndex = 0;
            }
            for (int i = 0; i < length; i++)
            {
                var index = (currentIndex + i + 1) % length;
                var state = states[index];
                if (!CanStartState(entity, state))
                    continue;
                return index;
            }
            return -1;
        }
        public int GetState(int currentIndex)
        {
            var states = GetStates();
            if (currentIndex < 0 || currentIndex >= states.Length)
            {
                return 0;
            }
            return states[currentIndex];
        }
        protected abstract int[] GetStates();
        protected virtual bool CanStartState(Entity entity, int state)
        {
            return true;
        }
    }
}