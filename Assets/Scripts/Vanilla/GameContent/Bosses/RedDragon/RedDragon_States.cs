#nullable enable // autogenerated

using System.Collections.Generic;
using System.Linq;
using MVZ2.GameContent.Damages;
using MVZ2.GameContent.Detections;
using MVZ2.GameContent.Effects;
using MVZ2.GameContent.Projectiles;
using MVZ2.Vanilla.Audios;
using MVZ2.Vanilla.Entities;
using MVZ2.Vanilla.Level;
using MVZ2Logic.Level;
using PVZEngine;
using PVZEngine.Damages;
using PVZEngine.Entities;
using PVZEngine.Level;
using Tools;
using UnityEngine;
using UnityEngine.UIElements;

namespace MVZ2.GameContent.Bosses
{
    public partial class RedDragon
    {
        #region 状态机
        private class RedDragonStateMachine : EntityStateMachine
        {
            public RedDragonStateMachine()
            {
                AddState(new IdleState());
                AddState(new JumpState());
                AddState(new SpitState());
                AddState(new FlapWingsState());
            }
        }
        #endregion

        #region 状态池
        private class RedDragonStatePoolPhase1 : StateMachineStatePool
        {
            protected override int[] GetStates()
            {
                return states;
            }
            protected override bool CanStartState(Entity entity, int state)
            {
                switch (state)
                {
                    case STATE_SPIT:
                    case STATE_FLAP_WINGS:
                        if (!entity.Level.EntityExists(e => entity.IsHostile(e) && e.IsVulnerableEntity()))
                            return false;
                        break;
                }
                return base.CanStartState(entity, state);
            }
            private static int[] states = new int[]
            {
                STATE_SPIT,
                STATE_FLAP_WINGS,
                STATE_JUMP
            };
        }
        #endregion

        private static void CheckDeath(Entity entity)
        {
            if (!entity.IsDead)
                return;
            stateMachine.StartState(entity, STATE_DEATH);
        }
        private static bool HasEnemiesInTheLane(Entity entity)
        {
            var lane = entity.GetLane();
            return entity.Level.EntityExists(e => e.GetLane() == lane && entity.IsHostile(e) && e.IsVulnerableEntity());
        }
        #region 待命
        private class IdleState : EntityStateMachineState
        {
            public IdleState() : base(STATE_IDLE, ANIMATION_STATE_IDLE) { }
            public override void OnEnter(EntityStateMachine stateMachine, Entity entity)
            {
                base.OnEnter(stateMachine, entity);
                var stateTimer = stateMachine.GetStateTimer(entity);
                stateTimer.ResetSeconds(2f);
            }
            public override void OnUpdateAI(EntityStateMachine stateMachine, Entity entity)
            {
                base.OnUpdateAI(stateMachine, entity);
                UpdateStateSwitch(stateMachine, entity);
            }
            public override void OnUpdateLogic(EntityStateMachine machine, Entity entity)
            {
                base.OnUpdateLogic(machine, entity);
                CheckDeath(entity);
            }
            private void UpdateStateSwitch(EntityStateMachine stateMachine, Entity entity)
            {
                var stateTimer = stateMachine.GetStateTimer(entity);
                stateTimer.Run(stateMachine.GetSpeed(entity));
                if (stateTimer.Expired)
                {
                    StateMachineStatePool pool = GetPhase(entity) == PHASE_2 ? statePoolPhase2 : statePoolPhase1;
                    var nextIndex = stateMachine.GetNextStateIndex(entity);
                    nextIndex = pool.FindNextStateIndex(entity, nextIndex);
                    if (nextIndex >= 0)
                    {
                        var state = pool.GetState(nextIndex);
                        stateMachine.SetNextStateIndex(entity, nextIndex + 1);
                        switch (state)
                        {
                            case STATE_SPIT:
                            case STATE_FLAP_WINGS:
                                if (HasEnemiesInTheLane(entity))
                                {
                                    stateMachine.StartState(entity, state);
                                }
                                else
                                {
                                    var jumpTarget = FindEnemyJumpTargetPosition(entity);
                                    JumpTo(entity, jumpTarget, state);
                                }
                                break;
                            case STATE_JUMP:
                                {
                                    var jumpTarget = FindRandomJumpTargetPosition(entity);
                                    JumpTo(entity, jumpTarget, STATE_IDLE);
                                }
                                break;
                        }
                    }
                    else
                    {
                        stateTimer.Reset();
                    }
                }
            }
        }
        #endregion

        #region 跳跃
        private static void JumpTo(Entity entity, Vector3 jumpTarget, int state)
        {
            SetJumpFinishState(entity, state);
            SetJumpTarget(entity, jumpTarget);
            stateMachine.StartState(entity, STATE_JUMP);
        }
        private static float GetJumpBorderX(Entity boss)
        {
            if (boss.IsFacingLeft())
            {
                return VanillaLevelExt.RIGHT_BORDER + 80;
            }
            else
            {
                return VanillaLevelExt.LEFT_BORDER - 80;
            }
        }
        private static int[] FindLanesWithEnemies(Entity boss)
        {
            var entities = boss.Level.FindEntities(e => e.IsVulnerableEntity() && boss.IsHostile(e));
            return entities.Select(e => e.GetLane()).Distinct().ToArray();
        }
        private static Vector3 FindEnemyJumpTargetPosition(Entity boss)
        {
            float x = GetJumpBorderX(boss);

            var lanes = FindLanesWithEnemies(boss);
            var rng = boss.RNG;
            var lane = lanes.Random(rng);

            var z = boss.Level.GetEntityLaneZ(lane);
            var y = boss.Level.GetGroundY(x, z);
            return new Vector3(x, y, z);
        }
        private static Vector3 FindRandomJumpTargetPosition(Entity boss)
        {
            float x = GetJumpBorderX(boss);
            var currentLane = boss.GetLane();
            var lane = boss.RNG.Next(boss.Level.GetMaxLaneCount() - 1); // 自己的一行不算
            if (lane >= currentLane)
            {
                // 如果获取到的行数大于或等于该实体目前的行数，则目标行数+1。
                lane++;
            }
            var z = boss.Level.GetEntityLaneZ(lane);
            var y = boss.Level.GetGroundY(x, z);
            return new Vector3(x, y, z);
        }

        private class JumpState : EntityStateMachineState
        {
            public JumpState() : base(STATE_JUMP, ANIMATION_STATE_JUMP) { }
            public override int GetAnimationSubstate(int substate)
            {
                switch (substate)
                {
                    case SUBSTATE_START:
                        return ANIMATION_SUBSTATE_START;
                    case SUBSTATE_FALL:
                        return ANIMATION_SUBSTATE_FALL;
                    case SUBSTATE_END:
                        return ANIMATION_SUBSTATE_END;
                }
                return base.GetAnimationSubstate(substate);
            }
            public override void OnEnter(EntityStateMachine stateMachine, Entity entity)
            {
                base.OnEnter(stateMachine, entity);
                var substateTimer = stateMachine.GetSubStateTimer(entity);
                substateTimer.ResetSeconds(1 / 6f);
            }
            public override void OnUpdateAI(EntityStateMachine stateMachine, Entity entity)
            {
                base.OnUpdateAI(stateMachine, entity);
                var substate = stateMachine.GetSubState(entity);
                var timer = stateMachine.GetSubStateTimer(entity);
                timer.Run(stateMachine.GetSpeed(entity));
                switch (substate)
                {
                    case SUBSTATE_START:
                        if (timer.Expired)
                        {
                            StartJump(entity);
                            stateMachine.StartSubState(entity, SUBSTATE_FALL);
                        }
                        break;
                    case SUBSTATE_FALL:
                        {
                            Vector3 target = GetJumpTarget(entity);
                            var pos = entity.Position;
                            pos.x = pos.x * 0.8f + target.x * 0.2f;
                            pos.z = pos.z * 0.8f + target.z * 0.2f;
                            entity.Position = pos;
                            if (entity.IsOnGround)
                            {
                                Land(entity);
                                stateMachine.StartSubState(entity, SUBSTATE_END);
                                timer.ResetSeconds(0.5f);
                            }
                        }
                        break;
                    case SUBSTATE_END:
                        if (timer.Expired)
                        {
                            var finishState = GetJumpFinishState(entity);
                            SetJumpFinishState(entity, -1);
                            if (finishState < 0)
                            {
                                finishState = STATE_IDLE;
                            }
                            stateMachine.StartState(entity, finishState);
                        }
                        break;
                }
            }
            public override void OnUpdateLogic(EntityStateMachine machine, Entity entity)
            {
                base.OnUpdateLogic(machine, entity);
                CheckDeath(entity);
            }
            private void StartJump(Entity boss)
            {
                Vector3 velocity = boss.Velocity;
                velocity.y = boss.GetGravity() * Ticks.FromSeconds(jumpFlyingSeconds) / 2f;
                boss.Velocity = velocity;
            }
            private void Land(Entity entity)
            {
                var level = entity.Level;
                landBuffer.Clear();
                landDetector.DetectMultiple(entity, landBuffer);
                foreach (IEntityCollider collider in landBuffer)
                {
                    var ent = collider.Entity;
                    var damageOutput = collider.TakeDamage(ent.GetTakenCrushDamage(), new DamageEffectList(VanillaDamageEffects.IMPACT, VanillaDamageEffects.IGNORE_ARMOR), entity);
                    if (ent.Type == EntityTypes.PLANT)
                    {
                        if (damageOutput?.BodyResult?.Fatal ?? false)
                        {
                            entity.PlaySound(VanillaSoundID.smash);
                        }
                    }
                }
                level.ShakeScreen(5, 0, 15);
                entity.PlaySound(VanillaSoundID.thump);
            }
            public const int SUBSTATE_START = 0;
            public const int SUBSTATE_FALL = 1;
            public const int SUBSTATE_END = 2;
            public const int ANIMATION_SUBSTATE_START = 0;
            public const int ANIMATION_SUBSTATE_FALL = 1;
            public const int ANIMATION_SUBSTATE_END = 2;

            private CollisionDetector landDetector = new CollisionDetector();
            private List<IEntityCollider> landBuffer = new List<IEntityCollider>();
            private const float jumpFlyingSeconds = 0.5f;
        }
        #endregion

        #region 喷吐火球
        private class SpitState : EntityStateMachineState
        {
            public SpitState() : base(STATE_SPIT, ANIMATION_STATE_SPIT) { }
            public override int GetAnimationSubstate(int substate)
            {
                switch (substate)
                {
                    case SUBSTATE_START:
                        return ANIMATION_SUBSTATE_START;
                    case SUBSTATE_SPIT_1:
                    case SUBSTATE_SPIT_2:
                    case SUBSTATE_SPIT_3:
                        return ANIMATION_SUBSTATE_SPIT;
                    case SUBSTATE_END:
                        return ANIMATION_SUBSTATE_END;
                }
                return base.GetAnimationSubstate(substate);
            }
            public override void OnEnter(EntityStateMachine stateMachine, Entity entity)
            {
                base.OnEnter(stateMachine, entity);
                var substateTimer = stateMachine.GetSubStateTimer(entity);
                substateTimer.ResetSeconds(1f);
            }
            public override void OnUpdateAI(EntityStateMachine stateMachine, Entity entity)
            {
                base.OnUpdateAI(stateMachine, entity);
                var substate = stateMachine.GetSubState(entity);
                var timer = stateMachine.GetSubStateTimer(entity);
                timer.Run(stateMachine.GetSpeed(entity));
                switch (substate)
                {
                    case SUBSTATE_START:
                        if (timer.Expired)
                        {
                            ShootFireball(entity);
                            stateMachine.StartSubState(entity, SUBSTATE_SPIT_1);
                            timer.ResetSeconds(0.2f);
                        }
                        break;
                    case SUBSTATE_SPIT_1:
                        if (timer.Expired)
                        {
                            ShootFireball(entity);
                            stateMachine.StartSubState(entity, SUBSTATE_SPIT_2);
                            timer.ResetSeconds(0.2f);
                        }
                        break;
                    case SUBSTATE_SPIT_2:
                        if (timer.Expired)
                        {
                            ShootFireball(entity);
                            stateMachine.StartSubState(entity, SUBSTATE_SPIT_3);
                            timer.ResetSeconds(0.2f);
                        }
                        break;
                    case SUBSTATE_SPIT_3:
                        if (timer.Expired)
                        {
                            stateMachine.StartSubState(entity, SUBSTATE_END);
                            timer.ResetSeconds(0.5f);
                        }
                        break;
                    case SUBSTATE_END:
                        if (timer.Expired)
                        {
                            stateMachine.StartState(entity, STATE_IDLE);
                        }
                        break;
                }
            }
            public override void OnUpdateLogic(EntityStateMachine machine, Entity entity)
            {
                base.OnUpdateLogic(machine, entity);
                CheckDeath(entity);
            }

            private void ShootFireball(Entity entity)
            {
                var param = entity.GetShootParams();
                param.projectileID = VanillaProjectileID.fireCharge;
                param.velocity = entity.GetFacingDirection() * 20;
                param.position = GetSpitSourcePosition(entity);
                param.soundID = VanillaSoundID.fireCharge;
                param.damage = entity.GetDamage() * 1;
                entity.ShootProjectile(param);
            }
            public const int SUBSTATE_START = 0;
            public const int SUBSTATE_SPIT_1 = 1;
            public const int SUBSTATE_SPIT_2 = 2;
            public const int SUBSTATE_SPIT_3 = 3;
            public const int SUBSTATE_END = 4;
            public const int ANIMATION_SUBSTATE_START = 0;
            public const int ANIMATION_SUBSTATE_SPIT = 1;
            public const int ANIMATION_SUBSTATE_END = 2;

        }
        #endregion

        #region 扇风
        private class FlapWingsState : EntityStateMachineState
        {
            public FlapWingsState() : base(STATE_FLAP_WINGS, STATE_FLAP_WINGS) { }
            public override void OnEnter(EntityStateMachine stateMachine, Entity entity)
            {
                base.OnEnter(stateMachine, entity);
                var substateTimer = stateMachine.GetSubStateTimer(entity);
                substateTimer.ResetSeconds(2 / 3f);
            }
            public override void OnUpdateAI(EntityStateMachine stateMachine, Entity entity)
            {
                base.OnUpdateAI(stateMachine, entity);
                var substate = stateMachine.GetSubState(entity);
                var timer = stateMachine.GetSubStateTimer(entity);
                timer.Run(stateMachine.GetSpeed(entity));
                switch (substate)
                {
                    case SUBSTATE_START:
                        if (timer.Expired)
                        {
                            entity.PlaySound(VanillaSoundID.dragonWings);
                            stateMachine.StartSubState(entity, SUBSTATE_FLAP_1);
                            timer.ResetSeconds(1f);
                        }
                        break;
                    case SUBSTATE_FLAP_1:
                        if (timer.Expired)
                        {
                            entity.PlaySound(VanillaSoundID.dragonWings);
                            stateMachine.StartSubState(entity, SUBSTATE_FLAP_2);
                            timer.ResetSeconds(1f);
                        }
                        break;
                    case SUBSTATE_FLAP_2:
                        if (timer.Expired)
                        {
                            entity.PlaySound(VanillaSoundID.dragonGrowl);
                            entity.PlaySound(VanillaSoundID.dragonWings);
                            entity.Level.ShakeScreen(10, 0, 15);
                            ShootTornado(entity);
                            stateMachine.StartSubState(entity, SUBSTATE_END);
                            timer.ResetSeconds(7 / 12f);
                        }
                        break;
                    case SUBSTATE_END:
                        if (timer.Expired)
                        {
                            stateMachine.StartState(entity, STATE_IDLE);
                        }
                        break;
                }
            }
            public override void OnUpdateLogic(EntityStateMachine machine, Entity entity)
            {
                base.OnUpdateLogic(machine, entity);
                CheckDeath(entity);
            }

            private void ShootTornado(Entity entity)
            {
                var param = entity.GetSpawnParams();
                param.SetProperty(VanillaEntityProps.DAMAGE, entity.GetDamage() * 0.05f);
                var position = GetTornadoSourcePosition(entity);
                entity.Spawn(VanillaEffectID.tornado, position, param)?.Let(e =>
                {
                    e.Velocity = entity.GetFacingDirection() * 2;
                });
            }
            public const int SUBSTATE_START = 0;
            public const int SUBSTATE_FLAP_1 = 1;
            public const int SUBSTATE_FLAP_2 = 2;
            public const int SUBSTATE_END = 3;

        }
        #endregion


        private static RedDragonStateMachine stateMachine = new RedDragonStateMachine();
        private static RedDragonStatePoolPhase1 statePoolPhase1 = new RedDragonStatePoolPhase1();
        private static RedDragonStatePoolPhase1 statePoolPhase2 = new RedDragonStatePoolPhase1();
    }
}