#nullable enable // autogenerated

using System.Collections.Generic;
using System.Linq;
using MVZ2.GameContent.Damages;
using MVZ2.GameContent.Detections;
using MVZ2.GameContent.Effects;
using MVZ2.GameContent.Projectiles;
using MVZ2.Vanilla.Audios;
using MVZ2.Vanilla.Entities;
using MVZ2.Vanilla.Level;
using MVZ2Logic.Level;
using PVZEngine;
using PVZEngine.Damages;
using PVZEngine.Entities;
using PVZEngine.Level;
using Tools;
using UnityEngine;
using UnityEngine.UIElements;

namespace MVZ2.GameContent.Bosses
{
    public partial class RedDragon
    {
        #region 状态机
        private class RedDragonStateMachine : EntityStateMachine
        {
            public RedDragonStateMachine()
            {
                AddState(new IdleState());
                AddState(new JumpState());
                AddState(new SpitState());
                AddState(new FlapWingsState());
                AddState(new EatState());
                AddState(new FireBreathState());
            }
        }
        #endregion

        private static void CheckDeath(Entity entity)
        {
            if (!entity.IsDead)
                return;
            stateMachine.StartState(entity, STATE_DEATH);
        }
        private static bool HasEnemiesInTheLane(Entity entity)
        {
            var lane = entity.GetLane();
            return entity.Level.EntityExists(e => e.GetLane() == lane && entity.IsHostile(e) && e.IsVulnerableEntity());
        }
        #region 待命
        private static bool CanSwitchStatePhase1(Entity entity, int state)
        {
            switch (state)
            {
                case STATE_SPIT:
                case STATE_FLAP_WINGS:
                    if (!entity.Level.EntityExists(e => entity.IsHostile(e) && e.IsVulnerableEntity()))
                        return false;
                    break;
            }
            return true;
        }
        private static bool CanSwitchStatePhase2(Entity entity, int state)
        {
            return true;
        }
        private static void SwitchState(Entity entity, int state)
        {
            switch (state)
            {
                case STATE_SPIT:
                case STATE_FLAP_WINGS:
                    if (HasEnemiesInTheLane(entity))
                    {
                        stateMachine.StartState(entity, state);
                    }
                    else
                    {
                        var jumpTarget = FindEnemyJumpTargetPosition(entity);
                        JumpTo(entity, jumpTarget, state);
                    }
                    break;
                case STATE_EAT:
                    {
                        var middleLane = entity.Level.GetMaxLaneCount() / 2;
                        // 没有可吃的目标，直接喷火。
                        if (!HasEatableTargets(entity))
                        {
                            state = STATE_FIRE_BREATH;
                        }
                        if (entity.GetLane() == middleLane)
                        {
                            stateMachine.StartState(entity, state);
                        }
                        else
                        {
                            var jumpTarget = GetJumpBorderPositionByLane(entity, middleLane);
                            JumpTo(entity, jumpTarget, state);
                        }
                    }
                    break;
                case STATE_JUMP:
                    {
                        var jumpTarget = FindRandomJumpTargetPosition(entity);
                        JumpTo(entity, jumpTarget, STATE_IDLE);
                    }
                    break;
            }
        }
        private class IdleState : EntityStateMachineState
        {
            public IdleState() : base(STATE_IDLE, ANIMATION_STATE_IDLE) { }
            public override void OnEnter(EntityStateMachine stateMachine, Entity entity)
            {
                base.OnEnter(stateMachine, entity);
                var stateTimer = stateMachine.GetStateTimer(entity);
                stateTimer.ResetSeconds(2f);
            }
            public override void OnUpdateAI(EntityStateMachine stateMachine, Entity entity)
            {
                base.OnUpdateAI(stateMachine, entity);
                UpdateStateSwitch(stateMachine, entity);
            }
            public override void OnUpdateLogic(EntityStateMachine machine, Entity entity)
            {
                base.OnUpdateLogic(machine, entity);
                CheckDeath(entity);
            }
            private void UpdateStateSwitch(EntityStateMachine stateMachine, Entity entity)
            {
                var stateTimer = stateMachine.GetStateTimer(entity);
                stateTimer.Run(stateMachine.GetSpeed(entity));
                if (stateTimer.Expired)
                {
                    var nextIndex = stateMachine.GetNextStateIndex(entity);
                    int[] pool;
                    if (GetPhase(entity) == PHASE_1)
                    {
                        pool = statePoolPhase1;
                        nextIndex = pool.FindNextStateIndex(nextIndex, state => CanSwitchStatePhase1(entity, state));
                    }
                    else
                    {
                        pool = statePoolPhase2;
                        nextIndex = pool.FindNextStateIndex(nextIndex, state => CanSwitchStatePhase2(entity, state));
                    }
                    if (nextIndex >= 0)
                    {
                        var state = pool[nextIndex];
                        stateMachine.SetNextStateIndex(entity, nextIndex + 1);
                        SwitchState(entity, state);
                    }
                    else
                    {
                        stateTimer.Reset();
                    }
                }
            }
        }
        #endregion

        #region 跳跃
        private static void JumpTo(Entity entity, Vector3 jumpTarget, int state)
        {
            SetJumpFinishState(entity, state);
            SetJumpTarget(entity, jumpTarget);
            stateMachine.StartState(entity, STATE_JUMP);
        }
        private static float GetJumpBorderX(Entity boss)
        {
            if (boss.IsFacingLeft())
            {
                return VanillaLevelExt.RIGHT_BORDER + 80;
            }
            else
            {
                return VanillaLevelExt.LEFT_BORDER - 80;
            }
        }
        private static Vector3 GetJumpBorderPositionByLane(Entity boss, int lane)
        {
            float x = GetJumpBorderX(boss);
            var z = boss.Level.GetEntityLaneZ(lane);
            var y = boss.Level.GetGroundY(x, z);
            return new Vector3(x, y, z);
        }
        private static int[] FindLanesWithEnemies(Entity boss)
        {
            var entities = boss.Level.FindEntities(e => e.IsVulnerableEntity() && boss.IsHostile(e));
            return entities.Select(e => e.GetLane()).Distinct().ToArray();
        }
        private static Vector3 FindEnemyJumpTargetPosition(Entity boss)
        {
            var lanes = FindLanesWithEnemies(boss);
            var rng = boss.RNG;
            var lane = lanes.Random(rng);

            return GetJumpBorderPositionByLane(boss, lane);
        }
        private static Vector3 FindRandomJumpTargetPosition(Entity boss)
        {
            var currentLane = boss.GetLane();
            var lane = boss.RNG.Next(boss.Level.GetMaxLaneCount() - 1); // 自己的一行不算
            if (lane >= currentLane)
            {
                // 如果获取到的行数大于或等于该实体目前的行数，则目标行数+1。
                lane++;
            }
            return GetJumpBorderPositionByLane(boss, lane);
        }

        private class JumpState : EntityStateMachineState
        {
            public JumpState() : base(STATE_JUMP, ANIMATION_STATE_JUMP) { }
            public override int GetAnimationSubstate(int substate)
            {
                switch (substate)
                {
                    case SUBSTATE_START:
                        return ANIMATION_SUBSTATE_START;
                    case SUBSTATE_FALL:
                        return ANIMATION_SUBSTATE_FALL;
                    case SUBSTATE_END:
                        return ANIMATION_SUBSTATE_END;
                }
                return base.GetAnimationSubstate(substate);
            }
            public override void OnEnter(EntityStateMachine stateMachine, Entity entity)
            {
                base.OnEnter(stateMachine, entity);
                var substateTimer = stateMachine.GetSubStateTimer(entity);
                substateTimer.ResetSeconds(1 / 6f);
            }
            public override void OnUpdateAI(EntityStateMachine stateMachine, Entity entity)
            {
                base.OnUpdateAI(stateMachine, entity);
                var substate = stateMachine.GetSubState(entity);
                var timer = stateMachine.GetSubStateTimer(entity);
                timer.Run(stateMachine.GetSpeed(entity));
                switch (substate)
                {
                    case SUBSTATE_START:
                        if (timer.Expired)
                        {
                            StartJump(entity);
                            stateMachine.StartSubState(entity, SUBSTATE_FALL);
                        }
                        break;
                    case SUBSTATE_FALL:
                        {
                            Vector3 target = GetJumpTarget(entity);
                            var pos = entity.Position;
                            pos.x = Ticks.SmoothDamp(pos.x, target.x, 0.2f);
                            pos.z = Ticks.SmoothDamp(pos.z, target.z, 0.2f);
                            entity.Position = pos;
                            if (entity.IsOnGround)
                            {
                                Land(entity);
                                stateMachine.StartSubState(entity, SUBSTATE_END);
                                timer.ResetSeconds(0.5f);
                            }
                        }
                        break;
                    case SUBSTATE_END:
                        if (timer.Expired)
                        {
                            var finishState = GetJumpFinishState(entity);
                            SetJumpFinishState(entity, -1);
                            if (finishState < 0)
                            {
                                finishState = STATE_IDLE;
                            }
                            stateMachine.StartState(entity, finishState);
                        }
                        break;
                }
            }
            public override void OnUpdateLogic(EntityStateMachine machine, Entity entity)
            {
                base.OnUpdateLogic(machine, entity);
                CheckDeath(entity);
            }
            private void StartJump(Entity boss)
            {
                Vector3 velocity = boss.Velocity;
                velocity.y = boss.GetGravity() * Ticks.FromSeconds(jumpFlyingSeconds) / 2f;
                boss.Velocity = velocity;
            }
            private void Land(Entity entity)
            {
                var level = entity.Level;
                landBuffer.Clear();
                landDetector.DetectMultiple(entity, landBuffer);
                foreach (IEntityCollider collider in landBuffer)
                {
                    var ent = collider.Entity;
                    var damageOutput = collider.TakeDamage(ent.GetTakenCrushDamage(), new DamageEffectList(VanillaDamageEffects.IMPACT, VanillaDamageEffects.IGNORE_ARMOR), entity);
                    if (ent.Type == EntityTypes.PLANT)
                    {
                        if (damageOutput?.BodyResult?.Fatal ?? false)
                        {
                            entity.PlaySound(VanillaSoundID.smash);
                        }
                    }
                }
                level.ShakeScreen(5, 0, 15);
                entity.PlaySound(VanillaSoundID.thump);
            }
            public const int SUBSTATE_START = 0;
            public const int SUBSTATE_FALL = 1;
            public const int SUBSTATE_END = 2;
            public const int ANIMATION_SUBSTATE_START = 0;
            public const int ANIMATION_SUBSTATE_FALL = 1;
            public const int ANIMATION_SUBSTATE_END = 2;

            private CollisionDetector landDetector = new CollisionDetector();
            private List<IEntityCollider> landBuffer = new List<IEntityCollider>();
            private const float jumpFlyingSeconds = 0.5f;
        }
        #endregion

        #region 喷吐火球
        private class SpitState : EntityStateMachineState
        {
            public SpitState() : base(STATE_SPIT, ANIMATION_STATE_SPIT) { }
            public override int GetAnimationSubstate(int substate)
            {
                switch (substate)
                {
                    case SUBSTATE_START:
                        return ANIMATION_SUBSTATE_START;
                    case SUBSTATE_SPIT_1:
                    case SUBSTATE_SPIT_2:
                    case SUBSTATE_SPIT_3:
                        return ANIMATION_SUBSTATE_SPIT;
                    case SUBSTATE_END:
                        return ANIMATION_SUBSTATE_END;
                }
                return base.GetAnimationSubstate(substate);
            }
            public override void OnEnter(EntityStateMachine stateMachine, Entity entity)
            {
                base.OnEnter(stateMachine, entity);
                var substateTimer = stateMachine.GetSubStateTimer(entity);
                substateTimer.ResetSeconds(1f);
            }
            public override void OnUpdateAI(EntityStateMachine stateMachine, Entity entity)
            {
                base.OnUpdateAI(stateMachine, entity);
                var substate = stateMachine.GetSubState(entity);
                var timer = stateMachine.GetSubStateTimer(entity);
                timer.Run(stateMachine.GetSpeed(entity));
                switch (substate)
                {
                    case SUBSTATE_START:
                        if (timer.Expired)
                        {
                            ShootFireball(entity);
                            stateMachine.StartSubState(entity, SUBSTATE_SPIT_1);
                            timer.ResetSeconds(0.2f);
                        }
                        break;
                    case SUBSTATE_SPIT_1:
                        if (timer.Expired)
                        {
                            ShootFireball(entity);
                            stateMachine.StartSubState(entity, SUBSTATE_SPIT_2);
                            timer.ResetSeconds(0.2f);
                        }
                        break;
                    case SUBSTATE_SPIT_2:
                        if (timer.Expired)
                        {
                            ShootFireball(entity);
                            stateMachine.StartSubState(entity, SUBSTATE_SPIT_3);
                            timer.ResetSeconds(0.2f);
                        }
                        break;
                    case SUBSTATE_SPIT_3:
                        if (timer.Expired)
                        {
                            stateMachine.StartSubState(entity, SUBSTATE_END);
                            timer.ResetSeconds(0.5f);
                        }
                        break;
                    case SUBSTATE_END:
                        if (timer.Expired)
                        {
                            stateMachine.StartState(entity, STATE_IDLE);
                        }
                        break;
                }
            }
            public override void OnUpdateLogic(EntityStateMachine machine, Entity entity)
            {
                base.OnUpdateLogic(machine, entity);
                CheckDeath(entity);
            }

            private void ShootFireball(Entity entity)
            {
                var param = entity.GetShootParams();
                param.projectileID = VanillaProjectileID.fireCharge;
                param.velocity = GetNeckDirection(entity) * 20;
                param.position = GetSpitSourcePosition(entity);
                param.soundID = VanillaSoundID.fireCharge;
                param.damage = entity.GetDamage() * 1;
                entity.ShootProjectile(param);
            }
            public const int SUBSTATE_START = 0;
            public const int SUBSTATE_SPIT_1 = 1;
            public const int SUBSTATE_SPIT_2 = 2;
            public const int SUBSTATE_SPIT_3 = 3;
            public const int SUBSTATE_END = 4;
            public const int ANIMATION_SUBSTATE_START = 0;
            public const int ANIMATION_SUBSTATE_SPIT = 1;
            public const int ANIMATION_SUBSTATE_END = 2;

        }
        #endregion

        #region 扇风
        private class FlapWingsState : EntityStateMachineState
        {
            public FlapWingsState() : base(STATE_FLAP_WINGS, ANIMATION_STATE_FLAP_WINGS) { }
            public override void OnEnter(EntityStateMachine stateMachine, Entity entity)
            {
                base.OnEnter(stateMachine, entity);
                var substateTimer = stateMachine.GetSubStateTimer(entity);
                substateTimer.ResetSeconds(2 / 3f);
            }
            public override void OnUpdateAI(EntityStateMachine stateMachine, Entity entity)
            {
                base.OnUpdateAI(stateMachine, entity);
                var substate = stateMachine.GetSubState(entity);
                var timer = stateMachine.GetSubStateTimer(entity);
                timer.Run(stateMachine.GetSpeed(entity));
                switch (substate)
                {
                    case SUBSTATE_START:
                        if (timer.Expired)
                        {
                            entity.PlaySound(VanillaSoundID.dragonWings);
                            stateMachine.StartSubState(entity, SUBSTATE_FLAP_1);
                            timer.ResetSeconds(1f);
                        }
                        break;
                    case SUBSTATE_FLAP_1:
                        if (timer.Expired)
                        {
                            entity.PlaySound(VanillaSoundID.dragonWings);
                            stateMachine.StartSubState(entity, SUBSTATE_FLAP_2);
                            timer.ResetSeconds(1f);
                        }
                        break;
                    case SUBSTATE_FLAP_2:
                        if (timer.Expired)
                        {
                            entity.PlaySound(VanillaSoundID.dragonGrowl);
                            entity.PlaySound(VanillaSoundID.dragonWings);
                            entity.Level.ShakeScreen(10, 0, 15);
                            ShootTornado(entity);
                            stateMachine.StartSubState(entity, SUBSTATE_END);
                            timer.ResetSeconds(7 / 12f);
                        }
                        break;
                    case SUBSTATE_END:
                        if (timer.Expired)
                        {
                            stateMachine.StartState(entity, STATE_IDLE);
                        }
                        break;
                }
            }
            public override void OnUpdateLogic(EntityStateMachine machine, Entity entity)
            {
                base.OnUpdateLogic(machine, entity);
                CheckDeath(entity);
            }

            private void ShootTornado(Entity entity)
            {
                var param = entity.GetSpawnParams();
                param.SetProperty(VanillaEntityProps.DAMAGE, entity.GetDamage() * 0.05f);
                var position = GetTornadoSourcePosition(entity);
                entity.Spawn(VanillaEffectID.tornado, position, param)?.Let(e =>
                {
                    e.Velocity = entity.GetFacingDirection() * 2;
                });
            }
            public const int SUBSTATE_START = 0;
            public const int SUBSTATE_FLAP_1 = 1;
            public const int SUBSTATE_FLAP_2 = 2;
            public const int SUBSTATE_END = 3;

        }
        #endregion

        #region 吞食
        public static Bounds GetEatDetectionHitbox(Entity entity)
        {
            var size = new Vector3(100, 64, 500);
            var position = entity.Position + entity.GetFacingDirection() * 300;
            position.y += size.y * 0.5f;
            return new Bounds(position, size);
        }
        public static Bounds GetEatHitbox(Entity entity, float time)
        {
            var size = new Vector3(100, 64, 100);
            var position = entity.Position + entity.GetFacingDirection() * 300;
            position.y += size.y * 0.5f;
            position.z += 200 - 400 * time;
            return new Bounds(position, size);
        }
        private static bool HasEatableTargets(Entity boss)
        {
            return eatDetector.DetectEntityCount(boss) > 0;
        }
        private class EatState : EntityStateMachineState
        {
            public EatState() : base(STATE_EAT, ANIMATION_STATE_EAT) { }
            public override int GetAnimationSubstate(int substate)
            {
                switch (substate)
                {
                    case SUBSTATE_SWALLOW:
                    case SUBSTATE_SWALLOW_END:
                        return ANIMATION_SUBSTATE_SWALLOW;
                }
                return substate;
            }
            public override void OnEnter(EntityStateMachine stateMachine, Entity entity)
            {
                base.OnEnter(stateMachine, entity);
                var substateTimer = stateMachine.GetSubStateTimer(entity);
                substateTimer.ResetSeconds(2 / 3f);
                SetEatenEntities(entity, null);
            }
            public override void OnUpdateAI(EntityStateMachine stateMachine, Entity entity)
            {
                base.OnUpdateAI(stateMachine, entity);
                var substate = stateMachine.GetSubState(entity);
                var timer = stateMachine.GetSubStateTimer(entity);
                timer.Run(stateMachine.GetSpeed(entity));
                switch (substate)
                {
                    case SUBSTATE_START:
                        if (timer.Expired)
                        {
                            entity.PlaySound(VanillaSoundID.fling);
                            entity.PlaySound(VanillaSoundID.bigChomp, 0.5f);
                            stateMachine.StartSubState(entity, SUBSTATE_EAT);
                            timer.ResetSeconds(0.25f);
                        }
                        break;
                    case SUBSTATE_EAT:
                        Eat(entity, timer.GetPassedPercentage());
                        if (timer.Expired)
                        {
                            var entities = GetEatenEntities(entity);
                            if (entities != null && entities.Count > 0)
                            {
                                stateMachine.StartSubState(entity, SUBSTATE_SWALLOW);
                                timer.ResetSeconds(1f);
                            }
                            else
                            {
                                stateMachine.StartSubState(entity, SUBSTATE_END);
                                timer.ResetSeconds(0.5f);
                            }
                        }
                        break;
                    case SUBSTATE_SWALLOW:
                        if (timer.Expired)
                        {
                            Swallow(entity);
                            SetEatenEntities(entity, null);
                            stateMachine.StartSubState(entity, SUBSTATE_SWALLOW_END);
                            timer.ResetSeconds(2 / 3f);
                        }
                        break;
                    case SUBSTATE_SWALLOW_END:
                        if (timer.Expired)
                        {
                            stateMachine.StartState(entity, STATE_FIRE_BREATH);
                        }
                        break;
                    case SUBSTATE_END:
                        if (timer.Expired)
                        {
                            stateMachine.StartState(entity, STATE_FIRE_BREATH);
                        }
                        break;
                }
            }
            public override void OnUpdateLogic(EntityStateMachine machine, Entity entity)
            {
                base.OnUpdateLogic(machine, entity);
                CheckDeath(entity);
            }

            private void Eat(Entity entity, float time)
            {
                var hitbox = GetEatHitbox(entity, time);
                var mask = EntityCollisionHelper.MASK_VULNERABLE;
                var targets = entity.Level.OverlapBox(hitbox.center, hitbox.size, entity.GetFaction(), mask, mask);
                foreach (var collider in targets)
                {
                    var target = collider.Entity;
                    if (!target.ExistsAndAlive())
                        return;
                    if (collider.IsForMain() && target.Type != EntityTypes.BOSS)
                    {
                        if (target.Type != EntityTypes.PLANT)
                        {
                            target.PlayDeathSound();
                        }
                        target.Die(new DamageEffectList(VanillaDamageEffects.REMOVE_ON_DEATH, VanillaDamageEffects.NO_DEATH_TRIGGER), entity);
                        EatEntity(entity, target);
                    }
                    else
                    {
                        collider.TakeDamage(entity.GetDamage() * BITE_DAMAGE_MULTIPLIER, new DamageEffectList(), entity);
                    }
                }
            }
            private void EatEntity(Entity entity, Entity target)
            {
                var entities = GetEatenEntities(entity);
                if (entities == null)
                {
                    entities = new List<NamespaceID>();
                    SetEatenEntities(entity, entities);
                }
                entities.Add(target.GetDefinitionID());
            }
            private void Swallow(Entity entity)
            {
                var entities = GetEatenEntities(entity);
                if (entities == null)
                    return;
                entity.HealEffects(entities.Count * HEAL_PER_ENTITY, entity);
                entity.PlaySound(VanillaSoundID.gulp, 0.5f);
            }
            public const int SUBSTATE_START = 0;
            public const int SUBSTATE_EAT = 1;
            public const int SUBSTATE_END = 2;
            public const int SUBSTATE_SWALLOW = 3;
            public const int SUBSTATE_SWALLOW_END = 4;
            public const int ANIMATION_SUBSTATE_SWALLOW = 3;

        }
        #endregion

        #region 火焰吐息
        private class FireBreathState : EntityStateMachineState
        {
            public FireBreathState() : base(STATE_FIRE_BREATH, ANIMATION_STATE_SPIT) { }
            public override int GetAnimationSubstate(int substate)
            {
                switch (substate)
                {
                    case SUBSTATE_START:
                        return ANIMATION_SUBSTATE_START;
                    case SUBSTATE_LOOP:
                        return ANIMATION_SUBSTATE_SPIT;
                    case SUBSTATE_END:
                        return ANIMATION_SUBSTATE_END;
                }
                return base.GetAnimationSubstate(substate);
            }
            public override void OnEnter(EntityStateMachine stateMachine, Entity entity)
            {
                base.OnEnter(stateMachine, entity);
                var substateTimer = stateMachine.GetSubStateTimer(entity);
                substateTimer.ResetSeconds(1f);
            }
            public override void OnUpdateAI(EntityStateMachine stateMachine, Entity entity)
            {
                base.OnUpdateAI(stateMachine, entity);
                var substate = stateMachine.GetSubState(entity);
                var timer = stateMachine.GetSubStateTimer(entity);
                timer.Run(stateMachine.GetSpeed(entity));
                switch (substate)
                {
                    case SUBSTATE_START:
                        {
                            var headRotation = GetHeadRotation(entity);
                            headRotation = Ticks.SmoothDamp(headRotation, FIRE_BREATH_ANGLE_START, 0.2f);
                            SetHeadRotation(entity, headRotation);
                            if (timer.Expired)
                            {
                                entity.PlaySound(VanillaSoundID.dragonGrowl);
                                stateMachine.StartSubState(entity, SUBSTATE_LOOP);
                                timer.ResetSeconds(3f);
                            }
                        }
                        break;
                    case SUBSTATE_LOOP:
                        {
                            SetHeadRotation(entity, Mathf.Lerp(FIRE_BREATH_ANGLE_START, FIRE_BREATH_ANGLE_END, timer.GetPassedPercentage()));

                            if (timer.PassedIntervalSeconds(0.2f))
                            {
                                ShootFireBreath(entity);
                            }
                            if (timer.Expired)
                            {
                                stateMachine.StartSubState(entity, SUBSTATE_END);
                                timer.ResetSeconds(0.5f);
                            }
                        }
                        break;
                    case SUBSTATE_END:
                        {
                            var headRotation = GetHeadRotation(entity);
                            headRotation = Ticks.SmoothDamp(headRotation, 0, 0.2f);
                            if (timer.Expired)
                            {
                                stateMachine.StartState(entity, STATE_IDLE);
                                headRotation = 0;
                            }
                            SetHeadRotation(entity, headRotation);
                        }
                        break;
                }
            }
            public override void OnUpdateLogic(EntityStateMachine machine, Entity entity)
            {
                base.OnUpdateLogic(machine, entity);
                CheckDeath(entity);
            }

            private void ShootFireBreath(Entity entity)
            {
                var param = entity.GetSpawnParams();
                param.SetProperty(VanillaEntityProps.DAMAGE, entity.GetDamage() * 0.2f);
                var position = GetSpitSourcePosition(entity);
                entity.Spawn(VanillaEffectID.dragonFireBreath, position, param)?.Let(e =>
                {
                    e.Velocity = GetNeckDirection(entity) * 20;
                });
            }
            public const int SUBSTATE_START = 0;
            public const int SUBSTATE_LOOP = 1;
            public const int SUBSTATE_END = 2;
            public const int ANIMATION_SUBSTATE_START = 0;
            public const int ANIMATION_SUBSTATE_SPIT = 1;
            public const int ANIMATION_SUBSTATE_END = 2;

        }
        #endregion

        public const float FIRE_BREATH_ANGLE_START = -60;
        public const float FIRE_BREATH_ANGLE_END = 60;
        private static RedDragonStateMachine stateMachine = new RedDragonStateMachine();
        private static RedDragonEatDetector eatDetector = new RedDragonEatDetector();
        private static int[] statePoolPhase1 = new int[]
        {
            STATE_SPIT,
            STATE_FLAP_WINGS,
            STATE_EAT,
            STATE_JUMP
        };
        private static int[] statePoolPhase2 = new int[]
        {
            STATE_SPIT,
            STATE_FLAP_WINGS,
            STATE_EAT,
            STATE_JUMP
        };
    }
}