#nullable enable // autogenerated

using MVZ2.GameContent.Bosses;
using MVZ2.GameContent.Buffs.Contraptions;
using MVZ2.GameContent.Damages;
using MVZ2.GameContent.Effects;
using MVZ2.GameContent.Projectiles;
using MVZ2.Vanilla.Audios;
using MVZ2.Vanilla.Callbacks;
using MVZ2.Vanilla.Contraptions;
using MVZ2.Vanilla.Entities;
using MVZ2.Vanilla.Level;
using MVZ2.Vanilla.Properties;
using MVZ2Logic.Level;
using PVZEngine;
using PVZEngine.Buffs;
using PVZEngine.Callbacks;
using PVZEngine.Damages;
using PVZEngine.Entities;
using PVZEngine.Level;
using Tools;
using UnityEngine;
using MVZ2.GameContent.Buffs;
using MVZ2.GameContent.Buffs.Enemies;

namespace MVZ2.GameContent.Contraptions
{
    [EntityBehaviourDefinition(VanillaContraptionNames.PermanentIce)]
    public class PermanentIce : ContraptionBehaviour
    {
        public PermanentIce(string nsp, string name) : base(nsp, name)
        {

        }
        public override void Init(Entity entity)
        {
            base.Init(entity);

            SetExplosionTimer(entity, new FrameTimer(30));
        }
        protected override void UpdateAI(Entity entity)
        {
            base.UpdateAI(entity);
            if (IsIgnited(entity))
            {
                IgnitedUpdate(entity);
            }
        }
        public override bool CanTrigger(Entity entity)
        {
            return base.CanTrigger(entity) && !IsIgnited(entity);
        }
        protected override void OnTrigger(Entity entity)
        {
            base.OnTrigger(entity);
            Ignite(entity);
        }
        protected override void OnEvoke(Entity entity)
        {
            base.OnEvoke(entity);
            entity.SetEvoked(true);

            entity.Level.Spawn(VanillaEffectID.stunningFlash, entity.GetCenter(), entity);
            var level = entity.Level;
            foreach (var e in level.FindEntities(e => e.ExistsAndAlive() && e.GetFaction() != entity.GetFaction() && e.Type != EntityTypes.BOSS))
            {
                if (e.HasBuff<SoulFreezeBuff>())
                {
                    e.TakeDamage(1000, new DamageEffectList(VanillaDamageEffects.MUTE, VanillaDamageEffects.IGNORE_ARMOR, VanillaDamageEffects.ICE), entity);
                }
            }
            Ignite(entity);
        }
        public static void Ignite(Entity entity)
        {
            entity.PlaySound(VanillaSoundID.freeze);
            entity.SetBehaviourField(ID, PROP_IGNITED, true);
            //entity.AddBuff<TNTIgnitedBuff>();
        }
        public static bool IsIgnited(Entity entity)
        {
            return entity.GetBehaviourField<bool>(ID, PROP_IGNITED);
        }
        public static FrameTimer? GetExplosionTimer(Entity entity)
        {
            return entity.GetBehaviourField<FrameTimer>(ID, PROP_EXPLOSION_TIMER);
        }
        public static void SetExplosionTimer(Entity entity, FrameTimer timer)
        {
            entity.SetBehaviourField(ID, PROP_EXPLOSION_TIMER, timer);
        }
        public static DamageOutput[] Explode(Entity entity, float range, float damage)
        {
            var damageEffects = new DamageEffectList(VanillaDamageEffects.MUTE, VanillaDamageEffects.IGNORE_ARMOR, VanillaDamageEffects.ICE);
            var damageOutputs = entity.Explode(entity.Position, range, entity.GetFaction(), damage, damageEffects);
            foreach (var output in damageOutputs)
            {
                var result = output.BodyResult;
                if (result != null && result.Fatal)
                {
                    var target = output.Entity;
                    var distance = (target.Position - entity.Position).magnitude;
                    var speed = 25 * Mathf.Lerp(1f, 0.5f, distance / range);
                    target.Velocity = target.Velocity + Vector3.up * speed;
                }
            }
            Explosion.Spawn(entity, entity.GetCenter(), range);
            entity.PlaySound(VanillaSoundID.explosion);

            
            entity.Level.Triggers.RunCallbackFiltered(VanillaLevelCallbacks.POST_CONTRAPTION_DETONATE, new EntityCallbackParams(entity), entity.GetDefinitionID());

            return damageOutputs;
        }
        private void Freeze(Entity entity, int stunDuration)
        {
            entity.AddBuff<GlowstoneEvokeBuff>();
            entity.Level.Spawn(VanillaEffectID.stunningFlash, entity.GetCenter(), entity);
            bool stunned = false;
            foreach (var target in entity.Level.GetEntities())
            {
                if (target.Type == EntityTypes.ENEMY && target.IsHostile(entity) && target.CanDeactive())
                {
                    target.SoulFreeze(stunDuration);
                    stunned = true;
                }
            }
            if (stunned)
            {
                entity.PlaySound(VanillaSoundID.stunned);
            }
        }
        private void IgnitedUpdate(Entity entity)
        {
            var timer = GetExplosionTimer(entity);
            if (timer == null)
                return;
            timer.Run(entity.GetAttackSpeed());

            if (timer.Frame < 5)
            {
                entity.SetDisplayScale(Vector3.one * Mathf.Lerp(2, 1, timer.Frame / 5f));
            }
            if (timer.Expired)
            {
                var range = entity.GetRange();
                var damage = entity.GetDamage();
                Explode(entity, range, damage);
                //if (entity.IsEvoked())
                //{
                //    for (int i = 0; i < 4; i++)
                //    {
                //        var direction = Quaternion.Euler(0, i * 90, 0) * Vector3.right * 10;
                //        var velocity = direction;
                //        velocity.y = 10;
                //        var shootParams = entity.GetShootParams();
                //        shootParams.projectileID = VanillaProjectileID.flyingTNT;
                //        shootParams.velocity = velocity;
                //        shootParams.pivot = VanillaEntityProps.SHOT_PIVOT_BOTTOM;
                //        entity.ShootProjectile(shootParams)?.Let(projectile =>
                //        {
                //            projectile.SetDamage(damage);
                //            projectile.SetRange(range);
                            
                //        });
                //    }
                //}
                Freeze(entity, 210);
                entity.Remove();
            }
        }
        
        private static readonly NamespaceID ID = VanillaContraptionID.PermanentIce;
        public static readonly VanillaEntityPropertyMeta<bool> PROP_IGNITED = new VanillaEntityPropertyMeta<bool>("Ignited");
        public static readonly VanillaEntityPropertyMeta<FrameTimer> PROP_EXPLOSION_TIMER = new VanillaEntityPropertyMeta<FrameTimer>("ExplosionTimer");
    }
}
