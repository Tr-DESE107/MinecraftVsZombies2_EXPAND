#nullable enable // autogenerated

using MVZ2.GameContent.Detections;
using MVZ2.GameContent.Projectiles;
using MVZ2.Vanilla.Audios;
using MVZ2.Vanilla.Contraptions;
using MVZ2.Vanilla.Detections;
using MVZ2.Vanilla.Entities;
using PVZEngine.Entities;
using PVZEngine.Level;
using UnityEngine;

namespace MVZ2.GameContent.Contraptions
{
    [EntityBehaviourDefinition(VanillaContraptionNames.triplenser)]
    public class Triplenser : DispenserFamily
    {
        public Triplenser(string nsp, string name) : base(nsp, name)
        {
        }

        public override void Init(Entity entity)
        {
            base.Init(entity);
            InitShootTimer(entity);
        }
        protected override void UpdateAI(Entity entity)
        {
            base.UpdateAI(entity);
            if (!entity.IsEvoked())
            {
                ShootTick(entity);
                return;
            }
        }
        public override void OnShootTick(Entity entity)
        {
            var lane = entity.GetLane();
            var maxLane = entity.Level.GetMaxLaneCount();
            int makeupCount = 0;
            for (int i = lane - 1; i <= lane + 1; i++)
            {
                var bullet = Shoot(entity);
                if (bullet == null)
                    continue;
                if (i < 0 || i >= maxLane)
                {
                    makeupCount++;
                    bullet.Velocity *= 1 + (MAKE_UP_VELOCITY_MULTIPLIER_INCREAMENT * makeupCount);
                }
                else if (i != lane)
                {
                    bullet.StartChangingLane(i);
                }
            }
        }
        protected override void OnEvoke(Entity entity)
        {
            base.OnEvoke(entity);
            var otherworldParam = entity.GetShootParams();
            otherworldParam.damage = entity.GetDamage() * 50;
            otherworldParam.projectileID = VanillaProjectileID.hellPlanetOtherworld;
            otherworldParam.velocity = otherworldParam.velocity.normalized;
            var otherworld = entity.ShootProjectile(otherworldParam);

            var earthParam = entity.GetShootParams();
            earthParam.damage = entity.GetDamage() * 25;
            earthParam.projectileID = VanillaProjectileID.hellPlanetEarth;
            earthParam.velocity = Vector3.zero;
            var earth = entity.ShootProjectile(earthParam);
            if (earth != null)
            {
                earth.SetParent(otherworld);
                HellPlanet.SetOrbitDistance(earth, 72);
                HellPlanet.SetOrbitSpeed(earth, 3);
            }

            var moonParam = entity.GetShootParams();
            moonParam.damage = entity.GetDamage() * 12.5f;
            moonParam.projectileID = VanillaProjectileID.hellPlanetMoon;
            moonParam.velocity = Vector3.zero;
            var moon = entity.ShootProjectile(moonParam);
            if (moon != null)
            {
                moon.SetParent(earth);
                HellPlanet.SetOrbitDistance(moon, 36);
                HellPlanet.SetOrbitSpeed(moon, 9);
            }

            entity.PlaySound(VanillaSoundID.odd);
            entity.PlaySound(VanillaSoundID.boon);
        }
        protected override Detector GetDetector()
        {
            return new DispenserDetector()
            {
                ignoreHighEnemy = true,
                innerLaneExpansion = 1,
                outerLaneExpansion = 1,
            };
        }
        public const float MAKE_UP_VELOCITY_MULTIPLIER_INCREAMENT = 0.2f;
    }
}
