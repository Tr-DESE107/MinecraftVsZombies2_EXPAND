#nullable enable // autogenerated

using MVZ2.GameContent.Contraptions;
using MVZ2.GameContent.Seeds;
using MVZ2.Vanilla.Callbacks;
using MVZ2.Vanilla.Contraptions;
using MVZ2.Vanilla.Level;
using MVZ2Logic.Blueprints;
using MVZ2Logic.Callbacks;
using MVZ2Logic.Level;
using MVZ2Logic.Modding;
using MVZ2Logic.SeedPacks;
using PVZEngine;
using PVZEngine.Callbacks;
using PVZEngine.Entities;
using PVZEngine.Level;

namespace MVZ2.GameContent.GlobalCallbacks
{
    [ModGlobalCallbacks]
    public class BlueprintGlobalCallbacks : VanillaGlobalCallbacks
    {
        public override void Apply(Mod mod)
        {
            mod.AddTrigger(VanillaLevelCallbacks.POST_USE_ENTITY_BLUEPRINT, PostUseEntityBlueprintCallback);
            mod.AddTrigger(LogicCallbacks.GET_BLUEPRINT_STYLE, GetBlueprintStyleCallback);
        }
        private void PostUseEntityBlueprintCallback(VanillaLevelCallbacks.PostUseEntityBlueprintParams param, CallbackResult callbackResult)
        {
            var output = param.placeOutput;
            var entity = output.entity;
            var seed = param.blueprint;
            var definition = param.definition;
            var heldData = param.heldData;
            if (entity == null)
                return;
            if (heldData.IsInstantTrigger() && entity.CanTrigger())
            {
                entity.Trigger();
            }
            if (heldData.IsInstantEvoke() && entity.CanEvoke() && entity.Level.GetStarshardCount() > 0 && !entity.Level.IsStarshardDisabled())
            {
                entity.Level.AddStarshardCount(-1);
                entity.Evoke();
                entity.Level.Triggers.RunCallbackFiltered(VanillaLevelCallbacks.POST_USE_STARSHARD, new EntityCallbackParams(entity), entity.GetDefinitionID());
            }
            if (seed != null)
            {
                var drawnFromPool = seed.GetDrawnConveyorSeed();
                if (NamespaceID.IsValid(drawnFromPool))
                {
                    if (output.increaseTakenConveyorSeed)
                    {
                        entity.AddTakenConveyorSeed(drawnFromPool);
                    }
                    else
                    {
                        entity.Level.PutSeedToConveyorDiscardPile(drawnFromPool);
                    }
                }
                seed.SetDrawnConveyorSeed(null);
            }
        }
        private void GetBlueprintStyleCallback(LogicCallbacks.GetBlueprintStyleParams param, CallbackResult result)
        {
            var definition = param.blueprintDefinition;
            var seedID = definition.GetID();
            if (seedID == VanillaBlueprintID.FromEntity(VanillaContraptionID.commandBlock) || param.isCommandBlock)
            {
                result.SetValue(LogicBlueprintStyles.commandBlock);
            }
            else if (seedID == VanillaBlueprintID.FromEntity(VanillaContraptionID.forcePad)|| seedID == VanillaBlueprintID.FromEntity(VanillaContraptionID.EXPANDispenser))
            {
                result.SetValue(LogicBlueprintStyles.GoldCard);
            }
            else if (seedID == VanillaBlueprintID.FromEntity(VanillaContraptionID.Bedrock) || seedID == VanillaBlueprintID.FromEntity(VanillaContraptionID.errorBlock) || seedID == VanillaBlueprintID.FromEntity(VanillaContraptionID.Barrier))
            {
                result.SetValue(LogicBlueprintStyles.BlackCard);
            }
            else if (definition.IsUpgradeBlueprint())
            {
                result.SetValue(LogicBlueprintStyles.upgrade);
            }
        }
    }
}
