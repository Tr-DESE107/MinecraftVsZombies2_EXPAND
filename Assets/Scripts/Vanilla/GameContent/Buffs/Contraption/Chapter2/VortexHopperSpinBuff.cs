#nullable enable // autogenerated

using MVZ2.GameContent.Buffs.Enemies;
using MVZ2.GameContent.Damages;
using MVZ2.Vanilla.Entities;
using PVZEngine.Buffs;
using PVZEngine.Damages;
using PVZEngine.Entities;
using PVZEngine.Level;
using PVZEngine.Modifiers;
using UnityEngine;

namespace MVZ2.GameContent.Buffs.Contraptions
{
    [BuffDefinition(VanillaBuffNames.Contraption.vortexHopperSpin)]
    public class VortexHopperSpinBuff : BuffDefinition
    {
        public VortexHopperSpinBuff(string nsp, string name) : base(nsp, name)
        {
            AddModifier(new BooleanModifier(EngineEntityProps.INVINCIBLE, true));
            AddModifier(new BooleanModifier(VanillaEntityProps.CAN_DEACTIVE, false));
            AddModifier(new FloatModifier(EngineEntityProps.GRAVITY, NumberOperator.Multiply, 0));
        }
        public override void PostAdd(Buff buff)
        {
            base.PostAdd(buff);
            var entity = buff.GetEntity();
            if (entity == null)
                return;
            DragEnemiesNearby(entity);
        }
        public override void PostUpdate(Buff buff)
        {
            base.PostUpdate(buff);
            var entity = buff.GetEntity();
            if (entity == null)
                return;
            DragEnemiesNearby(entity);

            var vel = entity.Velocity;
            vel.y = -1;
            entity.Velocity = vel;
            if (entity.GetRelativeY() <= -48)
            {
                entity.Remove();
            }
        }

        public static void DragEnemiesNearby(Entity hopper)
        {
            foreach (var target in hopper.Level.FindEntities(e => e.Type == EntityTypes.ENEMY && IsValidEnemy(hopper, e) && IsInRange(hopper, e)))
            {
                DragEnemy(hopper, target);
            }
        }
        public static void DragEnemy(Entity hopper, Entity enemy)
        {
            if (enemy.IsDead || enemy.HasBuff<VortexHopperDragBuff>())
                return;
            if (enemy.ImmuneVortex())
                return;
            enemy.Die(new DamageEffectList(VanillaDamageEffects.DROWN, VanillaDamageEffects.NO_DEATH_TRIGGER), hopper);
            var hopperPos = hopper.Position;
            hopperPos.y = hopper.GetGroundY();
            var hopperPos2D = new Vector2(hopper.Position.x, hopper.Position.z);
            var targetPos2D = new Vector2(enemy.Position.x, enemy.Position.z);
            var buff = enemy.AddBuff<VortexHopperDragBuff>();
            buff.SetProperty(VortexHopperDragBuff.PROP_CENTER, hopperPos);
            buff.SetProperty(VortexHopperDragBuff.PROP_RADIUS, Vector2.Distance(targetPos2D, hopperPos2D));
            buff.SetProperty(VortexHopperDragBuff.PROP_ANGLE, Vector2.SignedAngle(Vector2.right, targetPos2D - hopperPos2D));
        }
        public static bool IsInRange(Entity hopper, Entity target)
        {
            var hopperPos = new Vector2(hopper.Position.x, hopper.Position.z);
            var targetPos = new Vector2(target.Position.x, target.Position.z);
            var distance = Vector2.Distance(hopperPos, targetPos);
            return distance < hopper.GetRange();
        }
        public static bool IsValidEnemy(Entity hopper, Entity target)
        {
            return !target.IsDead && hopper.IsHostile(target) && target.IsInWater();
        }
    }
}
