#nullable enable // autogenerated

using System.Collections.Generic;
using MVZ2.GameContent.Detections;
using MVZ2.Vanilla.Detections;
using MVZ2.Vanilla.Entities;
using MVZ2.Vanilla.Properties;
using PVZEngine.Auras;
using PVZEngine.Buffs;
using PVZEngine.Entities;
using PVZEngine.Level;
using PVZEngine.Modifiers;

namespace MVZ2.GameContent.Buffs.Contraptions
{
    [BuffDefinition(VanillaBuffNames.Contraption.woodenFanBlow)]
    public class WoodenFanBlowBuff : BuffDefinition
    {
        public WoodenFanBlowBuff(string nsp, string name) : base(nsp, name)
        {
            detector = new WoodenFanDetector(false)
            {
                mask = EntityCollisionHelper.MASK_ALL,
                factionTarget = FactionTarget.Any,
                canDetectInvisible = true,
            };
            evokedDetector = new WoodenFanDetector(true)
            {
                mask = EntityCollisionHelper.MASK_ALL,
                factionTarget = FactionTarget.Any,
                canDetectInvisible = true,
            };
            AddAura(new Aura());
            AddModifier(new BooleanModifier(EngineEntityProps.INVINCIBLE, true));
        }
        public override void PostUpdate(Buff buff)
        {
            base.PostUpdate(buff);
            var sourceEntity = buff.GetEntity();
            if (sourceEntity == null)
                return;
            bool evoked = IsEvoked(buff);
            var level = sourceEntity.Level;

            // ´µ¸ÉË®¼£
            var det = evoked ? evokedDetector : detector;
            List<Entity> results = new List<Entity>();
            det.DetectEntities(sourceEntity, results);
            foreach (var ent in results)
            {
                var behaviours = ent.Definition.GetBehaviours<IBeBlownBehaviour>();
                foreach (var behaviour in behaviours)
                {
                    behaviour.BeBlown(ent, sourceEntity);
                }
            }
        }
        public static bool IsInRange(Entity entity, Entity source, bool evoked)
        {
            return evoked || source.GetLane() == entity.GetLane();
        }
        public static bool IsEvoked(Buff buff) => buff.GetProperty<bool>(PROP_EVOKED);
        public static void SetEvoked(Buff buff, bool value) => buff.SetProperty(PROP_EVOKED, value);
        public static readonly VanillaBuffPropertyMeta<bool> PROP_EVOKED = new VanillaBuffPropertyMeta<bool>("evoked");
        private Detector detector;
        private Detector evokedDetector;

        public class Aura : AuraEffectDefinition
        {
            public Aura() : base(VanillaBuffID.Enemy.blownByWoodenFan, 3)
            {
                detector = new WoodenFanDetector(false)
                {
                    mask = EntityCollisionHelper.MASK_ENEMY,
                    factionTarget = FactionTarget.Hostile,
                };
                evokedDetector = new WoodenFanDetector(true)
                {
                    mask = EntityCollisionHelper.MASK_ENEMY,
                    factionTarget = FactionTarget.Hostile,
                };
            }

            public override void GetAuraTargets(AuraEffect auraEffect, List<IBuffTarget> results)
            {
                var sourceBuff = auraEffect.Source as Buff;
                if (sourceBuff == null)
                    return;
                var sourceEntity = sourceBuff.GetEntity();
                if (sourceEntity == null)
                    return;
                bool evoked = IsEvoked(sourceBuff);
                var det = evoked ? evokedDetector : detector;
                detectBuffer.Clear();
                det.DetectEntities(sourceEntity, detectBuffer);
                results.AddRange(detectBuffer);
            }
            public override void UpdateTargetBuff(AuraEffect effect, IBuffTarget target, Buff buff)
            {
                base.UpdateTargetBuff(effect, target, buff);
                var sourceBuff = effect.Source as Buff;
                if (sourceBuff == null)
                    return;
                var sourceEntity = sourceBuff.GetEntity();
                if (sourceEntity == null)
                    return;
                BlownByWoodenFanBuff.SetSourceID(buff, sourceEntity.ID);
            }
            private Detector detector;
            private Detector evokedDetector;
            private List<Entity> detectBuffer = new List<Entity>();
        }
    }
}
