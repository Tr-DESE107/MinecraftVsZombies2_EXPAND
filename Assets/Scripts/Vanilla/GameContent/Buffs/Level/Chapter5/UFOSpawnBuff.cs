#nullable enable // autogenerated

using System.Collections.Generic;
using MVZ2.GameContent.Enemies;
using MVZ2.Vanilla.Callbacks;
using MVZ2.Vanilla.Entities;
using MVZ2.Vanilla.Level;
using MVZ2.Vanilla.Properties;
using PVZEngine.Buffs;
using PVZEngine.Callbacks;
using PVZEngine.Grids;
using PVZEngine.Level;
using Tools;

namespace MVZ2.GameContent.Buffs.Level
{
    [BuffDefinition(VanillaBuffNames.Level.ufoSpawn)]
    public class UFOSpawnBuff : BuffDefinition
    {
        public UFOSpawnBuff(string nsp, string name) : base(nsp, name)
        {
            AddTrigger(VanillaLevelCallbacks.PRE_WAVE_ENEMY_SPAWN, PreWaveEnemySpawnCallback);
        }
        private void PreWaveEnemySpawnCallback(VanillaLevelCallbacks.WaveEnemySpawnParams args, CallbackResult result)
        {
            var level = args.level;
            var totalPoints = result.GetValue<float>();

            var rng = level.GetSpawnRNG();
            HashSet<LawnGrid> possibleGrids = new HashSet<LawnGrid>();

            foreach (var buff in level.GetBuffs<UFOSpawnBuff>())
            {
                var type = GetVariant(buff);
                var spawnLevel = GetSpawnLevel(buff);
                possibleGrids.Clear();
                UndeadFlyingObject.FillUFOPossibleSpawnGrids(level, type, level.Option.RightFaction, possibleGrids);

                var filteredGrids = UndeadFlyingObject.FilterConflictSpawnGrids(level, possibleGrids);

                var grid = filteredGrids.Random(rng);
                var column = grid.Column;
                var lane = grid.Lane;
                var pos = grid.GetEntityPosition();
                pos.y += UndeadFlyingObject.START_HEIGHT;

                level.Spawn(VanillaEnemyID.ufo, pos, null)?.Let(e =>
                {
                    e.SetVariant(type);
                    UndeadFlyingObject.SetTargetGridX(e, column);
                    UndeadFlyingObject.SetTargetGridY(e, lane);
                    level.TriggerEnemySpawned(VanillaSpawnID.GetFromEntity(VanillaEnemyID.ufo), e);
                });
                totalPoints -= spawnLevel;

                buff.Remove();
            }
            result.SetValue(totalPoints);
        }
        public static Buff Prepare(LevelEngine level, int variant, int spawnLevel)
        {
            var buff = level.NewBuff<UFOSpawnBuff>();
            UFOSpawnBuff.SetVariant(buff, variant);
            UFOSpawnBuff.SetSpawnLevel(buff, spawnLevel);
            level.AddBuff(buff);
            return buff;
        }
        public static void SetVariant(Buff buff, int type) => buff.SetProperty(PROP_VARIANT, type);
        public static int GetVariant(Buff buff) => buff.GetProperty<int>(PROP_VARIANT);
        public static void SetSpawnLevel(Buff buff, int value) => buff.SetProperty(PROP_SPAWN_LEVEL, value);
        public static int GetSpawnLevel(Buff buff) => buff.GetProperty<int>(PROP_SPAWN_LEVEL);
        public static readonly VanillaBuffPropertyMeta<int> PROP_VARIANT = new VanillaBuffPropertyMeta<int>("variant");
        public static readonly VanillaBuffPropertyMeta<int> PROP_SPAWN_LEVEL = new VanillaBuffPropertyMeta<int>("spawn_level");
    }
}
