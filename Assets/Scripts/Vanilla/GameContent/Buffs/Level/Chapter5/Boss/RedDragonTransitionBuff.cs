#nullable enable // autogenerated

using MVZ2.GameContent.Bosses;
using MVZ2.GameContent.ProgressBars;
using MVZ2.Vanilla.Audios;
using MVZ2.Vanilla.Bosses;
using MVZ2.Vanilla.Entities;
using MVZ2.Vanilla.Properties;
using MVZ2Logic.Level;
using PVZEngine.Buffs;
using PVZEngine.Level;
using UnityEngine;

namespace MVZ2.GameContent.Buffs.Level
{
    [BuffDefinition(VanillaBuffNames.Level.redDragonTransition)]
    public class RedDragonTransitionBuff : BuffDefinition
    {
        public RedDragonTransitionBuff(string nsp, string name) : base(nsp, name)
        {
        }
        public override void PostAdd(Buff buff)
        {
            base.PostAdd(buff);
            buff.SetProperty(PROP_TIMEOUT, MAX_TIMEOUT);
        }
        public override void PostUpdate(Buff buff)
        {
            base.PostUpdate(buff);

            var timeout = buff.GetProperty<int>(PROP_TIMEOUT);
            timeout--;
            buff.SetProperty(PROP_TIMEOUT, timeout);

            var level = buff.Level;
            if (timeout > FINISH_TIMEOUT)
            {
                // 音乐放缓。
                level.SetMusicVolume(Mathf.Clamp01(level.GetMusicVolume() - (1 / 30f)));
                if (timeout == ROAR_1_TIMEOUT)
                {
                    level.ShakeScreen(10, 0, 15);
                    level.PlaySound(VanillaSoundID.dragonGrowl);
                }
                if (timeout == ROAR_2_TIMEOUT)
                {
                    level.ShakeScreen(15, 0, 20);
                    level.PlaySound(VanillaSoundID.dragonGrowl);
                }
            }
            else if (timeout == FINISH_TIMEOUT)
            {
                level.ShakeScreen(20, 0, 30);
                level.Spawn(VanillaBossID.redDragon, new Vector3(RedDragon.APPEAR_START_X, RedDragon.APPEAR_START_Y, level.GetLawnCenterZ()), null)?.Let(e =>
                {
                    RedDragon.SetAppear(e);
                    e.ApplyBuffForBossRevenge(1f);
                });
            }
            else
            {
                if (level.EntityExists(e => e.IsEntityOf(VanillaBossID.redDragon) && e.State == RedDragon.STATE_IDLE))
                {
                    // 音乐。
                    level.PlayMusic(VanillaMusicID.shipBoss);
                    level.SetMusicVolume(1);
                    level.SetSubtrackWeight(0);
                    level.SetProgressBarToBoss(VanillaProgressBarID.redDragon);
                    buff.Remove();
                }
            }
        }
        public static readonly VanillaBuffPropertyMeta<int> PROP_TIMEOUT = new VanillaBuffPropertyMeta<int>("Timeout");
        public const int MAX_TIMEOUT = ROAR_1_TIMEOUT + 60;

        public const int ROAR_1_TIMEOUT = ROAR_2_TIMEOUT + 90;
        public const int ROAR_2_TIMEOUT = FINISH_TIMEOUT + 90;
        public const int FINISH_TIMEOUT = 0;
    }
}
