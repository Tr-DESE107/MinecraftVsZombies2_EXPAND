#nullable enable // autogenerated

using MVZ2.GameContent.Contraptions;
using MVZ2.Vanilla.Detections;
using MVZ2.Vanilla.Level;
using PVZEngine.Entities;
using UnityEngine;

namespace MVZ2.GameContent.Detections
{
    public class WoodenFanDetector : Detector
    {
        public WoodenFanDetector(bool evoked)
        {
            this.evoked = evoked;
        }
        protected override Bounds GetDetectionBounds(Entity self)
        {
            var minX = VanillaLevelExt.LEVEL_LEFTMOST;
            var maxX = VanillaLevelExt.LEVEL_RIGHTMOST;
            var minY = self.Position.y - WoodenFan.AFFECT_HEIGHT;
            var maxY = self.Position.y + WoodenFan.AFFECT_HEIGHT;
            var sizeX = maxX - minX;
            var sizeY = maxY - minY;
            var sizeZ = evoked ? VanillaLevelExt.LAWN_HEIGHT : self.Level.GetGridHeight();
            var center = self.GetCenter();
            center.x = (minX + maxX) * 0.5f;
            center.y = (minY + maxY) * 0.5f;
            if (evoked)
            {
                var minZ = self.Level.GetGridBottomZ();
                var maxZ = self.Level.GetGridTopZ();
                center.z = (minZ + maxZ) * 0.5f;
            }
            return new Bounds(center, new Vector3(sizeX, sizeY, sizeZ));
        }
        protected override bool ValidateCollider(DetectionParams param, IEntityCollider collider)
        {
            // 目标的Z中心必须被吹到。
            var self = param.entity;
            float minZ, maxZ;
            if (evoked)
            {
                minZ = self.Level.GetGridBottomZ();
                maxZ = self.Level.GetGridTopZ();
            }
            else
            {
                var sizeZ = self.Level.GetGridHeight();
                var centerZ = self.GetCenter().z;
                minZ = centerZ - sizeZ * 0.5f;
                maxZ = centerZ + sizeZ * 0.5f;
            }

            var bounds = collider.GetBoundingBox();
            if (bounds.center.z < minZ || bounds.center.z > maxZ)
                return false;
            return base.ValidateCollider(param, collider);
        }
        private bool evoked;
    }
}
