#nullable enable // autogenerated

using MVZ2.GameContent.Bosses;
using MVZ2.GameContent.Contraptions;
using MVZ2.GameContent.Damages;
using MVZ2.GameContent.Effects;
using MVZ2.Vanilla.Audios;
using MVZ2.Vanilla.Entities;
using MVZ2.Vanilla.Properties;
using MVZ2Logic.Level;
using PVZEngine;
using PVZEngine.Damages;
using PVZEngine.Entities;
using PVZEngine.Level;
using PVZEngine.Modifiers;
using Tools;
using UnityEngine;

namespace MVZ2.GameContent.Projectiles
{
    [EntityBehaviourDefinition(VanillaProjectileNames.explosiveLargeFireball)]
    public class ExplosiveLargeFireball : EntityBehaviourDefinition, IBeBlownBehaviour
    {
        public ExplosiveLargeFireball(string nsp, string name) : base(nsp, name)
        {
            AddModifier(new Vector3Modifier(EngineEntityProps.SCALE, NumberOperator.Multiply, PROP_SCALE_MULTIPLIER));
            AddModifier(new Vector3Modifier(EngineEntityProps.DISPLAY_SCALE, NumberOperator.Multiply, PROP_SCALE_MULTIPLIER));
            AddModifier(new Vector3Modifier(VanillaEntityProps.SHADOW_SCALE, NumberOperator.Multiply, PROP_SCALE_MULTIPLIER));
            AddModifier(new FloatModifier(EngineEntityProps.FRICTION, NumberOperator.Add, PROP_FRICTION_ADDITION));
        }
        public override void Init(Entity entity)
        {
            base.Init(entity);
            entity.SetProperty(PROP_TRIGGER_TIMER, TimerHelper.NewSecondTimer(TRIGGER_SECONDS));
            entity.CollisionMaskHostile |= EntityCollisionHelper.MASK_BOSS;
        }
        public override void PostCollision(EntityCollision collision, int state)
        {
            base.PostCollision(collision, state);
            if (state == EntityCollisionHelper.STATE_EXIT)
                return;
            var self = collision.Entity;
            var other = collision.Other;
            if (other.Type != EntityTypes.BOSS || !self.IsHostile(other))
                return;
            if (!self.Exists())
                return;
            Explode(self);
        }
        public override void Update(Entity entity)
        {
            base.Update(entity);
            var scaleMulti = entity.GetProperty<Vector3>(PROP_SCALE_MULTIPLIER, true);
            scaleMulti = Ticks.SmoothDamp(scaleMulti, Vector3.one, 0.1f);
            entity.SetProperty(PROP_SCALE_MULTIPLIER, scaleMulti);

            var triggered = entity.GetProperty<bool>(PROP_TRIGGERED);
            var triggerTimer = entity.GetProperty<FrameTimer>(PROP_TRIGGER_TIMER);
            if (!triggered)
            {
                if (triggerTimer.RunToExpiredAndNotNull())
                {
                    Trigger(entity);
                }
            }
            else
            {
                if (triggerTimer.RunToExpiredAndNotNull())
                {
                    Explode(entity);
                }
            }
            entity.SetProperty(PROP_FRICTION_ADDITION, triggered ? 1f : 0);
        }
        public static void Trigger(Entity entity)
        {
            entity.TriggerAnimation("Trigger");
            entity.PlaySound(VanillaSoundID.fireCharge, 0.5f);
            entity.SetProperty(PROP_TRIGGERED, true);
            var triggerTimer = entity.GetProperty<FrameTimer>(PROP_TRIGGER_TIMER);
            if (triggerTimer != null)
            {
                triggerTimer.ResetSeconds(EXPLODE_SECONDS);
            }
        }
        public static void Explode(Entity entity)
        {
            var level = entity.Level;
            var position = entity.GetCenter();
            var range = entity.GetRange();
            // 造成伤害
            var effects = new DamageEffectList(VanillaDamageEffects.FIRE, VanillaDamageEffects.EXPLOSION, VanillaDamageEffects.DAMAGE_BODY_AFTER_ARMOR_BROKEN);
            var damageOutputs = entity.Explode(position, range, entity.GetFaction(), entity.GetDamage(), effects);
            foreach (var output in damageOutputs)
            {
                if (output == null || !output.IsValid())
                    continue;
                var target = output.Entity;
                if (target.IsEntityOf(VanillaBossID.redDragon))
                {
                    RedDragon.Stun(target, 5f);
                }
            }

            // 留下火焰
            var column = entity.GetColumn();
            var lane = entity.GetLane();
            for (int x = column - 1; x <= column + 1; x++)
            {
                for (int y = lane - 1; y <= lane + 1; y++)
                {
                    var grid = level.GetGrid(x, y);
                    if (grid == null)
                        continue;
                    var param = entity.GetSpawnParams();
                    GridFire.Spawn(grid, entity, param);
                }
            }
            // 创建特效
            Explosion.Spawn(entity, position, range)?.Let(e =>
            {
                e.SetTint(new Color(1, 0.2f, 0, 1));
            });
            level.ShakeScreen(20, 0, 30);
            entity.PlaySound(VanillaSoundID.meteorLand);
            // 移除
            entity.Remove();
        }
        public void BeBlown(Entity entity, Entity source)
        {
            entity.SetFaction(source.GetFaction());
            entity.Velocity = source.GetFacingDirection() * 10;
        }
        public const float TRIGGER_SECONDS = 10f;
        public const float EXPLODE_SECONDS = 1f;
        public const float FIRE_DAMAGE_DIVISOR = 600f;
        public static readonly VanillaEntityPropertyMeta<Vector3> PROP_SCALE_MULTIPLIER = new VanillaEntityPropertyMeta<Vector3>("scale_multiplier", Vector3.zero);
        public static readonly VanillaEntityPropertyMeta<FrameTimer> PROP_TRIGGER_TIMER = new VanillaEntityPropertyMeta<FrameTimer>("trigger_timer");
        public static readonly VanillaEntityPropertyMeta<bool> PROP_TRIGGERED = new VanillaEntityPropertyMeta<bool>("triggered");
        public static readonly VanillaEntityPropertyMeta<float> PROP_FRICTION_ADDITION = new VanillaEntityPropertyMeta<float>("friction_addition");
    }
}