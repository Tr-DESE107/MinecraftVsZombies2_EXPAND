#nullable enable // autogenerated  

using MVZ2.GameContent.Buffs.Enemies;
using MVZ2.GameContent.Damages;
using MVZ2.Vanilla.Enemies;
using MVZ2.Vanilla.Entities;
using MVZ2.Vanilla.Level;
using PVZEngine.Buffs;
using PVZEngine.Damages;
using PVZEngine.Entities;
using PVZEngine.Level;
using PVZEngine.Callbacks;
using MVZ2.Vanilla.Properties;
using UnityEngine;
using MVZ2.Vanilla.Audios;

namespace MVZ2.GameContent.Enemies
{
    [EntityBehaviourDefinition(VanillaEnemyNames.DrunkardMonkZombie)]
    public class DrunkardMonkZombie : MonkZombie
    {
        private bool hasDrunk = false;
        private float originalDamage = 0f;

        public DrunkardMonkZombie(string nsp, string name) : base(nsp, name)
        {
        }

        public override void Init(Entity entity)
        {
            base.Init(entity);
            // 初始化时记录原始攻击力  
            originalDamage = entity.GetDamage();
            hasDrunk = false;
        }

        protected override void UpdateLogic(Entity entity)
        {
            base.UpdateLogic(entity);
            entity.SetModelDamagePercent();

            // 检查是否应该触发喝酒效果  
            CheckAndDrink(entity);
        }

        private void CheckAndDrink(Entity entity)
        {
            // 如果已经喝过酒或者已经死亡，不再检查  
            if (hasDrunk || entity.IsDead)
                return;

            // 当血量低于50%时触发喝酒  
            if (entity.Health <= entity.GetMaxHealth() * 0.5f)
            {
                Drink(entity);
            }
        }

        private void Drink(Entity entity)
        {
            // 标记已喝酒  
            hasDrunk = true;

            // 攻击力翻倍  
            float newDamage = originalDamage * 2f;
            entity.SetDamage(newDamage);

            // 播放喝酒音效（可选）  
            entity.PlaySound(VanillaSoundID.anvil);

            // 可以添加视觉效果  
            //var effect = entity.Level.Spawn(VanillaEffectID.levelup, entity.Position + new Vector3(0, 50, 0));
            //if (effect != null)
            //{
            //    effect.SetSize(Vector3.one * 0.5f);
            //}
        }

        // 可选：提供方法检查是否已喝酒  
        public bool HasDrunk()
        {
            return hasDrunk;
        }

        // 可选：重写获取伤害的方法，确保返回正确的伤害值  
        //public override float GetDamage(Entity entity)
        //{
        //    if (hasDrunk)
        //    {
        //        return originalDamage * 2f;
        //    }
        //    return originalDamage;
        //}
    }
}