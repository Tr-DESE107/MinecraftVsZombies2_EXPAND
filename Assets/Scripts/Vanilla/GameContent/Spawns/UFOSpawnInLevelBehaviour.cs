#nullable enable // autogenerated

using System.Collections.Generic;
using MVZ2.GameContent.Areas;
using MVZ2.GameContent.Buffs.Level;
using MVZ2.GameContent.Effects;
using MVZ2.GameContent.Enemies;
using MVZ2.Vanilla.Audios;
using MVZ2.Vanilla.Entities;
using MVZ2.Vanilla.Level;
using MVZ2Logic.Level;
using PVZEngine.Buffs;
using PVZEngine.Definitions;
using PVZEngine.Grids;
using PVZEngine.Level;
using Tools;
using UnityEngine;

namespace MVZ2.GameContent.Spawns
{
    public class UFOSpawnInLevelBehaviour : ISpawnInLevelBehaviour
    {
        public UFOSpawnInLevelBehaviour(int intervalWaves = 5, int maxCount = 10)
        {
            IntervalWaves = intervalWaves;
            MaxCount = maxCount;
        }

        public void PreSpawnAtWave(SpawnDefinition definition, LevelEngine level, int wave, float maxPoints, ref float points)
        {
        }
        public void PostSpawnAtWave(SpawnDefinition definition, LevelEngine level, int wave, float maxPoints, ref float points)
        {
            var minWave = definition.GetMinSpawnWave();
            if (wave <= minWave)
                return;
            bool finalWave = level.IsFinalWave(wave);
            if (finalWave)
                return;
            var intervalWaves = IntervalWaves;
            if (intervalWaves > 1)
            {
                var flagModular = wave % level.GetWavesPerFlag();
                var modular = flagModular % intervalWaves;
                if (modular == (intervalWaves - 1))
                {
                    PrepareUFO(definition, level, maxPoints);
                }
            }
            else
            {
                PrepareUFO(definition, level, maxPoints);
            }
        }
        private void PrepareUFO(SpawnDefinition definition, LevelEngine level, float totalPoints)
        {
            var rng = new RandomGenerator(level.GetSpawnRNG().Next());
            int count = Mathf.Min(MaxCount, Mathf.CeilToInt(totalPoints * 0.3333333f));
            var entityVariant = definition.GetSpawnEntityVariant();

            bool random = entityVariant < 0;
            List<int> variantPool = new List<int>();
            int startIndex = 0;
            if (random)
            {
                UndeadFlyingObject.FillUFOVariantRandomPool(level, variantPool);

                if (variantPool.Count <= 0)
                {
                    return;
                }
                startIndex = rng.Next(variantPool.Count);
            }
            for (int i = 0; i < count; i++)
            {
                int variant = entityVariant;
                if (random)
                {
                    var typeIndex = (startIndex + i) % variantPool.Count;
                    variant = variantPool[typeIndex];

                    if (rng.Next(100) < 10)
                    {
                        variant = UndeadFlyingObject.VARIANT_RAINBOW;
                    }
                }
                if (level.AreaID == VanillaAreaID.ship)
                {
                    var x = rng.Next(UFOBackground.MIN_X, UFOBackground.MAX_X);
                    var z = rng.Next(UFOBackground.MIN_Z, UFOBackground.MAX_Z);
                    var y = rng.Next(UFOBackground.MIN_Y, UFOBackground.MAX_Y);
                    var pos = new Vector3(x, y, z);
                    var background = level.Spawn(VanillaEffectID.ufoBackground, pos, null);
                    float speedMultiplier = 1;
                    // 如果关卡运行节奏极快，则背景的UFO也会加速。
                    var minLevelTime = Mathf.Min(level.GetWaveMaxSeconds(), level.GetWaveAdvanceSeconds());
                    if (minLevelTime <= TARGET_BACKGROUND_TIME)
                    {
                        speedMultiplier = TARGET_BACKGROUND_TIME / minLevelTime;
                    }
                    if (background != null)
                    {
                        var velocity = UFOBackground.FLY_DIRECTION * rng.Next(UFOBackground.MIN_SPEED, UFOBackground.MAX_SPEED) * speedMultiplier;
                        background.Velocity = velocity;
                        background.SetVariant(variant);
                    }
                }
                UFOSpawnBuff.Prepare(level, variant, definition.GetSpawnLevel());
            }
            level.PlaySound(VanillaSoundID.ufoAlert);
        }
        public int GetRandomSpawnLane(SpawnDefinition definition, LevelEngine level)
        {
            return level.GetRandomEnemySpawnLane();
        }
        public bool CanSpawnInLevel(SpawnDefinition definition, LevelEngine level) => false;
        public int GetWeight(SpawnDefinition definition, LevelEngine level) => 0;
        public const float TARGET_BACKGROUND_TIME = 6f;
        public int IntervalWaves { get; }
        public int MaxCount { get; }
    }
}
