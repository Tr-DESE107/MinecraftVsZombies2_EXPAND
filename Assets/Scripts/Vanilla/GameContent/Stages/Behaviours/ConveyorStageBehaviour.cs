#nullable enable // autogenerated

using MVZ2.Vanilla.Level;
using MVZ2.Vanilla.Properties;
using MVZ2Logic.Level;
using PVZEngine;
using PVZEngine.Definitions;
using PVZEngine.Level;
using Tools;
using UnityEngine;

namespace MVZ2.GameContent.Stages
{
    public class ConveyorStageBehaviour : StageBehaviour
    {
        public ConveyorStageBehaviour(StageDefinition stageDef) : base(stageDef)
        {
            stageDef.SetProperty(LogicStageProps.CONVEY_SPEED, 1f);
        }
        public override void Start(LevelEngine level)
        {
            level.SetConveyorMode(true);
            var waveTimer = new FrameTimer(CONVEYOR_INTERVAL);
            SetConveyorTimer(level, waveTimer);
        }
        public override void Update(LevelEngine level)
        {
            if (level.IsCleared)
                return;
            var conveyorTimer = GetConveyorTimer(level);
            var speed = GetConveyorSpeed(level);
            if (conveyorTimer != null && conveyorTimer.RunToExpired(speed))
            {
                level.ConveyRandomSeedPack();
                conveyorTimer.Reset();
            }
        }

        public static float GetConveyorSpeed(LevelEngine level)
        {
            var speed = level.GetConveySpeed();
            // 当前蓝图越多越慢。
            var seedCount = level.GetConveyorSeedPackCount();
            if (seedCount > SLOW_BLUEPRINT_COUNT_START)
            {
                var multiplier = 1 - Mathf.Pow(seedCount - SLOW_BLUEPRINT_COUNT_START, 2) / Mathf.Pow(SLOW_BLUEPRINT_COUNT_END - SLOW_BLUEPRINT_COUNT_START, 2);
                multiplier = Mathf.Max(multiplier, MIN_CONVEYOR_SPEED_MULTIPLIER);
                speed *= multiplier;
            }
            return speed;
        }

        #region 关卡属性
        public FrameTimer? GetConveyorTimer(LevelEngine level) => level.GetBehaviourField<FrameTimer>(PROP_CONVEYOR_TIMER);
        public void SetConveyorTimer(LevelEngine level, FrameTimer value) => level.SetBehaviourField(PROP_CONVEYOR_TIMER, value);
        #endregion

        #region 属性字段
        public const int SLOW_BLUEPRINT_COUNT_START = 4;
        public const int SLOW_BLUEPRINT_COUNT_END = 10;
        public const float MIN_CONVEYOR_SPEED_MULTIPLIER = 0.4f;
        public const string PROP_REGION = "conveyor";
        [LevelPropertyRegistry(PROP_REGION)]
        public static readonly VanillaLevelPropertyMeta<FrameTimer> PROP_CONVEYOR_TIMER = new VanillaLevelPropertyMeta<FrameTimer>("ConveyorTimer");
        public const int CONVEYOR_INTERVAL = 120;
        #endregion
    }
}
