#nullable enable // autogenerated

using System;
using System.Collections.Generic;
using System.Linq;
using PVZEngine.Base;
using PVZEngine.Buffs;
using PVZEngine.Callbacks;
using PVZEngine.Definitions;
using PVZEngine.Entities;
using PVZEngine.Level.Collisions;
using PVZEngine.Models;
using PVZEngine.Modifiers;
using UnityEngine;

namespace PVZEngine.Level
{
    public partial class LevelEngine : IBuffTarget, IDisposable, IPropertyModifyTarget
    {
        #region 公有方法
        public LevelEngine(IGameContent contentProvider, IGameTriggerSystem triggers, ICollisionSystem collisionSystem)
        {
            Content = contentProvider;
            Triggers = triggers;
            buffs.OnPropertyChanged += UpdateBuffedProperty;
            properties = new PropertyBlock(this);
            this.collisionSystem = collisionSystem;
        }


        public void Dispose()
        {
            RemoveTriggers(addedTriggers);
        }

        #region 组件
        public void AddComponent(ILevelComponent component)
        {
            component.PostAttach(this);
            levelComponents.Add(component);
        }
        public ILevelComponent[] GetComponents()
        {
            return levelComponents.ToArray();
        }
        public T? GetComponent<T>() where T : ILevelComponent
        {
            foreach (var comp in levelComponents)
            {
                if (comp is T tComp)
                    return tComp;
            }
            return default;
        }
        #endregion

        #region 生命周期
        public void Init(NamespaceID areaId, NamespaceID stageId, LevelOption option, int seed = 0)
        {
            Option = option;
            InitRandom(seed);

            ChangeArea(areaId);
            ChangeStage(stageId);

            Energy = this.GetStartEnergy();

            InitGrids(AreaDefinition);
        }
        public void Setup()
        {
            AreaDefinition.Setup(this);
            StageDefinition.Setup(this);
            Triggers.RunCallback(LevelCallbacks.POST_LEVEL_SETUP, new LevelCallbackParams(this));
        }
        public void Start()
        {
            foreach (var component in levelComponents)
            {
                component.OnStart();
            }
            StageDefinition.Start(this);
            Triggers.RunCallback(LevelCallbacks.POST_LEVEL_START, new LevelCallbackParams(this));
        }
        public void SetDifficulty(NamespaceID difficulty)
        {
            Difficulty = difficulty;
        }
        public void ChangeStage(NamespaceID stageId)
        {
            var definition = Content.GetStageDefinition(stageId);
            if (definition != null)
            {
                StageID = stageId;
                StageDefinition = definition;
                properties.ClearFallbackCaches();
            }
            else
            {
                var exception = new MissingDefinitionException($"Trying to set a missing stage definition {stageId} to the LevelEngine.");
                Debug.LogException(exception);
            }
        }
        public void ChangeArea(NamespaceID areaId)
        {
            var definition = Content.GetAreaDefinition(areaId);
            if (definition != null)
            {
                AreaID = areaId;
                AreaDefinition = definition;
                properties.ClearFallbackCaches();
            }
            else
            {
                var exception = new MissingDefinitionException($"Trying to set a missing area definition {areaId} to the LevelEngine.");
                Debug.LogException(exception);
            }
        }
        public void Update()
        {
            ClearEntityTrash();

            var rechargeSpeed = this.GetRechargeSpeed();
            UpdateClassicSeedPacks(rechargeSpeed);
            UpdateConveyorSeedPacks(rechargeSpeed);

            foreach (var component in levelComponents)
            {
                component.Update();
            }

            UpdateDelayedEnergyEntities();
            UpdateGrids();
            UpdateEntities();
            CollisionUpdate();

            buffs.Update();
            AreaDefinition.Update(this);
            StageDefinition.Update(this);
            Triggers.RunCallback(LevelCallbacks.POST_LEVEL_UPDATE, new LevelCallbackParams(this));
            AddLevelTime();
        }
        #endregion

        #region 属性
        public T? GetProperty<T>(PropertyKey<T> name, bool ignoreBuffs = false)
        {
            return properties.GetProperty<T>(name, ignoreBuffs);
        }
        public bool TryGetProperty<T>(PropertyKey<T> name, out T? value, bool ignoreBuffs = false)
        {
            return properties.TryGetProperty<T>(name, out value, ignoreBuffs);
        }
        public void SetProperty<T>(PropertyKey<T> name, T? value)
        {
            properties.SetProperty(name, value);
        }
        private void UpdateAllBuffedProperties(bool triggersEvaluation)
        {
            properties.UpdateAllModifiedProperties(triggersEvaluation);
        }
        private void UpdateBuffedProperty(IPropertyKey name)
        {
            properties.UpdateModifiedProperty(name);
        }
        bool IPropertyModifyTarget.GetFallbackProperty(IPropertyKey name, out object? value)
        {
            if (StageDefinition != null && StageDefinition.TryGetPropertyObject(name, out var stageProp))
            {
                value = stageProp;
                return true;
            }
            if (AreaDefinition != null && AreaDefinition.TryGetPropertyObject(name, out var areaProp))
            {
                value = areaProp;
                return true;
            }
            value = default;
            return false;
        }

        void IPropertyModifyTarget.GetModifierItems(IPropertyKey name, List<ModifierContainerItem> results)
        {
            buffs.GetModifierItems(name, results);
        }
        void IPropertyModifyTarget.UpdateModifiedProperty(IPropertyKey name, object? beforeValue, object? afterValue, bool triggersEvaluation)
        {
        }
        PropertyModifier[]? IPropertyModifyTarget.GetModifiersUsingProperty(IPropertyKey name)
        {
            return null;
        }
        IEnumerable<IPropertyKey> IPropertyModifyTarget.GetModifiedProperties()
        {
            return buffs.GetModifierPropertyNames();
        }
        #endregion

        #region 时间
        public int GetSecondTicks(float second)
        {
            return Mathf.CeilToInt(second * TPS);
        }
        #endregion

        #region 增益
        public BuffReference GetBuffReference(Buff buff) => new BuffReferenceLevel(buff.ID);
        public Buff CreateBuff<T>(long buffID) where T : BuffDefinition
        {
            var buffDefinition = Content.GetBuffDefinition<T>();
            return CreateBuff(buffDefinition, buffID);
        }
        public Buff CreateBuff(NamespaceID id, long buffID)
        {
            var buffDefinition = Content.GetBuffDefinition(id);
            if (buffDefinition == null)
                throw new MissingDefinitionException($"Trying to create a buff with missing definition {id}");
            return CreateBuff(buffDefinition, buffID);
        }
        public Buff CreateBuff(BuffDefinition buffDef, long buffID)
        {
            return new Buff(this, buffDef, buffID);
        }
        #endregion

        #region 序列化
        public SerializableLevel Serialize()
        {
            var level = new SerializableLevel()
            {
                stageDefinitionID = StageDefinition.GetID(),
                areaDefinitionID = AreaDefinition.GetID(),
                difficulty = Difficulty,
                Option = Option.Serialize(),

                properties = properties.ToSerializable(),
                currentSeedPackID = currentSeedPackID,
                collisionSystem = collisionSystem.ToSerializable(),

                energy = Energy,
                delayedEnergyEntities = delayedEnergyEntities.Select(d => new SerializableDelayedEnergy() { entityId = d.Key.ID, energy = d.Value }).ToArray(),

                currentWave = CurrentWave,
                currentFlag = CurrentFlag,
                waveState = WaveState,
                levelProgressVisible = LevelProgressVisible,

                buffs = buffs.ToSerializable(),

                components = levelComponents.ToDictionary(c => c.GetID().ToString(), c => c.ToSerializable())
            };
            WriteSeedPacksToSerializable(level);
            WriteConveyorToSerializable(level);
            WriteEntitiesToSerializable(level);
            WriteProgressToSerializable(level);
            WriteRandomToSerializable(level);
            WriteGridsToSerializable(level);
            return level;
        }
        public static LevelEngine Deserialize(SerializableLevel seri, IGameContent provider, IGameTriggerSystem triggers, ICollisionSystem collisionSystem)
        {
            var level = new LevelEngine(provider, triggers, collisionSystem);
            level.ReadProgressFromSerializable(seri);
            level.ReadRandomFromSerializable(seri);

            level.ChangeStage(seri.stageDefinitionID);
            level.ChangeArea(seri.areaDefinitionID);
            level.InitGrids(level.AreaDefinition);

            level.Difficulty = seri.difficulty;
            level.Option = LevelOption.Deserialize(seri.Option);
            level.properties = PropertyBlock.FromSerializable(seri.properties, level);

            level.Energy = seri.energy;

            level.CurrentWave = seri.currentWave;
            level.CurrentFlag = seri.currentFlag;
            level.WaveState = seri.waveState;
            level.LevelProgressVisible = seri.levelProgressVisible;

            // 加载所有种子包。
            level.currentSeedPackID = seri.currentSeedPackID;
            level.CreateSeedPacksFromSerializable(seri);
            level.CreateConveyorFromSerializable(seri);
            // 加载所有实体。
            level.CreateEntitiesFromSerializable(seri);
            // 加载所有网格。
            level.LoadGridsFromSerializable(seri);
            // 加载所有BUFF。
            level.buffs = BuffList.FromSerializable(seri.buffs, level, level);
            level.buffs.OnPropertyChanged += level.UpdateBuffedProperty;

            // 所有实体、种子包和BUFF都已加载完毕。


            // 加载所有种子包、实体、BUFF的详细信息。
            // 因为有光环这种东西的存在，可能会引用buff，所以需要在buff加载完之后加载。
            level.ReadSeedPacksFromSerializable(seri);
            level.ReadConveyorFromSerializable(seri);
            level.ReadEntitiesFromSerializable(seri);
            // 加载所有网格的属性，需要引用实体。
            level.ReadGridsFromSerializable(seri);
            level.buffs.LoadAuras(seri.buffs, level);

            // 在实体加载后面
            level.collisionSystem.LoadFromSerializable(level, seri.collisionSystem);

            level.delayedEnergyEntities.Clear();
            foreach (var item in seri.delayedEnergyEntities)
            {
                var key = level.FindEntityByID(item.entityId);
                if (key == null)
                    continue;
                level.delayedEnergyEntities.Add(key, item.energy);
            }
            level.UpdateAllBuffedProperties(false);

            return level;
        }
        public void DeserializeComponents(SerializableLevel seri)
        {
            foreach (var seriComp in seri.components)
            {
                var comp = levelComponents.FirstOrDefault(c => c.GetID().ToString() == seriComp.Key);
                if (comp == null)
                    continue;
                comp.LoadSerializable(seriComp.Value);
            }
        }
        #endregion

        #endregion

        #region 私有方法
        IModelInterface? IBuffTarget.GetInsertedModel(NamespaceID key) => null;
        LevelEngine IBuffTarget.GetLevel() => this;
        Entity? IBuffTarget.GetEntity() => null;
        bool IBuffTarget.Exists() => true;
        #endregion

        #region 属性字段
        public IGameContent Content { get; private set; }
        public NamespaceID StageID { get; private set; } = null!;
        public StageDefinition StageDefinition { get; private set; } = null!;
        public NamespaceID AreaID { get; private set; } = null!;
        public AreaDefinition AreaDefinition { get; private set; } = null!;
        public NamespaceID Difficulty { get; set; } = null!;
        public bool IsRerun { get; set; }
        public int TPS => Option.TPS;
        public LevelOption Option { get; private set; } = null!;
        BuffList IBuffTarget.Buffs => buffs;


        private PropertyBlock properties;
        private BuffList buffs = new BuffList();

        private List<ILevelComponent> levelComponents = new List<ILevelComponent>();
        #endregion 保存属性
    }
}