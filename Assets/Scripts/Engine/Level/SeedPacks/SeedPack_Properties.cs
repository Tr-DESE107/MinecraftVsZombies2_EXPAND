#nullable enable // autogenerated

using System.Collections.Generic;
using PVZEngine.Level;
using PVZEngine.Modifiers;

namespace PVZEngine.SeedPacks
{
    public partial class SeedPack
    {
        #region 属性
        public T? GetProperty<T>(PropertyKey<T> name, bool ignoreBuffs = false)
        {
            return properties.GetProperty<T>(name, ignoreBuffs);
        }
        public void SetProperty<T>(PropertyKey<T> name, T? value)
        {
            properties.SetProperty(name, value);
        }
        private void UpdateAllBuffedProperties(bool triggersEvaluation)
        {
            properties.UpdateAllModifiedProperties(triggersEvaluation);
        }
        private void UpdateBuffedProperty(IPropertyKey name)
        {
            properties.UpdateModifiedProperty(name);
        }
        bool IPropertyModifyTarget.GetFallbackProperty(IPropertyKey name, out object? value)
        {
            if (Definition != null && Definition.TryGetPropertyObject(name, out var prop))
            {
                value = prop;
                return true;
            }
            value = default;
            return false;
        }

        void IPropertyModifyTarget.GetModifierItems(IPropertyKey name, List<ModifierContainerItem> results)
        {
            buffs.GetModifierItems(name, results);
        }
        void IPropertyModifyTarget.OnPropertyChanged(IPropertyKey name, object? beforeValue, object? afterValue, bool triggersEvaluation)
        {
            OnPropertyChangedCallback(name, beforeValue, afterValue);
        }
        PropertyModifier[]? IPropertyModifyTarget.GetModifiersUsingProperty(IPropertyKey name)
        {
            return null;
        }
        IEnumerable<IPropertyKey> IPropertyModifyTarget.GetModifiedProperties()
        {
            return buffs.GetModifierPropertyNames();
        }
        #endregion

        #region 序列化
        protected void SavePropertiesToSerializable(SerializableSeedPack seri)
        {
            seri.properties = properties.ToSerializable();
        }
        protected void InitPropertiesFromSerializable(SerializableSeedPack seri)
        {
            properties = PropertyBlock.FromSerializable(seri.properties, this);
        }
        #endregion

        private void OnPropertyChangedCallback(IPropertyKey key, object? before, object? after)
        {
            properties.RemoveFallbackCache(key);
        }

        #region 属性字段
        private PropertyBlock properties;
        #endregion
    }
}
