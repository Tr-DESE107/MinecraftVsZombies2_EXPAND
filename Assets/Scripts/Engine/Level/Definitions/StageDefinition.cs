#nullable enable // autogenerated

using System;
using System.Collections.Generic;
using PVZEngine.Base;
using PVZEngine.Entities;
using PVZEngine.Level;
using UnityEngine;

namespace PVZEngine.Definitions
{
    public abstract class StageDefinition : Definition
    {
        public StageDefinition(string nsp, string name) : base(nsp, name)
        {
            SetProperty(EngineStageProps.WAVES_PER_FLAG, 10);
            SetProperty(EngineLevelProps.RECHARGE_SPEED, 1f);
        }
        private void ExecuteBehaviours(Action<StageBehaviour> action, string debugName)
        {
            foreach (var b in behaviours)
            {
                try
                {
                    action(b);
                }
                catch (Exception ex)
                {
                    Debug.LogError($"关卡行为{b}在执行{debugName}时出现错误：{ex}");
                }
            }
        }
        public void Setup(LevelEngine level)
        {
            ExecuteBehaviours(b => b.Setup(level), "Setup");
            OnSetup(level);
        }
        public void Start(LevelEngine level)
        {
            ExecuteBehaviours(b => b.Start(level), "Start");
            OnStart(level);
        }
        public void Update(LevelEngine level)
        {
            ExecuteBehaviours(b => b.Update(level), "Update");
            OnUpdate(level);
        }
        public void PrepareForBattle(LevelEngine level)
        {
            ExecuteBehaviours(b => b.PrepareForBattle(level), "PrepareForBattle");
            OnPrepareForBattle(level);
        }
        public void PostWave(LevelEngine level, int wave)
        {
            ExecuteBehaviours(b => b.PostWave(level, wave), "PostWave");
            OnPostWave(level, wave);
        }
        public void PostHugeWaveEvent(LevelEngine level)
        {
            ExecuteBehaviours(b => b.PostHugeWaveEvent(level), "PostHugeWaveEvent");
            OnPostHugeWave(level);
        }
        public void PostFinalWaveEvent(LevelEngine level)
        {
            ExecuteBehaviours(b => b.PostFinalWaveEvent(level), "PostFinalWaveEvent");
            OnPostFinalWave(level);
        }
        public void PostEnemySpawned(Entity entity)
        {
            ExecuteBehaviours(b => b.PostEnemySpawned(entity), "PostEnemySpawned");
            OnPostEnemySpawned(entity);
        }
        public virtual void OnSetup(LevelEngine level) { }
        public virtual void OnStart(LevelEngine level) { }
        public virtual void OnUpdate(LevelEngine level) { }
        public virtual void OnPrepareForBattle(LevelEngine level) { }
        public virtual void OnPostWave(LevelEngine level, int wave) { }
        public virtual void OnPostHugeWave(LevelEngine level) { }
        public virtual void OnPostFinalWave(LevelEngine level) { }
        public virtual void OnPostEnemySpawned(Entity entity) { }
        protected void AddBehaviour(StageBehaviour behaviour)
        {
            behaviours.Add(behaviour);
        }
        public bool HasBehaviour<T>() where T : StageBehaviour
        {
            foreach (var behaviour in behaviours)
            {
                if (behaviour is T tBehaviour)
                    return true;
            }
            return false;
        }
        public T? GetBehaviour<T>() where T : StageBehaviour
        {
            foreach (var behaviour in behaviours)
            {
                if (behaviour is T tBehaviour)
                    return tBehaviour;
            }
            return null;
        }
        public sealed override string GetDefinitionType() => EngineDefinitionTypes.STAGE;
        private List<StageBehaviour> behaviours = new List<StageBehaviour>();
    }
}
