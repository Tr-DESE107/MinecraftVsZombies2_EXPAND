#nullable enable // autogenerated

using System.Linq;
using PVZEngine.Auras;
using PVZEngine.Buffs;
using PVZEngine.Level;
using PVZEngine.Modifiers;

namespace PVZEngine.Entities
{
    public sealed partial class Entity : IAuraSource, IModifierContainer, IPropertyModifyTarget, ILevelSourceTarget, IModeledBuffTarget
    {
        #region 光环
        public AuraEffect GetAuraEffect<T>() where T : AuraEffectDefinition
        {
            return auras.Get<T>();
        }
        public AuraEffect[] GetAuraEffects()
        {
            return auras.GetAll();
        }
        private void CreateAuraEffects()
        {
            var auraDefs = Definition.GetAuras();
            for (int i = 0; i < auraDefs.Length; i++)
            {
                var auraDef = auraDefs[i];
                auras.Add(Level, new AuraEffect(auraDef, i, this));
            }
        }
        private void UpdateAuras()
        {
            auras.Update();
        }
        #endregion

        #region 序列化
        private void LoadAurasFromSerializable(SerializableEntity seri)
        {
            CreateAuraEffects();
            if (seri.auras != null)
                auras.LoadFromSerializable(Level, seri.auras);

            if (seri.buffs != null)
                buffs.LoadAuras(seri.buffs, Level);

            foreach (var pair in armorDict)
            {
                var armor = pair.Value;
                if (armor == null || seri.armors == null)
                    continue;
                var seriArmor = seri.armors.Values.FirstOrDefault(a => a.slot == pair.Key);
                if (seriArmor == null)
                    continue;
                armor.LoadAuras(seriArmor);
            }
        }
        #endregion

        #region 属性字段
        private AuraEffectList auras = new AuraEffectList();
        #endregion
    }
}