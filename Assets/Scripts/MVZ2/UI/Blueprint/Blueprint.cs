#nullable enable // autogenerated

using System;
using MVZ2.HeldItems;
using MVZ2.Level;
using MVZ2.Managers;
using MVZ2.Models;
using MVZ2Logic;
using MVZ2Logic.HeldItems;
using PVZEngine.Level;
using TMPro;
using UnityEngine;
using UnityEngine.EventSystems;
using UnityEngine.UI;

namespace MVZ2.UI
{
    public class Blueprint : MonoBehaviour, ILevelRaycastReceiver, ITooltipTarget
    {
        public void UpdateView(BlueprintViewData viewData)
        {
            SetEmpty(viewData.empty);
            SetCost(viewData.cost);
            SetTriggerActive(viewData.triggerActive);

            // Styles.
            if (standaloneBackground) standaloneBackground.sprite = viewData.standaloneBackground;
            if (mobileBackground) mobileBackground.sprite = viewData.mobileBackground;
            if (mobileFrameTop) mobileFrameTop.sprite = viewData.mobileFrameTop;
            if (mobileFrameBottom) mobileFrameBottom.sprite = viewData.mobileFrameBottom;

            var icon = viewData.icon;
            iconImage.enabled = icon && !viewData.iconGrayscale;
            iconImage.sprite = icon;
            iconImageCommandBlock.enabled = icon && viewData.iconGrayscale;
            iconImageCommandBlock.sprite = icon;
        }
        public void SetEmpty(bool empty)
        {
            emptyObj.SetActive(empty);
            rootObj.SetActive(!empty);
        }
        public void SetCost(string cost)
        {
            costText.text = cost;
        }
        public void SetTriggerActive(bool active)
        {
            triggerCostObject.SetActive(active);
        }
        public void SetHotkeyText(string hotkey)
        {
            if (hotkeyText)
                hotkeyText.text = hotkey;
        }
        public void SetRecharge(float charge)
        {
            rechargeImage.fillAmount = charge;
        }
        public void RechargeFlash()
        {
            rechargeFlashAlpha = 1;
            UpdateRechargeFlash();
        }
        public void UpdateAnimation(float deltaTime)
        {
            rechargeFlashAlpha = Mathf.Clamp01(rechargeFlashAlpha - deltaTime / rechargeFlashTime);
            UpdateRechargeFlash();
        }
        public void SetDisabled(bool disabled)
        {
            disabledObject.SetActive(disabled);
        }
        public void SetSelected(bool selected)
        {
            selectedObject.SetActive(selected);
        }
        public void SetTwinkleAlpha(float alpha)
        {
            var color = twinkleImage.color;
            color.a = alpha;
            twinkleImage.color = color;
        }
        private void Awake()
        {
            holdStreakHandler.OnPointerInteraction += (_, d, i) => CallPointerInteraction(d, i);
        }
        private void UpdateRechargeFlash()
        {
            var color = rechargeFlashImage.color;
            color.a = rechargeFlashAlpha;
            rechargeFlashImage.color = color;
        }
        bool ILevelRaycastReceiver.IsValidReceiver(LevelEngine level, HeldItemDefinition definition, IHeldItemData data, PointerEventData eventData)
        {
            if (definition == null)
                return false;
            if (Index < 0)
                return false;
            var target = new HeldItemTargetBlueprint(level, Index, IsInConveyor);
            var pointer = InputManager.GetPointerDataFromEventData(eventData);
            return definition.IsValidFor(target, data, pointer);
        }
        int ILevelRaycastReceiver.GetSortingLayer()
        {
            var rectTrans = transform as RectTransform;
            var canvas = rectTrans?.GetRootCanvas();
            if (!canvas.Exists())
                return 0;
            return canvas.sortingLayerID;
        }
        int ILevelRaycastReceiver.GetSortingOrder()
        {
            var rectTrans = transform as RectTransform;
            var canvas = rectTrans?.GetRootCanvas();
            if (!canvas.Exists())
                return 0;
            return canvas.sortingOrder;
        }
        private void CallPointerInteraction(PointerEventData eventData, PointerInteraction interaction)
        {
            OnPointerInteraction?.Invoke(this, eventData, interaction);
            if (interaction == selectInteraction)
            {
                OnSelect?.Invoke(this, eventData);
            }
        }
        public event Action<Blueprint, PointerEventData, PointerInteraction>? OnPointerInteraction;
        public event Action<Blueprint, PointerEventData>? OnSelect;
        ITooltipAnchor ITooltipTarget.Anchor => tooltipAnchor;
        public UIModel Model => model;
        public int Index { get; set; } = -1;
        public bool IsInConveyor { get; set; }
        private float rechargeFlashAlpha = 0;
        [SerializeField]
        private PointerInteraction selectInteraction = PointerInteraction.Down;
        [SerializeField]
        private LevelPointerInteractionHandler holdStreakHandler = null!;
        [SerializeField]
        private GameObject emptyObj = null!;
        [SerializeField]
        private GameObject rootObj = null!;

        [Header("Styles (Standalone)")]
        [SerializeField]
        private Image standaloneBackground = null!;

        [Header("Styles (Mobile)")]
        [SerializeField]
        private Image mobileBackground = null!;
        [SerializeField]
        private Image mobileFrameTop = null!;
        [SerializeField]
        private Image mobileFrameBottom = null!;

        [Header("Elements")]
        [SerializeField]
        private Image iconImage = null!;
        [SerializeField]
        private Image iconImageCommandBlock = null!;
        [SerializeField]
        private GameObject triggerCostObject = null!;
        [SerializeField]
        private TextMeshProUGUI costText = null!;

        [Header("Overlays")]
        [SerializeField]
        private Image twinkleImage = null!;
        [SerializeField]
        private Image rechargeImage = null!;
        [SerializeField]
        private Image rechargeFlashImage = null!;
        [SerializeField]
        private float rechargeFlashTime = 0.5f;
        [SerializeField]
        private GameObject selectedObject = null!;
        [SerializeField]
        private GameObject disabledObject = null!;
        [SerializeField]
        private TextMeshProUGUI hotkeyText = null!;

        [Header("Miscs")]
        [SerializeField]
        private UIModel model = null!;
        [SerializeField]
        private TooltipAnchor tooltipAnchor = null!;

    }
    public struct BlueprintViewData
    {
        public bool empty;
        public string cost;
        public Sprite? icon;
        public bool triggerActive;
        public bool iconGrayscale;

        // Styles.
        public Sprite? standaloneBackground;
        public Sprite? mobileBackground;
        public Sprite? mobileFrameTop;
        public Sprite? mobileFrameBottom;

        public static readonly BlueprintViewData Empty = new BlueprintViewData { empty = true };
    }
}
