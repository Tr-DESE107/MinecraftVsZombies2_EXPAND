#nullable enable // autogenerated

using System;
using System.Linq;
using System.Text;
using MVZ2.GameContent.Contraptions;
using MVZ2.Metas;
using MVZ2.UI;
using MVZ2.Vanilla;
using MVZ2.Vanilla.Contraptions;
using MVZ2.Vanilla.Level;
using MVZ2.Vanilla.SeedPacks;
using MVZ2Logic;
using MVZ2Logic.Blueprints;
using MVZ2Logic.Callbacks;
using MVZ2Logic.Games;
using MVZ2Logic.SeedPacks;
using PVZEngine;
using PVZEngine.Callbacks;
using PVZEngine.Definitions;
using PVZEngine.Level;
using PVZEngine.SeedPacks;
using UnityEngine;

namespace MVZ2.Managers
{
    public partial class ResourceManager : MonoBehaviour
    {
        public BlueprintMetaList? GetBlueprintMetaList(string spaceName)
        {
            var modResource = GetModResource(spaceName);
            if (modResource == null)
                return null;
            return modResource.BlueprintMetaList;
        }
        #region 选项
        public BlueprintOptionMeta[] GetModBlueprintOptionMetas(string spaceName)
        {
            var metalist = GetBlueprintMetaList(spaceName);
            if (metalist == null)
                return Array.Empty<BlueprintOptionMeta>();
            return metalist.Options.ToArray();
        }
        public BlueprintEntityMeta[] GetModEntityBlueprintMetas(string spaceName)
        {
            var metalist = GetBlueprintMetaList(spaceName);
            if (metalist == null)
                return Array.Empty<BlueprintEntityMeta>();
            return metalist.Entities.ToArray();
        }
        public BlueprintErrorMeta[] GetModBlueprintErrorMetas(string nsp)
        {
            var modResource = main.ResourceManager.GetModResource(nsp);
            if (modResource?.BlueprintMetaList == null)
                return Array.Empty<BlueprintErrorMeta>();
            return modResource.BlueprintMetaList.Errors;
        }
        #endregion

        #region 样式

        public BlueprintStyleMeta? GetBlueprintStyleMeta(NamespaceID id)
        {
            if (!NamespaceID.IsValid(id))
                return null;
            var metalist = GetBlueprintMetaList(id.SpaceName);
            if (metalist == null)
                return null;
            return metalist.Styles.FirstOrDefault(s => s.ID == id.Path);
        }
        #endregion

        public BlueprintViewData GetBlueprintViewData(SeedPack seed)
        {
            if (seed == null)
                return BlueprintViewData.Empty;
            var viewData = GetBlueprintViewData(seed.Definition, seed.Level.IsEndless(), seed.IsCommandBlock());
            viewData.cost = seed.GetCost().ToString();
            return viewData;
        }
        public BlueprintViewData GetBlueprintViewData(SeedDefinition seedDef, bool isEndless, bool isCommandBlock = false)
        {
            var sprite = GetBlueprintIcon(seedDef);
            string costStr = string.Empty;

            var seedID = seedDef.GetID();
            bool commandBlock = seedID == VanillaContraptionID.commandBlock;
            if (!commandBlock)
            {
                var costSB = new StringBuilder();
                costSB.Append(seedDef.GetCost());
                if (seedDef.IsUpgradeBlueprint() && isEndless)
                {
                    costSB.Append("+");
                }
                costStr = costSB.ToString();
            }

            var viewData = new BlueprintViewData()
            {
                icon = sprite,
                cost = costStr,
                triggerActive = seedDef.IsTriggerActive(),
                iconGrayscale = isCommandBlock
            };
            var styleID = GetBlueprintStyleID(seedDef, isCommandBlock);
            var styleMeta = GetBlueprintStyleMeta(styleID);
            SetBlueprintViewDataStyle(ref viewData, styleMeta);
            return viewData;
        }
        public BlueprintViewData GetBlueprintViewData(NamespaceID? seedID, bool isEndless, bool isCommandBlock = false)
        {
            if (NamespaceID.IsValid(seedID))
            {
                var definition = main.Game.GetSeedDefinition(seedID);
                if (definition != null)
                {
                    return GetBlueprintViewData(definition, isEndless, isCommandBlock);
                }
            }
            return GetDefaultBlueprintViewData(isCommandBlock);
        }
        public BlueprintViewData GetDefaultBlueprintViewData(bool isCommandBlock = false)
        {
            var viewData = new BlueprintViewData()
            {
                triggerActive = false,
                cost = "0",
                icon = GetDefaultSprite(),
                iconGrayscale = isCommandBlock,
            };
            var styleID = isCommandBlock ? LogicBlueprintStyles.normal : LogicBlueprintStyles.commandBlock;
            var styleMeta = GetBlueprintStyleMeta(styleID);
            SetBlueprintViewDataStyle(ref viewData, styleMeta);
            return viewData;
        }
        public string GetBlueprintName(NamespaceID blueprintID, bool commandBlock)
        {
            string name = main.Game.GetBlueprintName(blueprintID);
            if (commandBlock)
            {
                name = Global.Localization.GetTextParticular(name, VanillaStrings.COMMAND_BLOCK_BLUEPRINT_NAME_TEMPLATE);
            }
            return name;
        }
        public string GetBlueprintTooltip(NamespaceID blueprintID)
        {
            return main.Game.GetBlueprintTooltip(blueprintID);
        }
        public Sprite? GetBlueprintIconMobile(SeedDefinition seedDef)
        {
            if (seedDef != null)
            {
                var sprRef = seedDef.GetMobileIcon();
                if (sprRef == null)
                    return null;
                return Main.GetFinalSprite(sprRef);
            }
            return GetDefaultSprite();
        }
        public Sprite? GetBlueprintIconStandalone(SeedDefinition seedDef)
        {
            if (seedDef != null)
            {
                Sprite? sprite = null;

                var iconRef = seedDef.GetIcon();
                if (iconRef != null)
                    sprite = Main.GetFinalSprite(iconRef);

                if (sprite)
                    return sprite;

                var seedModelIcon = seedDef.GetModelID();
                if (seedModelIcon != null)
                    sprite = GetModelIcon(seedModelIcon);

                return sprite;
            }
            return GetDefaultSprite();
        }
        public Sprite? GetBlueprintIcon(SeedDefinition seedDef)
        {
            return Main.IsMobile() ? GetBlueprintIconMobile(seedDef) : GetBlueprintIconStandalone(seedDef);
        }
        private NamespaceID GetBlueprintStyleID(SeedDefinition seedDef, bool isCommandBlock)
        {
            var defaultValue = LogicBlueprintStyles.normal;
            var result = new CallbackResult();
            result.SetValue(defaultValue);
            var args = new LogicCallbacks.GetBlueprintStyleParams(seedDef, isCommandBlock);
            Global.Game.RunCallbackWithResultFiltered(LogicCallbacks.GET_BLUEPRINT_STYLE, args, result, seedDef);

            return result.GetValue<NamespaceID>() ?? defaultValue;
        }
        private void SetBlueprintViewDataStyle(ref BlueprintViewData viewData, BlueprintStyleMeta? styleMeta)
        {
            var main = Main;
            viewData.standaloneBackground = main.GetFinalSprite(styleMeta?.StandaloneBackground);
            viewData.mobileBackground = main.GetFinalSprite(styleMeta?.MobileBackground);
            viewData.mobileFrameTop = main.GetFinalSprite(styleMeta?.MobileFrameTop);
            viewData.mobileFrameBottom = main.GetFinalSprite(styleMeta?.MobileFrameBottom);
        }
    }
}
