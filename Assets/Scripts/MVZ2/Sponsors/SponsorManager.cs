#nullable enable // autogenerated

using System;
using System.Collections.Generic;
using System.Diagnostics.CodeAnalysis;
using System.IO;
using System.Linq;
using System.Security.Cryptography;
using System.Text;
using System.Threading.Tasks;
using MongoDB.Bson;
using MongoDB.Bson.Serialization;
using MVZ2.IO;
using MVZ2.Managers;
using UnityEngine;
using UnityEngine.Networking;

namespace MVZ2.Supporters
{
    public class SponsorManager : MonoBehaviour
    {
        public async Task PullSponsors(TaskProgress progress)
        {
            SponsorInfos? sponserCache = null;
            try
            {
                sponserCache = LoadSponsorsCache();
            }
            catch (Exception e)
            {
                Debug.LogError($"加载赞助者名单缓存时出现错误：{e}");
            }
            try
            {
                if (!ShouldRepull(sponserCache))
                {
                    SetCurrentSponsorInfos(sponserCache);
                    progress.SetProgress(1, "No need to pull");
                    return;
                }
                var items = await GetAllSponsors(progress);
                sponserCache = new SponsorInfos(items);
                sponserCache.lastUpdateTime = DateTimeOffset.UtcNow.ToUnixTimeSeconds();
                SetCurrentSponsorInfos(sponserCache);
                SaveSponsorsCache(sponserCache);
            }
            catch (Exception e)
            {
                Debug.LogError($"更新赞助者名单时出现错误：{e}");
            }
        }
        public string[] GetSponsorPlanNames(int rankType, int rank)
        {
            if (currentSponsors == null)
                return Array.Empty<string>();
            return currentSponsors.sponsors.Where(s => s.plans.Any(p => p.rankType == rankType && p.rank >= rank)).Select(s => s.name).ToArray();
        }
        public bool HasSponsorPlan(string name, int rankType, int rank)
        {
            if (currentSponsors == null)
                return false;
            return currentSponsors.sponsors.Any(s => s.name == name && s.plans.Any(p => p.rankType == rankType && p.rank >= rank));
        }
        private async Task<SponsorItem[]> GetAllSponsors(TaskProgress progress)
        {
            List<SponsorItem> sponsorList = new List<SponsorItem>();
            int numPerPage = 100;
            progress.SetProgress(0, "Page 1");
            var resp = await RequestSponsors(1, numPerPage);
            if (resp.Result == null)
            {
                return Array.Empty<SponsorItem>();
            }
            if (resp.Result.List is SponsorItem[] items)
            {
                sponsorList.AddRange(items);
            }
            var totalPage = resp.Result.TotalPage;

            for (int i = 2; i <= totalPage; i++)
            {
                progress.SetProgress((i - 1) / (float)totalPage, $"Page {i}");
                var obj = await RequestSponsors(i, numPerPage);
                if (obj.Result?.List != null)
                {
                    sponsorList.AddRange(obj.Result.List);
                }
            }
            progress.SetProgress(1, "Finished");

            return sponsorList.ToArray();
        }
        private async Task<GenericResp<ItemList<SponsorItem>>> RequestSponsors(int page = 0, int numPerPage = 100, int[]? targetUserID = null)
        {
            SponsorQueryParams sponsorParams = new SponsorQueryParams(page, numPerPage, targetUserID);
            var param = JsonUtility.ToJson(sponsorParams);
            var url = baseUrl + sponsorQueryPath;
            var json = await RequestText(url, param);

            return BsonSerializer.Deserialize<GenericResp<ItemList<SponsorItem>>>(json);
        }
        private void ErrorHandler(UnityWebRequest request)
        {
            if (request.result == UnityWebRequest.Result.ConnectionError)
            {
                throw new SponsorNetworkException("无法连接至赞助者服务器。");
            }
            if (request.result == UnityWebRequest.Result.ProtocolError)
            {
                throw new SponsorNetworkException("赞助者服务器发送了一个错误响应。");
            }
            if (request.result == UnityWebRequest.Result.DataProcessingError)
            {
                throw new SponsorNetworkException("处理赞助者服务器发送的数据时发生错误。");
            }
            if (request.result != UnityWebRequest.Result.Success)
            {
                throw new SponsorNetworkException("发生未知错误。");
            }
        }
        private async Task<string> RequestText(string url, string param)
        {
            var request = await Request(url, param);
            var result = request.downloadHandler.text;
            request.Dispose();
            return result;
        }
        private async Task<UnityWebRequest> Request(string url, string param)
        {
            var timestamp = DateTimeOffset.UtcNow.ToUnixTimeSeconds().ToString();

            var token = DecryptToken();
            var strToCalc = token + "params" + param + "ts" + timestamp + "user_id" + userID;
            var hash = MD5.Create().ComputeHash(Encoding.UTF8.GetBytes(strToCalc));
            var hashStr = string.Concat(hash.Select(b => b.ToString("x2")).ToArray());

            var wwwForm = new WWWForm();
            wwwForm.AddField("user_id", userID);
            wwwForm.AddField("params", param);
            wwwForm.AddField("ts", timestamp);
            wwwForm.AddField("sign", hashStr);
            var request = UnityWebRequest.Post(url, wwwForm);

            request.timeout = responseTimeout;

            var tcs = new TaskCompletionSource<AsyncOperation>();

            var requestOp = request.SendWebRequest();
            requestOp.completed += (op) =>
            {
                tcs.SetResult(op);
            };

            await tcs.Task;

            ErrorHandler(request);

            return request;
        }

        private SponsorInfos? LoadSponsorsCache()
        {
            var path = GetSponsorCacheFilePath();
            if (!File.Exists(path))
            {
                return null;
            }
            var json = Main.FileManager.ReadStringFile(path);
            return BsonSerializer.Deserialize<SponsorInfos>(json);
        }
        private void SaveSponsorsCache(SponsorInfos saveInfo)
        {
            var path = GetSponsorCacheFilePath();
            FileHelper.ValidateDirectory(path);
            var json = saveInfo.ToJson();
            Main.FileManager.WriteStringFile(path, json);
        }
        private bool ShouldRepull([NotNullWhen(false)] SponsorInfos? infos)
        {
            if (infos == null)
                return true;
            var lastTime = DateTimeOffset.FromUnixTimeSeconds(infos.lastUpdateTime).LocalDateTime;
            var nowTime = DateTimeOffset.Now;
            if (nowTime.Date != lastTime.Date)
            {
                return true;
            }
            return false;
        }
        private string GetSponsorCacheFilePath()
        {
            return Path.Combine(Application.persistentDataPath, "sponsors.dat");
        }
        private void SetCurrentSponsorInfos(SponsorInfos infos)
        {
            currentSponsors = infos;
        }
        #region 解密
        private string DecryptToken()
        {
            try
            {
                return Decrypt(apiToken, key, iv);
            }
            catch (Exception ex)
            {
                Console.WriteLine("解密失败: " + ex.Message);
                return string.Empty;
            }
        }
        private static string Decrypt(string encryptedText, byte[] aesKey, byte[] aesIV)
        {
            try
            {
                byte[] aesEncryptedData = Convert.FromBase64String(encryptedText);
                string decryptedText = AesDecrypt(aesEncryptedData, aesKey, aesIV);
                return decryptedText;
            }
            catch (FormatException)
            {
                throw new ArgumentException("Base64格式无效");
            }
            catch (CryptographicException ex)
            {
                throw new ArgumentException("AES解密失败: " + ex.Message);
            }
        }
        private static string AesDecrypt(byte[] encryptedData, byte[] key, byte[] iv)
        {
            using (Aes aesAlg = Aes.Create())
            {
                aesAlg.Key = key;
                aesAlg.IV = iv;
                aesAlg.Mode = CipherMode.CBC;
                aesAlg.Padding = PaddingMode.PKCS7;

                using (ICryptoTransform decryptor = aesAlg.CreateDecryptor(aesAlg.Key, aesAlg.IV))
                using (MemoryStream msDecrypt = new MemoryStream(encryptedData))
                using (CryptoStream csDecrypt = new CryptoStream(msDecrypt, decryptor, CryptoStreamMode.Read))
                using (StreamReader srDecrypt = new StreamReader(csDecrypt))
                {
                    return srDecrypt.ReadToEnd();
                }
            }
        }
        #endregion

        public MainManager Main => MainManager.Instance;
        private SponsorInfos? currentSponsors;
        [SerializeField]
        private string userID = string.Empty;
        [SerializeField]
        private string apiToken = string.Empty;
        [SerializeField]
        private string baseUrl = "https://afdian.com/api";
        [SerializeField]
        private string sponsorQueryPath = "/open/query-sponsor";
        [SerializeField]
        private int responseTimeout = 10;
        private byte[] key = new byte[] {
            0x58, 0x11, 0x58, 0x11, 0x53, 0x10, 0x53, 0x10,
            0x58, 0x11, 0x58, 0x11, 0x53, 0x10, 0x53, 0x10
        };
        private byte[] iv = new byte[] {
            0x11, 0x45, 0x14, 0x19, 0x19, 0x81, 0x08, 0x10,
            0x11, 0x45, 0x14, 0x19, 0x19, 0x81, 0x08, 0x10
        };
    }
}
