#nullable enable // autogenerated

using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using MVZ2.GlobalGames;
using MVZ2.Level;
using MVZ2.Managers;
using MVZ2Logic.Modding;
using UnityEngine;
using UnityEngine.AddressableAssets;

namespace MVZ2.Modding
{
    public class ModManager : MonoBehaviour, IModManager
    {
        public async Task LoadModInfos(GlobalGame game)
        {
            var locator = await Addressables.InitializeAsync().Task;
            modInfos.Add(new ModInfo()
            {
                Namespace = main.BuiltinNamespace,
                LevelDataVersion = LevelManager.CURRENT_DATA_VERSION,
                DisplayName = "Vanilla",
                CatalogPath = null,
                IsBuiltin = true,
                ResourceLocator = locator,
            });
        }
        public void InitModLogics(GlobalGame game)
        {
            OnRegisterMods?.Invoke(this);

            foreach (var modInfo in modInfos)
            {
                modInfo.Logic.LateInit(game);
            }
        }
        public void LoadModLogics(GlobalGame game)
        {
            foreach (var modInfo in modInfos)
            {
                game.AddMod(modInfo.Logic);
            }
        }
        public void PostReloadMods(GlobalGame game)
        {
            foreach (var modInfo in GetAllModInfos())
            {
                modInfo.Logic.PostReloadMods(game);
            }
        }
        public void PostGameInit()
        {
            foreach (var modInfo in GetAllModInfos())
            {
                modInfo.Logic.PostGameInit();
            }
        }
        void IModManager.RegisterMod(IModLogic logic)
        {
            var modInfo = GetModInfo(logic.Namespace);
            if (modInfo == null)
                return;
            modInfo.Logic = logic;
        }
        public ModInfo GetModInfo(string nsp)
        {
            return modInfos.FirstOrDefault(m => m.Namespace == nsp);
        }
        public ModInfo[] GetAllModInfos()
        {
            return modInfos.ToArray();
        }
        public static event Action<IModManager> OnRegisterMods;
        public MainManager Main => main;
        [SerializeField]
        private MainManager main;
        private List<ModInfo> modInfos = new List<ModInfo>();

    }
    public interface IModManager
    {
        void RegisterMod(IModLogic logic);
    }
}
