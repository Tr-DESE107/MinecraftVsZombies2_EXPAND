#nullable enable // autogenerated

using System;
using System.Linq;
using System.Reflection;
using MVZ2.GameContent.Enemies;
using MVZ2.GameContent.Seeds;
using MVZ2.GameContent.Spawns;
using MVZ2.GameContent.Stages;
using MVZ2.Managers;
using MVZ2.Metas;
using MVZ2.Vanilla.Contraptions;
using MVZ2.Vanilla.Entities;
using MVZ2.Vanilla.Level;
using MVZ2.Vanilla.SeedPacks;
using MVZ2Logic;
using MVZ2Logic.Armors;
using MVZ2Logic.Artifacts;
using MVZ2Logic.Commands;
using MVZ2Logic.Conditions;
using MVZ2Logic.Debugs;
using MVZ2Logic.Difficulties;
using MVZ2Logic.Entities;
using MVZ2Logic.Errors;
using MVZ2Logic.Games;
using MVZ2Logic.Level;
using MVZ2Logic.Modding;
using MVZ2Logic.Notes;
using MVZ2Logic.SeedPacks;
using PVZEngine;
using PVZEngine.Base;
using PVZEngine.Buffs;
using PVZEngine.Definitions;
using PVZEngine.Level;
using UnityEngine;

namespace MVZ2.Modding
{
    public class ModLoader
    {
        public ModLoader(MainManager main)
        {
            this.main = main;
        }
        public void Load(Mod mod, Assembly[] assemblies)
        {
            LoadAssemblies(mod, assemblies);

            LoadDefinitions(mod);

            LoadDefinitionProperties(mod);
        }

        #region 初始化
        private void LoadAssemblies(Mod mod, Assembly[] assemblies)
        {
            var nsp = mod.Namespace;
            foreach (var assembly in assemblies)
            {
                var types = assembly.GetTypes();
                PropertyMapper.InitPropertyMaps(nsp, types);
            }

            foreach (var assembly in assemblies)
            {
                var types = assembly.GetTypes();
                foreach (var type in types)
                {
                    if (type.GetCustomAttribute<ModGlobalCallbacksAttribute>() != null && !type.IsAbstract)
                    {
                        var instance = Activator.CreateInstance(type);
                        if (instance is IGlobalCallbacks globalCallbacks)
                        {
                            mod.ApplyGlobalCallbacks(globalCallbacks);
                        }
                    }

                    if (type.GetCustomAttribute<DefinitionAttribute>() is DefinitionAttribute definitionAttr && !type.IsAbstract)
                    {
                        var name = definitionAttr.Name;
                        var constructor = type.GetConstructor(new Type[] { typeof(string), typeof(string) });
                        var instance = constructor?.Invoke(new object[] { nsp, name });
                        if (instance is Definition def)
                        {
                            mod.AddDefinition(def);
                        }
                    }

                }
            }
        }
        #endregion

        #region 加载Definitions
        private void LoadDefinitions(Mod mod)
        {
            // 以下这这些没有相关联的定义类型，必须要手动创建。
            // 加载所有实体。
            LoadEntityMetas(mod);
            // 加载所有实体对策。
            LoadEntityCounterMetas(mod);
            // 加载所有实体形状。
            LoadEntityShapes(mod);

            // 加载所有护甲。
            LoadArmorMetas(mod);
            LoadArmorSlotMetas(mod);
            // 加载所有敌人生成信息。
            LoadSpawnMetas(mod);

            // 加载所有网格层信息。
            LoadGridLayerMetas(mod);
            // 加载所有网格错误信息。
            LoadGridErrorMetas(mod);

            // 加载所有难度。
            LoadDifficultyMetas(mod);

            // 加载所有关卡Meta。
            LoadStages(mod);

            LoadCustomEntityBlueprints(mod);
            // 加载所有蓝图错误信息。
            LoadBlueprintErrorMetas(mod);
            // 加载所有增益信息。
            LoadBuffMetas(mod);
        }
        private void LoadEntityMetas(Mod mod)
        {
            var nsp = mod.Namespace;
            foreach (EntityMeta meta in res.GetModEntityMetas(nsp))
            {
                if (meta == null)
                    continue;
                var name = meta.ID;
                var def = new MetaEntityDefinition(meta.Type, nsp, name);
                var entityID = def.GetID();

                def.SetProperty(LogicEntityProps.NAME, meta.Name);
                def.SetProperty(LogicEntityProps.DEATH_MESSAGE, meta.DeathMessage);
                def.SetProperty(LogicEntityProps.TOOLTIP, meta.Tooltip);
                def.SetProperty(LogicEntityProps.UNLOCK, meta.Unlock);
                // 加载实体的属性。
                foreach (var pair in meta.Properties)
                {
                    def.SetPropertyObject(PropertyMapper.ConvertFromName(pair.Key), pair.Value);
                }
                foreach (var behaviourID in meta.Behaviours)
                {
                    def.AddBehaviourID(behaviourID);
                }
                mod.AddDefinition(def);

                // 将实体作为蓝图添加到游戏中。
                var mobileID = new NamespaceID(entityID.SpaceName, $"mobile_blueprint/{entityID.Path}");
                var info = new EntitySeedInfo()
                {
                    entityID = entityID,
                    cost = def.GetCost(),
                    rechargeID = def.GetRechargeID(),
                    triggerActive = def.IsTriggerActive(),
                    canInstantTrigger = def.CanInstantTrigger(),
                    upgrade = def.IsUpgradeBlueprint(),
                    canInstantEvoke = def.CanInstantEvoke(),
                    model = def.GetModelID(),
                    mobileIcon = new SpriteReference(mobileID)
                };
                var blueprintID = VanillaBlueprintID.FromEntity(entityID);
                var seedDef = new EntitySeed(blueprintID.SpaceName, blueprintID.Path, info);
                mod.AddDefinition(seedDef);
            }
        }
        private void LoadEntityCounterMetas(Mod mod)
        {
            var nsp = mod.Namespace;
            foreach (EntityCounterMeta meta in res.GetModEntityCounterMetas(nsp))
            {
                if (meta == null)
                    continue;
                var name = meta.ID;
                var def = new EntityCounterDefinition(nsp, name, meta.Name);
                mod.AddDefinition(def);
            }
        }
        private void LoadEntityShapes(Mod mod)
        {
            var nsp = mod.Namespace;
            foreach (ShapeMeta meta in res.GetModShapeMetas(nsp))
            {
                if (meta == null)
                    continue;
                var name = meta.ID;
                var def = new ShapeDefinition(nsp, name);
                def.Armors = meta.Armors;
                mod.AddDefinition(def);
            }
        }
        private void LoadArmorMetas(Mod mod)
        {
            var nsp = mod.Namespace;
            foreach (var meta in res.GetModArmorMetas(nsp))
            {
                if (meta == null)
                    continue;
                var name = meta.ID;
                var def = new MetaArmorDefinition(nsp, name, meta.ColliderConstructors);
                def.SetArmorType(meta.Type);

                // 加载护甲的属性。
                foreach (var pair in meta.Properties)
                {
                    def.SetPropertyObject(PropertyMapper.ConvertFromName(pair.Key), pair.Value);
                }
                foreach (var behaviourID in meta.Behaviours)
                {
                    def.AddBehaviourID(behaviourID);
                }
                mod.AddDefinition(def);
            }
        }
        private void LoadArmorSlotMetas(Mod mod)
        {
            var nsp = mod.Namespace;
            foreach (var meta in res.GetModArmorSlotMetas(nsp))
            {
                if (meta == null)
                    continue;
                var name = meta.Name;
                var def = new ArmorSlotDefinition(nsp, name, meta.Anchor);
                mod.AddDefinition(def);
            }
        }
        private void LoadSpawnMetas(Mod mod)
        {
            var nsp = mod.Namespace;
            foreach (SpawnMeta meta in res.GetModSpawnMetas(nsp))
            {
                if (meta == null)
                    continue;
                var name = meta.ID;
                var type = meta.Type;
                var spawnLevel = meta.SpawnLevel;
                var terrain = meta.Terrain;
                var weight = meta.Weight;
                var excludedTags = terrain?.ExcludedAreaTags ?? Array.Empty<NamespaceID>();
                var water = meta.Terrain?.Water ?? false;
                var air = meta.Terrain?.Air ?? false;
                var noEndless = meta.NoEndless;
                var previewEntity = meta.PreviewEntity;
                var previewVariant = meta.PreviewVariant;
                var entityID = meta.Entity;
                var entityVariant = meta.EntityVariant;
                var notInEndless = spawnLevel <= 0 || noEndless;

                VanillaSpawnDefinition? spawnDef = null;
                if (type == "entity")
                {
                    if (NamespaceID.IsValid(entityID))
                    {
                        spawnDef = new VanillaSpawnDefinition(nsp, name);
                        var preview = new SpawnPreviewBehaviour(previewEntity, previewVariant);
                        var inLevel = new SpawnInLevelBehaviour(spawnLevel, entityID, water, air);
                        var endless = new SpawnEndlessBehaviour(notInEndless, excludedTags);
                        spawnDef.SetBehaviours(inLevel, preview, endless);
                    }
                }
                else if (name == VanillaSpawnNames.undeadFlyingObject)
                {
                    spawnDef = new VanillaSpawnDefinition(nsp, name);
                    var preview = new SpawnPreviewBehaviour(previewEntity, previewVariant);
                    var inLevel = new UFOSpawnInLevelBehaviour(spawnLevel, entityVariant);
                    var endless = new SpawnEndlessBehaviour(notInEndless, excludedTags);
                    spawnDef.SetBehaviours(inLevel, preview, endless);
                }
                else if (name == VanillaSpawnNames.undeadFlyingObjectBlitz)
                {
                    spawnDef = new VanillaSpawnDefinition(nsp, name);
                    var preview = new SpawnPreviewBehaviour(previewEntity, previewVariant);
                    var inLevel = new UFOSpawnInLevelBehaviour(spawnLevel, entityVariant, 0, 1, 20);
                    var endless = new SpawnEndlessBehaviour(notInEndless, excludedTags);
                    spawnDef.SetBehaviours(inLevel, preview, endless);
                }
                if (spawnDef == null)
                {
                    Debug.LogWarning($"Could not create SpawnDefinition for spawn meta {nsp}:{name}");
                    continue;
                }
                spawnDef.SetProperty(VanillaSpawnProps.MIN_SPAWN_WAVE, meta.MinSpawnWave);
                spawnDef.SetProperty(VanillaSpawnProps.PREVIEW_COUNT, meta.PreviewCount);
                if (weight != null)
                {
                    spawnDef.SetProperty(VanillaSpawnProps.WEIGHT_BASE, weight.Base);
                    spawnDef.SetProperty(VanillaSpawnProps.WEIGHT_DECAY_START, weight.DecreaseStart);
                    spawnDef.SetProperty(VanillaSpawnProps.WEIGHT_DECAY_END, weight.DecreaseEnd);
                    spawnDef.SetProperty(VanillaSpawnProps.WEIGHT_DECAY, weight.DecreasePerFlag);
                }
                mod.AddDefinition(spawnDef);
            }
        }
        private void LoadStages(Mod mod)
        {
            var nsp = mod.Namespace;
            foreach (var meta in res.GetModStageMetas(nsp))
            {
                if (meta == null)
                    continue;
                StageDefinition? stageDef = null;
                switch (meta.Type)
                {
                    case StageTypes.TYPE_NORMAL:
                        {
                            stageDef = new ClassicStage(nsp, meta.ID);
                        }
                        break;
                    case StageTypes.TYPE_ENDLESS:
                        {
                            stageDef = new EndlessStage(nsp, meta.ID);
                        }
                        break;
                    default:
                        switch (meta.ID)
                        {
                            case VanillaStageNames.halloween6:
                                stageDef = new WhackAGhostStage(nsp, meta.ID);
                                break;
                            case VanillaStageNames.dream6:
                                stageDef = new BreakoutStage(nsp, meta.ID);
                                break;
                            case VanillaStageNames.castle6:
                                stageDef = new LittleZombieStage(nsp, meta.ID);
                                break;
                            case VanillaStageNames.castle7:
                                stageDef = new SeijaStage(nsp, meta.ID);
                                break;
                            case VanillaStageNames.ship6:
                                stageDef = new UFOBlitzStage(nsp, meta.ID);
                                break;

                            case VanillaStageNames.whackAGhost:
                                stageDef = new WhackAGhostStage(nsp, meta.ID);
                                break;
                            case VanillaStageNames.breakout:
                                stageDef = new BreakoutStage(nsp, meta.ID);
                                break;
                            case VanillaStageNames.bigTroubleAndLittleZombie:
                                stageDef = new LittleZombieStage(nsp, meta.ID);
                                break;
                        }
                        break;
                }
                if (stageDef != null)
                {
                    mod.AddDefinition(stageDef);
                }
            }
        }
        private void LoadGridLayerMetas(Mod mod)
        {
            var nsp = mod.Namespace;
            foreach (GridLayerMeta meta in res.GetModGridLayerMetas(nsp))
            {
                if (meta == null)
                    continue;
                var name = meta.ID;
                var def = new GridLayerDefinition(nsp, name, meta.AlmanacTag);
                mod.AddDefinition(def);
            }
        }
        private void LoadGridErrorMetas(Mod mod)
        {
            var nsp = mod.Namespace;
            foreach (GridErrorMeta meta in res.GetModGridErrorMetas(nsp))
            {
                if (meta == null)
                    continue;
                var name = meta.ID;
                var def = new ErrorMessageDefinition(nsp, name, LogicDefinitionTypes.GRID_ERROR, meta.Message);
                mod.AddDefinition(def);
            }
        }
        private void LoadDifficultyMetas(Mod mod)
        {
            var nsp = mod.Namespace;
            foreach (DifficultyMeta meta in res.GetModDifficultyMetas(nsp))
            {
                if (meta == null)
                    continue;
                var name = meta.ID;
                var def = new DifficultyDefinition(nsp, name);
                def.SetProperty(LogicDifficultyProps.NAME, meta.Name);
                def.SetProperty(LogicDifficultyProps.VALUE, meta.Value);
                def.SetProperty(LogicDifficultyProps.BUFF_ID, meta.BuffID);
                def.SetProperty(LogicDifficultyProps.I_ZOMBIE_BUFF_ID, meta.IZombieBuffID);
                def.SetProperty(LogicDifficultyProps.CLEAR_MONEY, meta.ClearMoney);
                def.SetProperty(LogicDifficultyProps.RERUN_CLEAR_MONEY, meta.RerunClearMoney);
                def.SetProperty(LogicDifficultyProps.CART_CONVERT_MONEY, meta.CartConvertMoney);
                def.SetProperty(LogicDifficultyProps.PUZZLE_MONEY, meta.PuzzleMoney);
                def.SetProperty(LogicDifficultyProps.MAP_BUTTON_BORDER_BACK, meta.MapButtonBorderBack);
                def.SetProperty(LogicDifficultyProps.MAP_BUTTON_BORDER_BOTTOM, meta.MapButtonBorderBottom);
                def.SetProperty(LogicDifficultyProps.MAP_BUTTON_BORDER_OVERLAY, meta.MapButtonBorderOverlay);
                def.SetProperty(LogicDifficultyProps.ARCADE_ICON, meta.ArcadeIcon);
                mod.AddDefinition(def);
            }
        }
        private void LoadBlueprintErrorMetas(Mod mod)
        {
            var nsp = mod.Namespace;
            foreach (BlueprintErrorMeta meta in res.GetModBlueprintErrorMetas(nsp))
            {
                if (meta == null)
                    continue;
                var name = meta.ID;
                var def = new ErrorMessageDefinition(nsp, name, LogicDefinitionTypes.SEED_ERROR, meta.Message);
                mod.AddDefinition(def);
            }
        }
        private void LoadCustomEntityBlueprints(Mod mod)
        {
            var nsp = mod.Namespace;
            foreach (var meta in res.GetModEntityBlueprintMetas(nsp))
            {
                if (meta == null)
                    continue;
                var entityID = meta.EntityID;
                if (!NamespaceID.IsValid(entityID))
                    continue;

                var def = new EntitySeedDefinition(nsp, meta.ID, meta.Name, meta.Tooltip);
                mod.AddDefinition(def);

                // 将实体作为蓝图添加到游戏中。
                var info = new EntitySeedInfo()
                {
                    entityID = entityID,
                    cost = meta.Cost,
                    rechargeID = meta.RechargeID,
                    triggerActive = meta.IsTriggerActive(),
                    canInstantTrigger = meta.CanInstantTrigger(),
                    upgrade = meta.IsUpgradeBlueprint(),
                    canInstantEvoke = meta.CanInstantEvoke(),
                    variant = meta.Variant,
                    icon = meta.GetIcon(),
                    mobileIcon = meta.GetMobileIcon(),
                    model = meta.GetModelID()
                };
                var seedDef = new EntitySeed(nsp, meta.ID, info);
                mod.AddDefinition(seedDef);
            }
        }
        private void LoadBuffMetas(Mod mod)
        {
            var nsp = mod.Namespace;
            foreach (var buffDefinition in mod.GetAllBuffDefinitions())
            {
                var id = buffDefinition.GetID();
                var meta = res.GetBuffMeta(id);
                if (meta == null)
                {
                    Debug.LogWarning($"Could not find the buff meta for buff definition {id}!");
                    continue;
                }
                var polarity = meta.Polarity;
                var level = meta.Level;

                buffDefinition.SetProperty<int>(EngineBuffProps.POLARITY, polarity);
                buffDefinition.SetProperty<int>(EngineBuffProps.BUFF_LEVEL, level);
            }
        }
        #endregion

        #region 加载Definition属性
        public void LoadDefinitionProperties(Mod mod)
        {
            // 以下会通过LoadDefinitionsFromAssemblies自动创建，因此只需要读取额外信息。
            // 加载所有地形信息。
            LoadAreaProperties(mod);
            // 加载所有制品信息。
            LoadArtifactProperties(mod);
            // 加载选项蓝图信息。
            LoadSeedOptionProperties(mod);

            LoadStageProperties(mod);
            // 加载所有命令属性。
            LoadCommandProperties(mod);
            // 加载所有笔记属性。
            LoadNoteProperties(mod);
        }
        private void LoadAreaProperties(Mod mod)
        {
            var nsp = mod.Namespace;
            foreach (var meta in res.GetModAreaMetas(nsp))
            {
                if (meta == null)
                    continue;
                var area = mod.GetAreaDefinition(new NamespaceID(nsp, meta.ID));
                if (area == null)
                    continue;
                area.SetProperty(VanillaAreaProps.MODEL_ID, meta.ModelID);
                area.SetProperty(VanillaLevelProps.MUSIC_ID, meta.MusicID);
                area.SetProperty(EngineAreaProps.CART_REFERENCE, meta.Cart);
                area.SetProperty(EngineAreaProps.AREA_TAGS, meta.Tags);
                area.SetProperty(VanillaAreaProps.STARSHARD_ICON, meta.StarshardIcon);

                area.SetProperty(EngineAreaProps.ENEMY_SPAWN_X, meta.EnemySpawnX);
                area.SetProperty(VanillaAreaProps.DOOR_Z, meta.DoorZ);

                area.SetProperty(VanillaAreaProps.BACKGROUND_LIGHT, meta.BackgroundLight);
                area.SetProperty(VanillaAreaProps.GLOBAL_LIGHT, meta.GlobalLight);

                area.SetProperty(EngineAreaProps.GRID_WIDTH, meta.GridWidth);
                area.SetProperty(EngineAreaProps.GRID_HEIGHT, meta.GridHeight);
                area.SetProperty(EngineAreaProps.GRID_LEFT_X, meta.GridLeftX);
                area.SetProperty(EngineAreaProps.GRID_BOTTOM_Z, meta.GridBottomZ);
                area.SetProperty(EngineAreaProps.ENTITY_LANE_Z_OFFSET, meta.EntityLaneZOffset);
                area.SetProperty(EngineAreaProps.MAX_LANE_COUNT, meta.Lanes);
                area.SetProperty(EngineAreaProps.MAX_COLUMN_COUNT, meta.Columns);

                area.SetGridLayout(meta.Grids.Select(m => m.ID).ToArray());
            }
        }
        private void LoadSeedOptionProperties(Mod mod)
        {
            var nsp = mod.Namespace;
            foreach (var meta in res.GetModBlueprintOptionMetas(nsp))
            {
                if (meta == null)
                    continue;
                var seedOptionDefinition = mod.GetSeedOptionDefinition(new NamespaceID(nsp, meta.ID));
                if (seedOptionDefinition == null)
                    continue;
                seedOptionDefinition.SetProperty(LogicSeedOptionProps.COST, meta.Cost);
                seedOptionDefinition.SetProperty(LogicSeedOptionProps.NAME, meta.Name);
                seedOptionDefinition.SetProperty(LogicSeedOptionProps.ICON, meta.GetIcon());
                seedOptionDefinition.SetProperty(LogicSeedOptionProps.MOBILE_ICON, meta.GetMobileIcon());
                seedOptionDefinition.SetProperty(LogicSeedOptionProps.MODEL_ID, meta.GetModelID());

                var seedDef = new OptionSeed(nsp, seedOptionDefinition.Name, seedOptionDefinition.GetCost());
                seedDef.SetIcon(seedOptionDefinition.GetIcon());
                seedDef.SetMobileIcon(seedOptionDefinition.GetMobileIcon());
                seedDef.SetModelID(seedOptionDefinition.GetModelID());
                mod.AddDefinition(seedDef);
            }
        }
        private void LoadArtifactProperties(Mod mod)
        {
            var nsp = mod.Namespace;
            foreach (var meta in res.GetModArtifactMetas(nsp))
            {
                if (meta == null)
                    continue;
                var name = meta.ID;
                var artifact = mod.GetArtifactDefinition(new NamespaceID(nsp, name));
                if (artifact == null)
                    continue;
                artifact.SetArtifactName(meta.Name);
                artifact.SetArtifactTooltip(meta.Tooltip);
                artifact.SetUnlockConditions(meta.UnlockConditions);
                artifact.SetSpriteReference(meta.Sprite);
            }
        }
        private void LoadStageProperties(Mod mod)
        {
            var nsp = mod.Namespace;
            foreach (var meta in res.GetModStageMetas(nsp))
            {
                if (meta == null)
                    continue;
                var name = meta.ID;
                var stageDef = mod.GetStageDefinition(new NamespaceID(nsp, name));
                if (stageDef == null)
                    continue;
                stageDef.SetLevelName(meta.Name);
                stageDef.SetDayNumber(meta.DayNumber);
                stageDef.SetStartEnergy(meta.StartEnergy);

                stageDef.SetProperty(VanillaLevelProps.MUSIC_ID, meta.MusicID);
                stageDef.SetProperty(LogicStageProps.STAGE_TYPE, meta.Type);
                stageDef.SetProperty<IConditionList>(LogicStageProps.UNLOCK_CONDITIONS, meta.UnlockConditions);
                stageDef.SetProperty(LogicStageProps.MODEL_PRESET, meta.ModelPreset);

                stageDef.SetProperty(VanillaStageProps.NO_START_TALK_MUSIC, meta.NoStartTalkMusic);

                stageDef.SetProperty(VanillaStageProps.CLEAR_PICKUP_MODEL, meta.ClearPickupModel);
                stageDef.SetProperty(VanillaStageProps.CLEAR_PICKUP_CONTENT_ID, meta.ClearPickupContentID);
                stageDef.SetProperty(VanillaStageProps.DROPS_TROPHY, meta.DropsTrophy);
                stageDef.SetProperty(VanillaStageProps.END_NOTE_ID, meta.EndNote);

                stageDef.SetProperty(VanillaStageProps.START_CAMERA_POSITION, (int)meta.StartCameraPosition);
                stageDef.SetProperty(VanillaStageProps.START_TRANSITION, meta.StartTransition);

                stageDef.SetProperty(EngineStageProps.TOTAL_FLAGS, meta.TotalFlags);
                stageDef.SetProperty(EngineStageProps.FIRST_WAVE_TIME, meta.FirstWaveTime);
                stageDef.SetProperty(EngineStageProps.CONTINUED_FIRST_WAVE_TIME, meta.EndlessFirstWaveTime);
                stageDef.SetProperty(VanillaStageProps.WAVE_MAX_TIME, meta.MaxWaveTime);
                stageDef.SetProperty(VanillaStageProps.WAVE_ADVANCE_TIME, meta.AdvanceWaveTime);
                stageDef.SetProperty(VanillaStageProps.WAVE_ADVANCE_HEALTH_PERCENT, meta.AdvanceHealthPercent);

                stageDef.SetProperty(VanillaLevelProps.ENEMY_POOL, meta.Spawns);
                stageDef.SetProperty<IStageTalkMeta[]>(LogicStageProps.TALKS, meta.Talks);
                stageDef.SetProperty<IConveyorPoolEntry[]>(LogicStageProps.CONVEYOR_POOL, meta.ConveyorPool);

                stageDef.SetNeedBlueprints(meta.NeedBlueprints);
                stageDef.SetSpawnPointPower(meta.SpawnPointsPower);
                stageDef.SetSpawnPointMultiplier(meta.SpawnPointsMultiplier);
                stageDef.SetSpawnPointAddition(meta.SpawnPointsAddition);

                foreach (var pair in meta.Properties)
                {
                    stageDef.SetPropertyObject(PropertyMapper.ConvertFromName(pair.Key), pair.Value);
                }
            }
        }
        private void LoadCommandProperties(Mod mod)
        {
            var nsp = mod.Namespace;
            foreach (CommandMeta meta in res.GetModCommandMetas(nsp))
            {
                if (meta == null)
                    continue;
                var name = meta.ID;
                var def = mod.GetCommandDefinition(new NamespaceID(nsp, name));
                if (def == null)
                    continue;
                def.SetProperty(LogicCommandProps.DESCRIPTION, meta.Description);
                def.SetProperty(LogicCommandProps.MUST_IN_LEVEL, meta.InLevel);
                def.SetProperty<ICommandVariantMeta[]>(LogicCommandProps.VARIANTS, meta.Variants);
                mod.AddDefinition(def);
            }
        }
        private void LoadNoteProperties(Mod mod)
        {
            var nsp = mod.Namespace;
            foreach (NoteDefinition def in mod.GetAllNoteDefinitions())
            {
                if (def == null)
                    continue;
                var id = def.GetID();
                var meta = res.GetNoteMeta(id);
                if (meta == null)
                    continue;
                def.SetProperty(LogicNoteProps.CAN_FLIP, meta.canFlip);
                def.SetProperty(LogicNoteProps.NOTE_BACKGROUND, meta.background);
                def.SetProperty(LogicNoteProps.NOTE_SPRITE, meta.sprite);
                def.SetProperty(LogicNoteProps.FLIP_NOTE_SPRITE, meta.flipSprite);
                def.SetProperty(LogicNoteProps.START_TALK, meta.startTalk);
                mod.AddDefinition(def);
            }
        }
        #endregion

        private ResourceManager res => main.ResourceManager;
        private MainManager main;
    }
}
