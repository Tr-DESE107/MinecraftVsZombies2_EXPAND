#nullable enable // autogenerated

using MVZ2.Managers;
using MVZ2.Map;
using MVZ2.Scenes;
using MVZ2.Talk;
using MVZ2.Talks;
using MVZ2.Vanilla.Audios;
using MVZ2.Vanilla.Callbacks;
using MVZ2Logic;
using MVZ2Logic.Entities;
using MVZ2Logic.Games;
using MVZ2Logic.Notes;
using MVZ2Logic.Talk;
using PVZEngine;
using UnityEngine;

namespace MVZ2.Note
{
    public class NoteController : MainScenePage, INote
    {
        public async void SetNote(NamespaceID id)
        {
            var def = main.Game.GetNoteDefinition(id);
            if (def == null)
                return;
            definition = def;
            isFlipped = false;
            ui.SetNoteSprite(main.GetFinalSprite(def.GetNoteSprite()));
            ui.SetBackground(main.GetFinalSprite(def.GetNoteBackground()));
            ui.SetCanFlip(def.CanFlip());
            ui.SetFlipAtLeft(isFlipped);
            var startTalk = def.GetStartTalk() ?? new NamespaceID(id.SpaceName, $"{id.Path}_note");
            await talkController.SimpleStartTalkAsync(startTalk, 0, 3, () => SetInteractable(false));
            SetInteractable(true);
        }
        public void SetButtonText(string text)
        {
            ui.SetButtonText(text);
        }
        public void SetInteractable(bool interactable)
        {
            ui.SetButtonInteractable(interactable);
        }
        #region 生命周期
        private void Awake()
        {
            ui.OnNoteFlipClick += OnNoteFlipClickCallback;
            ui.OnButtonClick += OnButtonClickCallback;
            talkController.OnTalkAction += OnTalkActionCallback;
            talkSystem = new NoteTalkSystem(talkController);
        }
        #endregion

        #region 事件回调
        private void OnNoteFlipClickCallback()
        {
            isFlipped = !isFlipped;
            main.SoundManager.Play2D(VanillaSoundID.paper);
            var sprRef = isFlipped ? definition.GetFlipNoteSprite() : definition.GetNoteSprite();
            ui.SetNoteSprite(main.GetFinalSprite(sprRef));
            ui.SetFlipAtLeft(isFlipped);
        }
        private void OnButtonClickCallback()
        {
            definition?.OnBack(this);
        }
        private void OnTalkActionCallback(string cmd, string[] parameters)
        {
            Global.Game.RunCallbackFiltered(VanillaCallbacks.TALK_ACTION, new VanillaCallbacks.TalkActionParams(talkSystem, cmd, parameters), cmd);
        }
        #endregion

        #region 属性字段
        private MainManager main => MainManager.Instance;
        private NoteDefinition definition = null!;
        private ITalkSystem talkSystem = null!;
        private bool isFlipped;
        [SerializeField]
        private TalkController talkController = null!;
        [SerializeField]
        private NoteUI ui = null!;
        #endregion
    }
}
