#nullable enable // autogenerated

using UnityEngine;

namespace MVZ2.Models
{
    public class ElectricArcModel : ModelComponent
    {
        public override void LoadFromSerializable(SerializableModelData serializable)
        {
            base.LoadFromSerializable(serializable);
            UpdateLine();
        }
        public override void UpdateLogic()
        {
            base.UpdateLogic();
            UpdateLevitation();
            UpdateLine();
        }
        public override void UpdateFrame(float deltaTime)
        {
            base.UpdateFrame(deltaTime);
            UpdateDirection();
        }
        public override void OnTrigger(string name)
        {
            base.OnTrigger(name);
            if (name == "Update")
            {
                UpdateLinePoints();
                UpdateDirection();
                UpdateLine();
            }
        }
        private void UpdateLevitation()
        {
            Vector3[][]? points = Model.GetProperty<Vector3[][]>("points");

            if (points == null)
                return;
            var rng = Model.GetRNG();

            for (int p = 0; p < points.Length; p++)
            {
                var linePoints = points[p];
                if (linePoints == null)
                    continue;
                var lightning = lightnings[p];
                int count = linePoints.Length;
                var parent = lightning.transform.parent;
                for (int i = 1; i < count - 1; i++)
                {
                    float percent = (float)i / count;
                    float modifier = -4 * Mathf.Pow(percent - 0.5f, 2) + 1;

                    Vector3 localPosition = linePoints[i];
                    var worldPosition = parent.TransformPoint(localPosition);
                    worldPosition.x += rng.Next(-arcShiver, arcShiver) * modifier;
                    worldPosition.y += (rng.Next(-arcShiver, arcShiver) + arcLevitation) * modifier;
                    worldPosition.z += rng.Next(-arcShiver, arcShiver) * modifier;
                    localPosition = parent.InverseTransformPoint(worldPosition);
                    linePoints[i] = localPosition;
                }
            }
        }
        private void UpdateDirection()
        {
            var source = sourceTransform.position;
            var dest = Lawn2TransPosition(Model.GetProperty<Vector3>("Dest"));
            var distance = dest - source;
            sourceTransform.rotation = Quaternion.FromToRotation(Vector3.right, distance);
            sourceTransform.localScale = new Vector3(distance.magnitude, 1, 1);
        }
        private void UpdateLine()
        {
            Vector3[][]? points = Model.GetProperty<Vector3[][]>("points");

            if (points == null)
                return;
            for (int i = 0; i < points.Length; i++)
            {
                var lightning = lightnings[i];
                var renderer = lightning.LineRenderer;
                var linePoints = points[i];
                if (linePoints == null)
                    continue;
                lightning.LineRenderer.positionCount = linePoints.Length;
                renderer.SetPositions(linePoints);
            }
        }
        private void UpdateLinePoints()
        {
            var pointCount = Model.GetProperty<int>("PointCount");
            Vector3[][]? points = Model.GetProperty<Vector3[][]>("points");
            if (points == null)
            {
                points = new Vector3[lightnings.Length][];
                Model.SetProperty("points", points);
            }
            for (int i = 0; i < points.Length; i++)
            {
                var lightning = lightnings[i];
                var generated = LightningGenerator.GenerateLightning(pointCount, sourceTransform.localPosition, destTransform.localPosition, lightning.amplitude, Model.GetRNG());
                if (generated != null)
                {
                    points[i] = generated;
                }
            }
        }
        [SerializeField]
        private LightningGenerator[] lightnings = null!;
        [SerializeField]
        private Transform sourceTransform = null!;
        [SerializeField]
        private Transform destTransform = null!;
        [SerializeField]
        private float arcShiver = 0.03f;
        [SerializeField]
        private float arcLevitation = 0.01f;
    }
}
