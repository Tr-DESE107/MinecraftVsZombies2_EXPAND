#nullable enable // autogenerated

using System.Xml;
using MVZ2.IO;
using MVZ2.Saves;
using MVZ2Logic.Games;
using MVZ2Logic.Level;
using PVZEngine;

namespace MVZ2.Metas
{
    public class StageMetaTalk : IStageTalkMeta
    {
        public string Type { get; private set; } = string.Empty;
        public NamespaceID Value { get; private set; }
        public int StartSection { get; private set; }
        public XMLConditionList? StartCondition { get; private set; }
        public XMLConditionList? RepeatCondition { get; private set; }
        private StageMetaTalk(NamespaceID value)
        {
            Value = value;
        }
        public static StageMetaTalk? FromXmlNode(XmlNode node, string defaultNsp)
        {
            var value = node.GetAttributeNamespaceID("value", defaultNsp);
            if (!NamespaceID.IsValid(value))
            {
                Log.LogError($"The {nameof(value)} of a {nameof(StageMetaTalk)} is invalid.");
                return null;
            }
            var type = node.GetAttribute("type") ?? string.Empty;
            var startSection = node.GetAttributeInt("section") ?? 0;

            XMLConditionList? startCondition = null;
            var conditionNode = node["conditions"];
            if (conditionNode != null)
            {
                startCondition = XMLConditionList.FromXmlNode(conditionNode, defaultNsp);
            }

            XMLConditionList? repeatCondition = null;
            var repeatConditionNode = node["repeat"];
            if (repeatConditionNode != null)
            {
                repeatCondition = XMLConditionList.FromXmlNode(repeatConditionNode, defaultNsp);
            }
            return new StageMetaTalk(value)
            {
                Type = type,
                StartSection = startSection,
                StartCondition = startCondition,
                RepeatCondition = repeatCondition
            };
        }
        public bool CanStartTalk(IGlobalSaveData save)
        {
            if (StartCondition == null)
                return true;
            return save.MeetsXMLConditions(StartCondition);
        }
        public bool ShouldRepeat(IGlobalSaveData save)
        {
            if (RepeatCondition == null)
                return false;
            return save.MeetsXMLConditions(RepeatCondition);
        }
        public const string TYPE_START = "start";
        public const string TYPE_END = "end";
        public const string TYPE_MAP = "map";

    }
}
