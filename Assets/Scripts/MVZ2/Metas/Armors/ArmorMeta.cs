#nullable enable // autogenerated

using System.Collections.Generic;
using System.Xml;
using MVZ2.IO;
using PVZEngine;
using PVZEngine.Level.Collisions;

namespace MVZ2.Metas
{
    public class ArmorMeta
    {
        public ArmorMeta(string id, NamespaceID[] behaviours, ColliderConstructor[] colliderConstructors, Dictionary<string, object?> properties)
        {
            ID = id;
            Behaviours = behaviours;
            ColliderConstructors = colliderConstructors;
            Properties = properties;
        }

        public string ID { get; private set; }
        public bool Ignored { get; private set; }
        public NamespaceID? Type { get; private set; }
        public NamespaceID[] Behaviours { get; private set; }
        public ColliderConstructor[] ColliderConstructors { get; private set; }
        public Dictionary<string, object?> Properties { get; private set; }
        public static ArmorMeta? FromXmlNode(XmlNode node, string defaultNsp)
        {
            var id = node.GetAttribute("id");

            if (string.IsNullOrEmpty(id))
            {
                Log.LogError("The ID of an ArmorMeta is invalid.");
                return null;
            }

            bool ignored = node.GetAttributeBool("ignored") ?? false;
            var type = node.GetAttributeNamespaceID("type", defaultNsp);

            var behavioursNode = node["behaviours"];
            List<NamespaceID> behaviours = new List<NamespaceID>();
            if (behavioursNode != null)
            {
                for (int i = 0; i < behavioursNode.ChildNodes.Count; i++)
                {
                    var behaviourNode = behavioursNode.ChildNodes[i];
                    var behaviour = behaviourNode.GetAttributeNamespaceID("id", defaultNsp);
                    if (behaviour != null)
                    {
                        behaviours.Add(behaviour);
                    }
                }
            }

            var collidersNode = node["colliders"];
            List<ColliderConstructor> colliders = new List<ColliderConstructor>();
            if (collidersNode != null)
            {
                for (int i = 0; i < collidersNode.ChildNodes.Count; i++)
                {
                    var colliderNode = collidersNode.ChildNodes[i];
                    var collider = MetaXMLParser.LoadColliderConstructor(colliderNode);
                    colliders.Add(collider);
                }
            }

            var propsNode = node["props"];
            Dictionary<string, object?> props = propsNode.ToPropertyDictionary(defaultNsp);
            Dictionary<string, object?> properties = new Dictionary<string, object?>();
            foreach (var prop in props)
            {
                var fullName = PropertyKeyHelper.ParsePropertyFullName(prop.Key, defaultNsp, PropertyRegions.armor);
                properties.Add(fullName, prop.Value);
            }

            return new ArmorMeta(id, behaviours.ToArray(), colliders.ToArray(), properties)
            {
                Type = type,
                Ignored = ignored,
            };
        }
    }
}
