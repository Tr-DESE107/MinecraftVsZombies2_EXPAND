#nullable enable // autogenerated

using System;
using System.Collections.Generic;
using System.Linq;
using MVZ2.GameContent.Seeds;
using MVZ2.Managers;
using MVZ2.Metas;
using MVZ2.Saves;
using MVZ2.UI;
using MVZ2.Vanilla;
using MVZ2.Vanilla.Almanacs;
using MVZ2Logic;
using MVZ2Logic.Artifacts;
using MVZ2Logic.Games;
using PVZEngine;
using UnityEngine;

namespace MVZ2.Almanacs
{
    public class AlmanacManager : MonoBehaviour
    {
        #region 获取图鉴项列表
        public void GetOrderedContraptionsByAlmanac(IEnumerable<NamespaceID> contraptionsID, List<NamespaceID?> appendList)
        {
            var idList = GetUnlockedAlmanacEntries(VanillaAlmanacCategories.CONTRAPTIONS, (id, entry) => contraptionsID.Contains(id) && !entry.hidden);
            var ordered = CompressLayout(idList, GetBlueprintCountPerRow());
            appendList.AddRange(ordered);
        }
        public void GetContraptionPageEntries(List<NamespaceID?> appendList)
        {
            var idList = GetUnlockedAlmanacEntries(VanillaAlmanacCategories.CONTRAPTIONS, (id, entry) => Main.SaveManager.IsContraptionUnlocked(id) && !entry.hidden);
            var ordered = CompressLayout(idList, GetBlueprintCountPerRow());
            appendList.AddRange(ordered);
        }
        public void GetEnemyPageEntries(List<NamespaceID?> appendList)
        {
            var idList = GetUnlockedAlmanacEntries(VanillaAlmanacCategories.ENEMIES, (id, entry) => Main.SaveManager.IsEnemyUnlocked(id) && !entry.hidden);
            var ordered = CompressLayout(idList, GetEnemyCountPerRow());
            appendList.AddRange(ordered);
        }
        public void GetOrderedArtifactsByAlmanac(IEnumerable<NamespaceID> artifactsID, List<NamespaceID?> appendList)
        {
            var idList = GetUnlockedAlmanacEntries(VanillaAlmanacCategories.ARTIFACTS, (id, entry) => artifactsID.Contains(id) && !entry.hidden);
            var ordered = CompressLayout(idList, GetMiscCountPerRow());
            appendList.AddRange(ordered);
        }
        public void GetArtifactPageEntries(List<NamespaceID?> appendList)
        {
            var idList = GetUnlockedAlmanacEntries(VanillaAlmanacCategories.ARTIFACTS, ShouldArtifactShowInAlmanac);
            var ordered = CompressLayout(idList, GetMiscCountPerRow());
            appendList.AddRange(ordered);
        }
        public void GetMiscPageGroups(List<AlmanacEntryGroup> appendList)
        {
            var groups = Main.ResourceManager.GetAlmanacMetaGroups(VanillaAlmanacCategories.MISC);
            foreach (var group in groups)
            {
                var entries = group.entries;
                var groupEntries = new NamespaceID?[entries.Length];
                for (int i = 0; i < groupEntries.Length; i++)
                {
                    var entry = entries[i];
                    var id = entry.id;
                    if (!NamespaceID.IsValid(id))
                        continue;
                    if (!entry.unlock.IsNullOrMeetsConditions(Main.SaveManager))
                        continue;
                    groupEntries[i] = id;
                }
                var compressedEntries = CompressLayout(groupEntries, miscCountPerRow).ToArray();
                var g = new AlmanacEntryGroup(group.name, compressedEntries);
                if (g.entries.Any(e => NamespaceID.IsValid(e)))
                {
                    appendList.Add(g);
                }
            }
        }
        private bool ShouldArtifactShowInAlmanac(NamespaceID id, AlmanacMetaEntry entry)
        {
            if (entry.hidden)
                return false;
            if (Main.SaveManager.IsArtifactUnlocked(id))
                return true;
            if (entry.silhouetteUnlock != null && entry.silhouetteUnlock.MeetsConditions(Main.SaveManager))
                return true;
            return false;
        }
        private NamespaceID?[] GetUnlockedAlmanacEntries(string category, Func<NamespaceID, AlmanacMetaEntry, bool> predicate)
        {
            var entries = Main.ResourceManager.GetAlmanacMetaEntries(category);
            NamespaceID?[] results = new NamespaceID?[entries.Length];
            for (int i = 0; i < results.Length; i++)
            {
                var entry = entries[i];
                var id = entry.id;
                if (entry == null || !NamespaceID.IsValid(id))
                    continue;
                if (predicate(id, entry))
                {
                    results[i] = id;
                }
            }
            return results;
        }
        #endregion

        #region 压缩布局
        private IEnumerable<NamespaceID?> CompressLayout(IEnumerable<NamespaceID?> idList, int countPerRow)
        {
            var groups = idList
                .Select((v, i) => (v, i))
                .GroupBy(p => p.i / countPerRow);
            return groups
                .Where(g => !g.All(p => !NamespaceID.IsValid(p.v)))
                .SelectMany(g => g.Select(p => p.v))
                .ToArray();
        }
        public int GetBlueprintCountPerRow()
        {
            return Main.IsMobile() ? blueprintCountPerRowMobile : blueprintCountPerRowStandalone;
        }
        public int GetEnemyCountPerRow()
        {
            return enemyCountPerRow;
        }
        public int GetMiscCountPerRow()
        {
            return miscCountPerRow;
        }
        #endregion

        #region 获取图鉴项显示信息
        public ChoosingBlueprintViewData GetChoosingBlueprintViewData(NamespaceID? id, bool isEndless, bool isCommandBlock = false)
        {
            if (!NamespaceID.IsValid(id))
                return ChoosingBlueprintViewData.Empty;
            var blueprintDef = Main.Game.GetSeedDefinition(id);
            if (blueprintDef == null)
                return ChoosingBlueprintViewData.Empty;
            return new ChoosingBlueprintViewData()
            {
                blueprint = Main.ResourceManager.GetBlueprintViewData(blueprintDef, isEndless, isCommandBlock),
                disabled = false
            };
        }
        public AlmanacEntryViewData GetEnemyEntryViewData(NamespaceID? id)
        {
            if (!NamespaceID.IsValid(id))
                return AlmanacEntryViewData.Empty;
            var def = Main.Game.GetEntityDefinition(id);
            if (def == null)
                return AlmanacEntryViewData.Empty;

            var entry = Main.ResourceManager.GetAlmanacMetaEntry(VanillaAlmanacCategories.ENEMIES, id);
            Sprite? icon = null;
            Color color = Color.white;
            Vector2 offset = Vector2.zero;
            if (entry != null)
            {
                icon = GetEntryThumbnailSprite(entry);
            }
            if (!icon)
            {
                var blueprintID = VanillaBlueprintID.FromEntity(id);
                var blueprintDef = Main.Game.GetSeedDefinition(blueprintID);
                if (blueprintDef != null)
                {
                    icon = Main.ResourceManager.GetBlueprintIconMobile(blueprintDef);
                }
                offset = new Vector2(20, 0);
            }
            return new AlmanacEntryViewData() { sprite = icon, color = color, offset = offset };
        }
        public AlmanacEntryViewData GetArtifactEntryViewData(NamespaceID? id)
        {
            if (!NamespaceID.IsValid(id))
                return AlmanacEntryViewData.Empty;
            var def = Main.Game.GetArtifactDefinition(id);
            if (def == null)
                return AlmanacEntryViewData.Empty;

            var entry = Main.ResourceManager.GetAlmanacMetaEntry(VanillaAlmanacCategories.ARTIFACTS, id);
            Sprite? icon = GetArtifactThumbnail(entry, def);
            Color color = Main.SaveManager.IsArtifactUnlocked(id) ? Color.white : Color.black;
            return new AlmanacEntryViewData() { sprite = icon, color = color };
        }
        public AlmanacEntryViewData GetMiscEntryViewData(NamespaceID? id)
        {
            if (!NamespaceID.IsValid(id))
                return AlmanacEntryViewData.Empty;

            var entry = Main.ResourceManager.GetAlmanacMetaEntry(VanillaAlmanacCategories.MISC, id);
            if (entry == null)
                return AlmanacEntryViewData.Empty;

            return new AlmanacEntryViewData() { sprite = GetEntryThumbnailSprite(entry), color = Color.white };
        }
        public AlmanacEntryGroupViewData GetMiscGroupViewData(AlmanacEntryGroup group)
        {
            return new AlmanacEntryGroupViewData()
            {
                name = Main.LanguageManager._p(VanillaStrings.CONTEXT_ALMANAC_GROUP_NAME, group.name),
                entries = group.entries.Select(GetMiscEntryViewData).ToArray()
            };
        }
        #endregion

        #region 缩略图
        public Sprite? GetEntryThumbnailSprite(AlmanacMetaEntry entry)
        {
            Sprite? sprite = null;
            if (entry.thumbnail != null)
                sprite = GetPictureThumbnailSprite(entry.thumbnail);
            if (sprite)
                return sprite;

            if (entry.picture != null)
                sprite = GetPictureThumbnailSprite(entry.picture);
            return sprite;
        }
        public Sprite? GetPictureThumbnailSprite(AlmanacPicture picture)
        {
            if (picture == null)
                return null;
            Sprite? sprite = null;

            if (picture.model != null)
                sprite = Main.ResourceManager.GetModelIcon(picture.model);
            if (sprite)
                return sprite;

            sprite = GetPictureSprite(picture);
            return sprite;
        }
        #endregion

        #region 图片
        public Sprite? GetArtifactThumbnail(AlmanacMetaEntry? entry, ArtifactDefinition def)
        {
            Sprite? icon = null;
            if (entry != null)
            {
                icon = GetEntryThumbnailSprite(entry);
            }
            if (icon)
                return icon;

            var spriteRef = def.GetSpriteReference();
            if (SpriteReference.IsValid(spriteRef))
            {
                icon = Main.GetFinalSprite(spriteRef);
            }
            return icon;
        }
        public Sprite? GetEntryPictureSprite(AlmanacMetaEntry entry)
        {
            return GetPictureSprite(entry.picture);
        }
        public Sprite? GetPictureSprite(AlmanacPicture? picture)
        {
            if (picture == null)
                return null;
            Sprite? sprite = null;
            if (picture.sprite != null)
                sprite = Main.GetFinalSprite(picture.sprite);

            if (sprite)
                return sprite;

            if (picture.character != null)
                sprite = Main.ResourceManager.GetCharacterSprite(picture.character);
            return sprite;
        }
        #endregion


        public MainManager Main => MainManager.Instance;
        [SerializeField]
        private int blueprintCountPerRowStandalone = 8;
        [SerializeField]
        private int blueprintCountPerRowMobile = 4;
        [SerializeField]
        private int enemyCountPerRow = 5;
        [SerializeField]
        private int miscCountPerRow = 5;
    }
    public class AlmanacEntryGroup
    {
        public AlmanacEntryGroup(string name, NamespaceID?[] entries)
        {
            this.name = name;
            this.entries = entries;
        }
        public string name;
        public NamespaceID?[] entries;
    }
}
